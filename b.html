<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IT Hub .es ‚Äî Ranking Gamificado (API Live)</title>
  <style>
    :root{
      --bg:#0f1320; --surface:#161b2d; --surface2:#1b2140; --ink:#e8ecff; --muted:#9ca8d9;
      --stroke:#283056; --brand:#6c8bff; --radius:14px; --shadow:0 12px 28px rgba(6,12,40,.45);
      --vio:#7b5cff; --vio2:#6246ff;
      --gold:#ffd662; --silver:#e6e6e6; --bronze:#e2a97a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Helvetica Neue","Noto Sans",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 420px at 90% -10%,rgba(255,153,0,.12),transparent 60%),
        radial-gradient(800px 400px at 10% 0%,rgba(0,120,212,.12),transparent 60%),
        var(--bg);
      line-height:1.6;
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1160px;margin:0 auto;padding:0 20px}
    header{position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);
      background:linear-gradient(180deg,rgba(15,19,32,.85),rgba(15,19,32,.55));
      border-bottom:1px solid var(--stroke)}
    .nav{height:56px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .brand .logo{width:22px;height:22px;border-radius:6px;background:linear-gradient(180deg,#7b8cff,#4c66ff);box-shadow:0 0 0 6px rgba(108,139,255,.18)}
    .menu{display:flex;gap:20px;color:var(--muted);font-weight:900}
    .menu a{text-transform:uppercase}
    .menu a:hover{color:#fff}
    .actions{display:flex;align-items:center;gap:10px}
    .gear{cursor:pointer;border:1px solid var(--stroke);border-radius:10px;padding:6px 10px;font-weight:900;opacity:.9}
    .wrap{padding:22px 0 28px}
    .layout{display:grid;grid-template-columns: 1fr 320px; gap:18px}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg,#111937,#0f1633);border:1px solid var(--stroke);
      border-radius:16px;padding:18px 18px;box-shadow:var(--shadow)}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:6px 0 12px}
    .header-row h2{margin:0;color:#fff;font-size:1.3rem;font-weight:900}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{appearance:none;border:1px solid var(--stroke);background:var(--surface2);color:#e8ecff;
      padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:800}
    .tab[aria-pressed="true"]{outline:2px solid rgba(108,139,255,.3)}
    .table-wrap{background:var(--surface);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);padding:14px;overflow:auto}
    table{width:100%;min-width:860px;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;z-index:1;background:var(--surface2);color:#e8ecff;font-weight:800;text-align:center;padding:12px 10px;border-bottom:1px solid var(--stroke)}
    tbody td{padding:12px 10px;text-align:center;border-bottom:1px solid #1f2747;background:#0f1430;color:#e8ecff}
    tbody tr:nth-child(even) td{background:#101738}
    tbody tr:hover td{background:#0e1536}
    thead th:first-child{border-top-left-radius:12px}
    thead th:last-child{border-top-right-radius:12px}
    .col-rank{width:64px}
    .col-name{text-align:left}
    .col-points{width:140px}
    .col-num{width:110px;font-variant-numeric:tabular-nums}
    .col-date{width:190px}
    .avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(180deg,#7b8cff,#4c66ff);display:inline-flex;align-items:center;justify-content:center;font-weight:900;color:#fff;margin-right:8px}
    .name-strong{font-weight:900}
    .name-gold{color:var(--gold)} .name-silver{color:var(--silver)} .name-bronze{color:var(--bronze)}
    .points-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-weight:900;border:1px solid var(--stroke);background:var(--surface2);color:#e8ecff}
    .points-chip.top{background:linear-gradient(180deg,#6c8bff,#3e64ff);color:#fff;border:none;box-shadow:var(--shadow)}
    .level{font-weight:900;padding:4px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.04)}
    .level .bar{display:inline-block;height:8px;width:90px;background:#0a0f25;border-radius:999px;position:relative;margin-left:8px;vertical-align:middle}
    .level .bar i{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#6c8bff,#3e64ff);width:0%}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;background:var(--surface2);color:#e8ecff;border:1px solid var(--stroke);font-weight:800;margin:2px}
    .badge.fast{background:rgba(255,179,0,.14);border-color:rgba(255,179,0,.35);color:#ffe3a6}
    .badge.perfect{background:rgba(124,77,255,.18);border-color:rgba(124,77,255,.38);color:#e0d6ff}
    .badge.ok{background:rgba(46,204,113,.15);border-color:rgba(46,204,113,.35);color:#b8ffd7}
    .medal{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;font-weight:800;color:#1b1830}
    .medal.gold{background:linear-gradient(135deg,#ffd662,#ffb300);box-shadow:0 2px 6px rgba(255,179,0,.35)}
    .medal.silver{background:linear-gradient(135deg,#e6e6e6,#bfbfbf);box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .medal.bronze{background:linear-gradient(135deg,#e2a97a,#d18d5a);box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .mypos{position:sticky;bottom:12px;margin-top:12px;} .mypos .card{background:linear-gradient(180deg,#13204d,#10173b)}
    /* Settings modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px}
    .modal .panel{background:linear-gradient(180deg,#0f1633,#0a112b);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);max-width:720px;width:100%;padding:18px;color:#e8ecff}
    .row{display:flex;gap:10px;align-items:center;margin:8px 0}
    .row label{min-width:140px;font-weight:800;color:#cbd6ff}
    .row input{flex:1;border:1px solid var(--stroke);background:#0e1530;color:#e8ecff;padding:10px;border-radius:10px}
    .row small{color:#9ca8d9}
    .right{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .btn{border:1px solid var(--stroke);background:transparent;color:#e8ecff;padding:10px 14px;border-radius:12px;font-weight:900;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--vio),var(--vio2));border:none}
  </style>
</head>
<body>
<header>
  <div class="container nav">
    <div class="brand"><i class="logo"></i><span>IT&nbsp;Hub</span> <small>.es</small></div>
    <nav class="menu">
      <a href="/">HOME</a>
      <a href="/#simuladores">SIMULADORES</a>
      <a href="/#contenidos">CONTENIDOS</a>
    </nav>
    <div class="actions">
      <button class="gear" onclick="openSettings()">‚öôÔ∏è Ajustes API</button>
    </div>
  </div>
</header>

<main class="container wrap">
  <div class="layout">
    <section class="card">
      <div class="header-row">
        <h2>üèÜ Ranking Gamificado ‚Äî Live API</h2>
        <div class="tabs" role="tablist">
          <button class="tab" id="tab-global" aria-pressed="true" onclick="setScope('global')">Global</button>
          <button class="tab" id="tab-season" aria-pressed="false" onclick="setScope('season')">Temporada (mes)</button>
          <button class="tab" id="tab-week" aria-pressed="false" onclick="setScope('week')">Semanal</button>
          <button class="tab" id="tab-az" aria-pressed="false" onclick="setExam('az-104')">AZ-104</button>
          <button class="tab" id="tab-aws" aria-pressed="false" onclick="setExam('aws-saa-c03')">SAA-C03</button>
        </div>
      </div>
      <div class="table-wrap" id="board">Cargando‚Ä¶</div>
    </section>

    <aside class="side">
      <div class="card rules">
        <h3>‚öôÔ∏è Reglas de puntos</h3>
        <ul>
          <li><b>+5</b> por respuesta correcta.</li>
          <li><b>+50</b> por examen aprobado (‚â•70%).</li>
          <li><b>+10</b> bonus r√°pido (‚â§30s/pregunta).</li>
          <li><b>Racha</b>: +5 extra por aprobado consecutivo en 7 d√≠as.</li>
        </ul>
        <p>Se generan <b>niveles</b> cada 150 XP. Top 3 con medalla y chip azul.</p>
      </div>
      <div class="mypos" id="myPosition"></div>
    </aside>
  </div>
</main>

<!-- Settings Modal -->
<div class="modal" id="modal">
  <div class="panel">
    <h3 style="margin:0 0 8px">‚öôÔ∏è Ajustes de API (guarda y recarga)</h3>
    <div class="row">
      <label for="apiBase">API Base</label>
      <input id="apiBase" placeholder="https://uougu1cm26.execute-api.eu-central-1.amazonaws.com">
    </div>
    <div class="row">
      <label for="bearer">Bearer Token</label>
      <input id="bearer" placeholder="Opcional: eyJhbGciOi...">
    </div>
    <div class="row">
      <label for="apikey">x-api-key</label>
      <input id="apikey" placeholder="Opcional: API Key">
    </div>
    <div class="row"><small>Se guardan en <code>localStorage</code> como <code>rank_api_base</code>, <code>rank_api_bearer</code> y <code>rank_api_key</code>.</small></div>
    <div class="right">
      <button class="btn" onclick="closeSettings()">Cancelar</button>
      <button class="btn primary" onclick="saveSettings()">Guardar</button>
    </div>
  </div>
</div>

<script>
// ===== Settings =====
function qs(id){return document.getElementById(id)}
function openSettings(){ const m=qs('modal'); m.style.display='flex'; qs('apiBase').value=getApiBase(); qs('bearer').value=localStorage.getItem('rank_api_bearer')||''; qs('apikey').value=localStorage.getItem('rank_api_key')||''; }
function closeSettings(){ qs('modal').style.display='none' }
function saveSettings(){ localStorage.setItem('rank_api_base', qs('apiBase').value.trim()); localStorage.setItem('rank_api_bearer', qs('bearer').value.trim()); localStorage.setItem('rank_api_key', qs('apikey').value.trim()); location.reload() }
function getApiBase(){ return (localStorage.getItem('rank_api_base')||'https://uougu1cm26.execute-api.eu-central-1.amazonaws.com').replace(/\\/$/,'') }
function getHeaders(){ const h={'Accept':'application/json'}; const b=localStorage.getItem('rank_api_bearer'); const k=localStorage.getItem('rank_api_key'); if(b) h['Authorization']='Bearer '+b; if(k) h['x-api-key']=k; return h; }

// ===== Helpers =====
const QUIZZES=['az-104','aws-saa-c03'];
const toInt=v=>Number.isFinite(Number(v))?(Number(v)|0):0;
const toNum=v=>Number.isFinite(Number(v))?Number(v):0;
const pick=v=>(typeof v==='string'?v.trim():'')
const getName=x=>pick(x.displayName)||pick(x.userName)||pick(x.username)||pick(x.name)||pick(x?.user?.name)||pick(x?.profile?.name)||'(no name)';
const pad=n=>String(n).padStart(2,'0');
const fmtDuration=(sec)=>{sec=toInt(sec); if(!sec||sec<0) return '‚Äî'; const m=Math.floor(sec/60), s=sec%60; return `${pad(m)}:${pad(s)}`};
const fmtDate=(iso)=>{ if(!iso) return '‚Äî'; try{ return new Date(iso).toLocaleString([], {year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});}catch{ return iso; }};
function weekKey(d){ const dt=new Date(d); const onejan=new Date(dt.getFullYear(),0,1); const week=Math.ceil((((dt-onejan)/86400000)+onejan.getDay()+1)/7); return `${dt.getFullYear()}-W${String(week).padStart(2,'0')}`; }
function pointsForAttempt(r){
  const correct=toInt(r.correct), total=toInt(r.total), dur=toInt(r.durationSec);
  let pts=correct*5; const pct=total>0? (correct/total)*100 : (r.pct||0);
  if(pct>=70) pts+=50; if(total>0&&dur>0&&(dur/total)<=30) pts+=10;
  return {pts, passed:pct>=70, pct};
}
function levelFromXP(xp){ const lvl=Math.max(1, Math.floor(xp/150)+1); const cur=xp%150; const p=Math.max(0,Math.min(100,Math.floor((cur/150)*100))); return {lvl,progress:p}; }

async function fetchJSON(url){
  const res = await fetch(url, {mode:'cors', cache:'no-store', headers:getHeaders()});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function fetchResults(limit=2000){
  const base=getApiBase();
  try{
    const data=await fetchJSON(`${base}/results?limit=${limit}`);
    const items=Array.isArray(data.items)?data.items:[];
    return items.map(x=>({ userId:x.userId||'(unknown)', userName:getName(x), quizId:(x.quizId||'-').toLowerCase(), correct:toInt(x.correct), total:toInt(x.total), pct:toNum(x.pct??0), durationSec:toInt(x.durationSec), ts:x.ts||null }))
                .filter(r=>QUIZZES.includes(r.quizId));
  }catch(e){
    console.warn('Fallo /results', e); throw e;
  }
}

async function fetchUsersByIds(ids){
  const base=getApiBase();
  try{
    // Endpoint opcional sugerido: GET /users?ids=uid1,uid2,... devuelve [{userId, displayName, avatarUrl}]
    const q = encodeURIComponent(ids.join(','));
    const data = await fetchJSON(`${base}/users?ids=${q}`);
    const arr = Array.isArray(data.items||data)||[];
    const map = new Map(arr.map(u=>[u.userId, u]));
    return (id)=> map.get(id)||null;
  }catch(e){
    console.warn('No hay /users o error. Continuo con nombres del resultado.');
    return (_)=>null;
  }
}

function aggregate(rows, scope, exam, getUser){
  const now=new Date(); const curMonth=now.getMonth(), curYear=now.getFullYear(); const wkKey=weekKey(now);
  const byUser=new Map();
  rows.forEach(r=>{
    if(exam && r.quizId!==exam) return;
    const d=r.ts? new Date(r.ts): null;
    if(scope==='season' && d && (d.getMonth()!==curMonth || d.getFullYear()!==curYear)) return;
    if(scope==='week' && d && weekKey(d)!==wkKey) return;
    const {pts, passed, pct}=pointsForAttempt(r);
    const key=r.userId+'|'+r.userName;
    if(!byUser.has(key)){ 
      const uinfo=getUser(r.userId)||{};
      byUser.set(key, {userId:r.userId, userName:uinfo.displayName||r.userName, xp:0, attempts:0, passed:0, fastest:Infinity, last:r.ts, badges:new Set(), streak:0, lastPassTs:null});
    }
    const u=byUser.get(key);
    if(passed){
      u.passed++;
      const t=d? d.getTime():0;
      if(u.lastPassTs && (t-u.lastPassTs)<=1000*60*60*24*7){ u.streak++; }
      else if(!u.lastPassTs){ u.streak=1; } else { u.streak=1; }
      u.lastPassTs=t;
    }
    u.xp += pts + Math.max(0,(u.streak-1)*5);
    u.attempts++;
    if(r.durationSec>0) u.fastest=Math.min(u.fastest, r.durationSec);
    if(pct===100) u.badges.add('perfect');
    if(r.total>0 && r.durationSec>0 && (r.durationSec/r.total)<=30) u.badges.add('fast');
  });
  const list=[...byUser.values()].map(u=>{ const lvl=levelFromXP(u.xp); return {...u, lvl:lvl.lvl, prog:lvl.progress}; })
    .sort((a,b)=>{ if(b.xp!==a.xp) return b.xp-a.xp; if(b.passed!==a.passed) return b.passed-a.passed; if(a.fastest!==b.fastest) return a.fastest-b.fastest; return String(a.userName).localeCompare(String(b.userName)); });
  return list;
}

function medalCell(i){ if(i===0) return '<span class="medal gold">1</span>'; if(i===1) return '<span class="medal silver">2</span>'; if(i===2) return '<span class="medal bronze">3</span>'; return String(i+1); }
function nameClass(i){ if(i===0) return 'name-strong name-gold'; if(i===1) return 'name-strong name-silver'; if(i===2) return 'name-strong name-bronze'; return 'name-strong'; }
function pointsChipClass(i){ return i<3 ? 'points-chip top' : 'points-chip'; }
function badgeHTML(b){ if(b==='fast') return '<span class="badge fast">‚ö° R√°pido</span>'; if(b==='perfect') return '<span class="badge perfect">üíØ Perfect</span>'; return '<span class="badge ok">‚úÖ Pro</span>'; }

function renderBoard(list){
  let html = '<table><thead><tr>\
    <th class="col-rank">#</th>\
    <th class="col-points">Puntos</th>\
    <th class="col-name">Jugador</th>\
    <th class="col-num">Nivel</th>\
    <th class="col-num">Aprobados</th>\
    <th class="col-num">Intentos</th>\
    <th class="col-num">Mejor tiempo</th>\
    <th class="col-date">√öltimo</th>\
    <th>Insignias</th>\
  </tr></thead><tbody>';
  list.forEach((u,i)=>{
    const initials = String(u.userName).trim().slice(0,2).toUpperCase();
    html += '<tr>\
      <td>'+medalCell(i)+'</td>\
      <td><span class="'+pointsChipClass(i)+'">‚≠ê '+u.xp+'</span></td>\
      <td class="col-name"><span class="avatar">'+initials+'</span><span class="'+nameClass(i)+'">'+u.userName+'</span></td>\
      <td><span class="level">Lv '+u.lvl+'<span class="bar"><i style="width:'+u.prog+'%"></i></span></span></td>\
      <td>'+u.passed+'</td>\
      <td>'+u.attempts+'</td>\
      <td>'+(u.fastest===Infinity? '‚Äî' : fmtDuration(u.fastest))+'</td>\
      <td>'+(u.last? fmtDate(u.last) : '‚Äî')+'</td>\
      <td>'+[...u.badges].map(b=> badgeHTML(b)).join('')+'</td>\
    </tr>';
  });
  html += '</tbody></table>';
  document.getElementById('board').innerHTML = html;
}

let SCOPE='global', EXAM=null, CACHE=null, GETUSER=(_)=>null;
function setScope(x){ SCOPE=x; syncTabs(); render(); }
function setExam(x){ EXAM=x; syncTabs(); render(); }
function syncTabs(){ const set=(id,on)=>document.getElementById(id)?.setAttribute('aria-pressed', String(on)); set('tab-global',SCOPE==='global'); set('tab-season',SCOPE==='season'); set('tab-week',SCOPE==='week'); set('tab-az',EXAM==='az-104'); set('tab-aws',EXAM==='aws-saa-c03'); }

async function render(){
  const node=document.getElementById('board');
  node.innerHTML='Cargando‚Ä¶';
  try{
    if(!CACHE){
      const rows = await fetchResults(3000);
      // hydrate users
      const ids=[...new Set(rows.map(r=>r.userId))];
      GETUSER = await fetchUsersByIds(ids);
      CACHE = rows;
    }
    const list = aggregate(CACHE, SCOPE, EXAM, GETUSER);
    renderBoard(list.slice(0,50));
  }catch(e){
    node.innerHTML = '<p style="color:var(--muted)">Error cargando API: '+e.message+'<br>Comprueba CORS y los ajustes con ‚öôÔ∏è.</p>';
  }
}

render();
</script>
</body>
</html>
