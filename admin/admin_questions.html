<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ExamQuestions · Viewer (GET)</title>
<style>
  :root { --bg:#0b1020; --panel:#121a33; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2a4a; --link:#93c5fd; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;background:var(--bg);color:var(--text)}
  header{padding:14px 18px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#0b1020cc;backdrop-filter:blur(6px);z-index:50}
  h1{margin:0;font-size:18px}
  .container{max-width:1300px;margin:0 auto;padding:16px 18px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input,select{background:#0e1530;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;outline:none}
  input[type="number"]{width:110px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
  .btn{appearance:none;border:1px solid var(--border);background:#0f1a36;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn:hover{border-color:#29407a}
  .status{font-size:12px;color:var(--muted);margin-top:6px}
  .err{color:#fca5a5}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;font-size:13px}
  thead th{position:sticky;top:122px;background:#0d1531;border-bottom:1px solid var(--border);padding:10px;text-align:left;z-index:40}
  tbody td{border-bottom:1px solid var(--border);padding:8px 8px;vertical-align:top}
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#93c5fd}
  .pill{display:inline-block;border:1px solid #1f2a4a;background:#0d1e3c;border-radius:999px;padding:4px 8px;font-size:12px;color:#bfdbfe}
  .links a{color:var(--link)}
  details summary{cursor:pointer;color:#bfdbfe}
</style>
</head>
<body>
<header><h1>ExamQuestions · Viewer (GET)</h1></header>

<div class="container">
  <div class="panel">
    <div class="row">
      <div style="min-width:380px;flex:1">
        <label>API Base URL</label>
        <input id="apiBase" type="text" placeholder="https://uougu1cm26.execute-api.eu-central-1.amazonaws.com" style="width:100%">
        <div class="status">No incluyas <code>/questions</code>; si lo pegas, lo limpiamos.</div>
      </div>
      <div>
        <label>API Key (opcional)</label>
        <input id="apiKey" type="text" placeholder="x-api-key">
      </div>
      <div>
        <label>Exam (casing sensible)</label>
        <input id="exam" type="text" value="AZ-104" style="width:140px">
      </div>
      <div>
        <label>Limit (1–200 por página)</label>
        <input id="limit" type="number" min="1" max="200" value="20">
      </div>
      <div>
        <label>Buscar (q)</label>
        <input id="q" type="text" placeholder="texto en pregunta/categoría">
      </div>
      <button id="btnLoad" class="btn">Cargar</button>
      <button id="btnPrev" class="btn">◀ Anterior</button>
      <button id="btnNext" class="btn">Siguiente ▶</button>
    </div>
    <div id="status" class="status">Listo.</div>
    <div class="status"><span class="pill">Paginación con LastEvaluatedKey</span></div>
  </div>

  <div class="panel" style="margin-top:12px">
    <table id="tbl">
      <thead>
        <tr>
          <th class="mono">questionId</th>
          <th>exam</th>
          <th>category</th>
          <th>difficulty</th>
          <th>question</th>
          <th>options</th>
          <th>answer</th>
          <th>explanation</th>
          <th>links</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* Utils */
const $=(s,el=document)=>el.querySelector(s);
function setStatus(msg,isErr=false){const s=$('#status');s.textContent=msg;s.className='status'+(isErr?' err':'');}
function normalizeBaseUrl(raw){let b=(raw||'').trim();b=b.replace(/\/+$/,'');b=b.replace(/\/questions\/?$/i,'');return b;}

/* Estado de paginación */
const PAG = { lastKey:null, prevStack:[] };

/* Llamada a GET /questions */
async function getQuestions({base, apiKey, exam, limit, q, lastKey}){
  const params=new URLSearchParams({ exam:String(exam), limit:String(limit) });
  if(q) params.set('q', q);
  if(lastKey) params.set('lastKey', encodeURIComponent(JSON.stringify(lastKey)));
  const url=`${base}/questions?${params.toString()}`;

  const headers={ 'Accept':'application/json' };
  if(apiKey) headers['x-api-key']=apiKey;

  const res=await fetch(url,{headers});
  const text=await res.text();
  if(!res.ok) throw new Error(`HTTP ${res.status}: ${text||res.statusText}`);
  let data; try{ data=JSON.parse(text); }catch{ throw new Error('Respuesta no JSON: '+text); }
  return data; // {items, lastEvaluatedKey, count}
}

/* Render de tabla */
function render(items){
  const tb=$('#tbl tbody');
  tb.innerHTML='';
  if(!Array.isArray(items)||!items.length){
    const tr=document.createElement('tr'); const td=document.createElement('td');
    td.colSpan=9; td.textContent='Sin datos.'; tr.appendChild(td); tb.appendChild(tr); return;
  }
  for(const it of items){
    const tr=document.createElement('tr');

    const td=(txt, mono=false)=>{
      const d=document.createElement('td');
      d.innerHTML = (txt==null?'':String(txt));
      if(mono) d.className='mono';
      return d;
    };

    // options: lista con saltos de línea
    const opts = Array.isArray(it.options) ? it.options.join('<br>') : '';

    // answer: muestra índice y texto si viene
    const ans = (typeof it.answerIndex==='number')
      ? `${it.answerIndex} — ${it.answerText??''}`
      : (it.answerText??'');

    // explanation: usar explanationRich si existe
    const exp = (it.explanationRich && typeof it.explanationRich==='string')
      ? it.explanationRich
      : (it.explanation||'');

    // links: lista de anchors si existe
    let linksHtml = '';
    if(Array.isArray(it.links) && it.links.length){
      linksHtml = it.links.map(l=>{
        const title = l.title || l.url || 'link';
        const url = l.url || '#';
        return `<div class="links"><a target="_blank" rel="noopener" href="${url}">${title}</a></div>`;
      }).join('');
    }

    tr.appendChild(td(it.questionId, true));
    tr.appendChild(td(it.exam||''));
    tr.appendChild(td(it.category||''));
    tr.appendChild(td(it.difficulty||''));
    tr.appendChild(td(it.question||''));
    tr.appendChild(td(opts));
    tr.appendChild(td(ans));
    tr.appendChild(td(exp));
    tr.appendChild(td(linksHtml));
    $('#tbl tbody').appendChild(tr);
  }
}

/* Acciones */
async function load(direction){
  try{
    setStatus('Cargando...');
    const base = normalizeBaseUrl($('#apiBase').value);
    const apiKey = $('#apiKey').value.trim();
    const exam = $('#exam').value.trim();      // respeta casing
    const limit = Math.max(1, Math.min(200, Number($('#limit').value)||20));
    const q = $('#q').value.trim();

    if(!base) { setStatus('Falta API Base URL', true); return; }
    if(!exam) { setStatus('Falta exam', true); return; }

    // manejar navegación
    let lastKey = null;
    if(direction === 'next'){
      if(!PAG.lastKey){ setStatus('No hay más páginas.', true); return; }
      // empuja el current hacia la pila para permitir "prev"
      PAG.prevStack.push(PAG.lastKey);
      lastKey = PAG.lastKey;
    } else if(direction === 'prev'){
      const prev = PAG.prevStack.pop();
      lastKey = prev || null;
      // NOTA: al volver atrás, no sabemos el "prev del prev" del servidor, pero
      // mantenemos nuestra pila local y el servidor acepta lastKey hacia delante.
    } else {
      // reset navegación
      PAG.prevStack = [];
      PAG.lastKey = null;
    }

    const data = await getQuestions({ base, apiKey, exam, limit, q, lastKey });
    const items = Array.isArray(data.items) ? data.items : [];
    render(items);

    PAG.lastKey = data.lastEvaluatedKey || null;

    const more = PAG.lastKey ? ' · hay más ▶' : '';
    setStatus(`Cargadas ${items.length} preguntas${more}`);
  }catch(e){
    console.error(e);
    setStatus(e.message||'Error', true);
  }
}

/* Eventos UI */
document.getElementById('btnLoad').addEventListener('click', ()=>load());
document.getElementById('btnNext').addEventListener('click', ()=>load('next'));
document.getElementById('btnPrev').addEventListener('click', ()=>load('prev'));
document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') load(); });

/* Tip inicial */
setStatus('Introduce la API Base URL (p. ej. https://uougu1cm26.execute-api.eu-central-1.amazonaws.com), el exam (ej. AZ-104) y pulsa Cargar.');
</script>
</body>
</html>
