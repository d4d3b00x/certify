<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Quiz ‚Ä¢ CertifyLab</title>

  <style>
    :root{
      --bg:#0f1320;--surface:#161b2d;--surface2:#1b2140;--ink:#e8ecff;--muted:#9ca8d9;--stroke:#283056;
      --aws:#ff9900;--azure:#0078d4;--radius:14px;--shadow:0 10px 24px rgba(6,12,40,.45);
      --accent:#6c8bff;--accent-2:#3e64ff;--accent-ring:rgba(108,139,255,.28);
      --ok:#25b873;--bad:#ff6b6b;--warn:#ffd063;
      --brand:#6c8bff;
      --brand-ring: rgba(108,139,255,.32);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;line-height:1.6}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}

    header{position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);
      background:linear-gradient(180deg,rgba(15,19,32,.85),rgba(15,19,32,.55));
      border-bottom:1px solid var(--stroke)}
    .nav{height:64px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:10px;height:10px;border-radius:50%;background:#6c8bff;box-shadow:0 0 0 6px rgba(108,139,255,.18)}
    .menu{display:none;gap:18px;color:var(--muted);font-weight:700}
    .menu a:hover{color:var(--ink)}
    .actions{display:none;gap:10px;align-items:center}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:12px;border:1px solid var(--stroke);cursor:pointer;font-weight:800}
    .btn.primary{background:linear-gradient(180deg,#6c8bff,#3e64ff);border:none;color:#fff;box-shadow:var(--shadow)}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.55;cursor:not-allowed;filter:grayscale(.25)}
    .userchip{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--stroke);padding:8px 12px;border-radius:999px}
    .userchip b{white-space:nowrap}

    @media(min-width:720px){.menu,.actions{display:flex}}

    .grid{display:grid;grid-template-columns:1.35fr .85fr;gap:16px;margin-top:16px}
    @media(max-width:860px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--surface);border:1px solid var(--stroke);border-radius:12px;padding:16px;box-shadow:var(--shadow)}
    .panel h2,.panel h3{margin:0 0 10px}

    .badge-pill{
      display:inline-flex;align-items:center;gap:10px;border:1px solid #ffffff1f;background:#ffffff10;
      padding:8px 12px;border-radius:999px;font-weight:900
    }

    .domains-list{list-style:none;padding-left:0;margin:0;display:grid;gap:12px}
    .dom-item{
      display:flex;align-items:center;gap:12px;
      border:1px solid var(--stroke);background:var(--surface2);
      border-radius:14px;padding:14px 16px;cursor:pointer;transition:transform .08s,border .12s,box-shadow .12s
    }
    .dom-item:hover{transform:translateY(-1px);border-color:#3a4883;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .dom-dot{width:14px;height:14px;border-radius:50%;border:2px solid currentColor}
    .dom-code{font-weight:900;min-width:42px;text-align:center;color:#cbd6ff}
    .dom-title{font-weight:800}
    .dom-item.active{outline:3px solid var(--brand-ring)}

    #infoDom{
      margin-top:16px;
      background:linear-gradient(180deg,#111937,#0f1633);
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:18px;
      box-shadow:var(--shadow);
      color:var(--ink);
      display:none;
    }
    .info-head{display:flex;align-items:center;justify-content:space-between;margin:0 0 10px}
    #infoTitle{font-size:clamp(1.2rem,3.2vw,1.6rem);margin:0}
    .info-content{line-height:1.75}
    .info-empty{color:var(--muted);border:1px dashed var(--stroke);padding:12px;border-radius:10px;background:#0f1630}

    #simCard{
      position:relative;
      background:
        radial-gradient(600px 240px at 100% 0, color-mix(in srgb, var(--brand) 24%, transparent) , transparent 60%),
        linear-gradient(180deg,#111937,#0f1633);
      border:1px solid color-mix(in srgb, var(--brand) 48%, transparent);
      box-shadow:0 0 0 2px color-mix(in srgb, var(--brand) 35%, transparent) inset, 0 14px 30px rgba(0,0,0,.45);
    }
    #simCard::after{
      content:"";
      position:absolute;inset:-1px;border-radius:12px;pointer-events:none;
      box-shadow:0 0 0 3px color-mix(in srgb, var(--brand) 28%, transparent);
    }

    .segmented{display:flex;gap:8px;background:var(--surface2);border:1px solid var(--stroke);border-radius:10px;padding:6px}
    .segmented input{display:none}
    .segmented label{flex:1;text-align:center;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:800}
    .segmented input:checked + label{
      background:#0f1630;border:1px solid color-mix(in srgb, var(--brand) 55%, #31407a);
      box-shadow:0 0 0 2px color-mix(in srgb, var(--brand) 25%, transparent) inset;
    }
    .segmented label.disabled{opacity:.55;cursor:not-allowed;position:relative}
    .segmented label.disabled::after{content:"Pronto";position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:.78rem;color:#9ca8d9}

    .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    .select{display:flex;gap:8px}
    .select select{border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;background:var(--surface2);color:var(--ink)}

    #simTitle{
      font-size:clamp(1.4rem,3.0vw,2.0rem);
      font-weight:900; line-height:1.2; letter-spacing:.2px;
      text-shadow:0 10px 28px color-mix(in srgb, var(--brand) 40%, transparent);
      margin-bottom:6px;
    }

    .chip-dom{
      display:inline-flex;align-items:center;gap:8px;
      background:#0f1630;border:1px solid #313c6e;border-radius:999px;
      padding:6px 10px;font-weight:900;cursor:pointer;user-select:none;
      transition:transform .06s, box-shadow .12s, border-color .12s, background .12s;
    }
    .chip-dom .led{width:10px;height:10px;border-radius:999px;background:transparent;border:2px solid #5c6bb2}
    .chip-dom.on{background:rgba(108,139,255,.14); border-color:#4a5cc3; box-shadow:0 0 0 2px var(--brand-ring) inset;}
    .chip-dom.on .led{background:var(--brand); border-color:var(--brand)}

    #startBtn{
      background:var(--brand);color:#0b0f22;border-color:transparent;
      box-shadow:0 10px 24px color-mix(in srgb, var(--brand) 35%, transparent);
    }
    #startBtn:hover{filter:brightness(1.05)}
    #startBtn:active{transform:translateY(1px)}

    footer{margin:32px 0 12px;color:#8fa4ff99;text-align:center;font-size:.95rem}
    footer a{color:#bcd3ff}

    /* ===== Modal resultados estilo mini-test ===== */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:120;padding:16px}
    .modal.show{display:flex}
    .modal-card{width:min(760px,100%);background:var(--surface);border:1px solid var(--stroke);border-radius:14px;padding:18px;box-shadow:var(--shadow)}
    .modal-card h3{margin:0 0 12px}
    .diag-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(max-width:640px){.diag-grid{grid-template-columns:1fr}}
    .meter{position:relative;height:10px;border-radius:999px;background:#0b1225;border:1px solid var(--stroke);overflow:hidden}
    .meter>span{position:absolute;left:0;top:0;height:100%;width:0;transition:width .35s}
    .m-ok{background:var(--ok)} .m-warn{background:var(--warn)} .m-bad{background:var(--bad)}
  </style>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="brand"><span class="dot"></span> CertifyLab</div>
      <nav class="menu">
        <a href="/index.html">Inicio</a>
        <a href="/index.html#simuladores">Simuladores</a>
        <a href="/index.html#contenidos">Contenidos</a>
        <a href="/score/ranking.html">Ranking</a>
      </nav>
      <div class="actions" id="authActions">
        <a class="btn" id="btnLogin" href="/login/login.html">Login</a>
        <a class="btn primary" id="btnSignup" href="/login/login.html#signup">Crear cuenta</a>
        <div class="userchip" id="userChip" style="display:none">
          <span>üëã</span><b id="userNameTop">Usuario</b>
          <a class="btn" href="/user/profile.html">Perfil</a>
          <button class="btn" id="btnLogout" type="button">Salir</button>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap" id="root">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div id="badge" class="badge-pill"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn" href="/index.html">üè† Inicio</a>
      </div>
    </div>

    <div class="grid">
      <section class="panel" id="leftInfo">
        <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap">
          <img id="provLogo" alt="" style="width:66px;height:auto">
          <div id="provText" style="color:var(--muted)">Cargando‚Ä¶</div>
        </div>

        <h2 style="margin-top:14px">Dominios del examen</h2>
        <p style="margin-top:-6px;color:var(--muted)"><em>üòé‚úèÔ∏è Haz clic en un dominio para abrir notas √∫tiles abajo.</em></p>

        <ul id="domainsList" class="domains-list"></ul>
      </section>

      <aside class="panel" id="simCard">
        <h3 id="simTitle">Simulador de examen</h3>

        <div class="field">
          <label>Modo</label>
          <div class="segmented" id="modeSeg">
            <input type="radio" id="modePractice" name="mode" value="practice" checked>
            <label for="modePractice">Pr√°ctica</label>
            <input type="radio" id="modeExam" name="mode" value="exam" disabled>
            <label for="modeExam" class="disabled" title="Modo examen pr√≥ximamente">Examen</label>
          </div>
        </div>

        <div class="field">
          <label>Preguntas</label>
          <div class="select">
            <select id="qCount">
              <option>5</option><option>10</option><option>15</option><option>30</option><option>65</option><option selected>5</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>Dominios (filtro opcional)</label>
          <div id="domainChips" style="display:flex;flex-wrap:wrap;gap:8px"></div>
          <div style="color:var(--muted)">D√©jalo vac√≠o para incluir todos los dominios.</div>
        </div>

        <div class="field" style="margin-top:12px">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="startBtn" class="btn">‚ñ∂ Empezar</button>
          </div>
          <div style="color:var(--muted);margin-top:8px">
            Atajos: <span class="btn" style="padding:2px 6px">N</span> Siguiente,
            <span class="btn" style="padding:2px 6px">B</span> Anterior,
            <span class="btn" style="padding:2px 6px">M</span> Marcar,
            <span class="btn" style="padding:2px 6px">1-9</span> elegir.
          </div>
        </div>
      </aside>
    </div>

    <section id="infoDom" class="panel">
      <div class="info-head">
        <h3 id="infoTitle">Notas del dominio</h3>
        <button id="infoClose" class="btn">‚úñ Cerrar</button>
      </div>
      <div id="infoContent" class="info-content">
        <div class="info-empty">Selecciona un dominio para ver notas concisas aqu√≠.</div>
      </div>
    </section>

    <main id="view"></main>
  </div>

  <footer>
    Hecho con ‚ù§Ô∏è por CertifyLab ‚Ä¢ <a href="/index.html#contenidos">Apuntes</a>
  </footer>

  <!-- Modal resultados -->
  <div class="modal" id="quizResultModal" aria-hidden="true">
    <div class="modal-card">
      <h3>üìä Resultados del examen</h3>
      <div id="quizScoreBox" class="panel" style="padding:12px;margin:0 0 12px;background:var(--surface2)">
        <strong id="quizScoreText">Puntuaci√≥n</strong>
      </div>
      <div id="quizDomainsGrid" class="diag-grid"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="qrClose">Cerrar</button>
      </div>
    </div>
  </div>

  <script src="/control_quizs/Q_global_dark.js" defer></script>

  <script>
    /* ====== Auth header ====== */
    function getCurrentUser(){ try{return JSON.parse(localStorage.getItem("currentUser")||"null");}catch{return null;} }
    function renderAuth(){
      const u = getCurrentUser();
      const chip = document.getElementById('userChip');
      const nameEl = document.getElementById('userNameTop');
      const btnLogin = document.getElementById('btnLogin');
      const btnSignup = document.getElementById('btnSignup');
      const btnLogout = document.getElementById('btnLogout');
      if(u){ nameEl.textContent = u.name || u.email || 'Usuario'; chip.style.display='flex'; btnLogin.style.display='none'; btnSignup.style.display='none'; }
      else { chip.style.display='none'; btnLogin.style.display=''; btnSignup.style.display=''; }
      btnLogout?.addEventListener('click', ()=>{ localStorage.removeItem('currentUser'); renderAuth(); });
    }
    renderAuth();

    /* ====== Utils ====== */
    const qs = k => new URLSearchParams(location.search).get(k);
    const QUIZ = (qs('quiz')||'').toLowerCase();
    const IS_AZ = QUIZ.startsWith('az');
    const BASE = getComputedStyle(document.documentElement);
    const BRAND_CLR = IS_AZ ? BASE.getPropertyValue('--azure').trim()
                            : BASE.getPropertyValue('--aws').trim();
    const withAlpha = (hex, aHex) => hex.startsWith('#') ? `${hex}${aHex}` : hex;

    const badge=document.getElementById('badge'),
          provLogo=document.getElementById('provLogo'),
          provText=document.getElementById('provText'),
          dlist=document.getElementById('domainsList'),
          chips=document.getElementById('domainChips'),
          simTitle=document.getElementById('simTitle'),
          startBtn=document.getElementById('startBtn'),
          qCount=document.getElementById('qCount'),
          infoDom=document.getElementById('infoDom'),
          infoTitle=document.getElementById('infoTitle'),
          infoContent=document.getElementById('infoContent'),
          infoClose=document.getElementById('infoClose'),
          simCard=document.getElementById('simCard'),
          view=document.getElementById('view');

    /* ====== Branding/config ====== */
    const CONFIG = {
      'aws-saa-c03': {
        title: 'AWS SOLUTIONS ARCHITECT ‚Äî ASSOCIATE (SAA-C03)',
        logo: 'https://upload.wikimedia.org/wikipedia/commons/9/93/Amazon_Web_Services_Logo.svg',
        blurb: 'Dise√±a arquitecturas seguras y optimizadas en coste en AWS. Ideal si ya tienes algo de experiencia en AWS o una base s√≥lida on-prem.',
        domains: [
          ['D1','Dise√±ar arquitecturas seguras (30%)'],
          ['D2','Dise√±ar arquitecturas resilientes (26%)'],
          ['D3','Dise√±ar arquitecturas de alto rendimiento (24%)'],
          ['D4','Dise√±ar arquitecturas optimizadas en coste (20%)'],
        ],
      },
      'az-104': {
        title: 'MICROSOFT AZURE ADMINISTRATOR ‚Äî ASSOCIATE (AZ-104)',
        logo: 'https://upload.wikimedia.org/wikipedia/commons/a/a8/Microsoft_Azure_Logo.svg',
        blurb: 'Domina lo esencial de administraci√≥n en Azure: identidades, gobierno, c√≥mputo, redes y monitorizaci√≥n.',
        domains: [
          ['D1','Administrar identidades y gobierno (15‚Äì20%)'],
          ['D2','Implementar y administrar almacenamiento (15‚Äì20%)'],
          ['D3','Desplegar y administrar c√≥mputo (20‚Äì25%)'],
          ['D4','Configurar y administrar redes (20‚Äì25%)'],
          ['D5','Monitorizar y mantener recursos (10‚Äì15%)'],
        ],
      }
    };

    const DOMAIN_FILES = {
      'az-104': { D1:'/tips/azure-az104-tips-domain1.html', D2:'/tips/azure-az104-tips-domain2.html', D3:'/tips/azure-az104-tips-domain3.html', D4:'/tips/azure-az104-tips-domain4.html', D5:'/tips/azure-az104-tips-domain5.html' },
      'aws-saa-c03': { D1:'/tips/aws-saa-c03-tips-domain1.html', D2:'/tips/aws-saa-c03-tips-domain2.html', D3:'/tips/aws-saa-c03-tips-domain3.html', D4:'/tips/aws-saa-c03-tips-domain4.html' }
    };

    const cfg = CONFIG[QUIZ];
    if(!cfg){
      document.getElementById('root').innerHTML = `<div class="panel">Quiz desconocido: <b>${QUIZ||'(vac√≠o)'}</b>. <a href="/index.html">Volver</a></div>`;
    } else {
      document.documentElement.style.setProperty('--brand', BRAND_CLR);
      document.documentElement.style.setProperty('--brand-ring', `color-mix(in srgb, ${BRAND_CLR} 32%, transparent)`);

      badge.style.borderColor = withAlpha(BRAND_CLR,'33');
      badge.style.background = withAlpha(BRAND_CLR,'1f');
      badge.innerHTML = `<span style="width:10px;height:10px;border-radius:50%;background:${BRAND_CLR}"></span> ${cfg.title}`;

      provLogo.src = cfg.logo; provLogo.alt = IS_AZ?'Azure':'AWS';
      provText.textContent = cfg.blurb;
      simTitle.textContent = `${QUIZ.toUpperCase()} ¬∑ Simulador de examen`;

      dlist.innerHTML = cfg.domains.map(([d,txt]) =>
        `<li class="dom-item" data-dn="${d}">
           <span class="dom-dot" style="color:${BRAND_CLR}"></span>
           <span class="dom-code">${d}</span>
           <span class="dom-title">${txt}</span>
         </li>`).join('');

      chips.innerHTML = cfg.domains.map(([d]) =>
        `<label class="chip-dom" data-dn="${d}">
           <input type="checkbox" value="${d}" hidden>
           <span class="led"></span> ${d}
         </label>`).join('');

      const examInput = document.getElementById('modeExam');
      const examLabel = document.querySelector('label[for="modeExam"]');
      if (examInput) examInput.disabled = true;
      if (examLabel) examLabel.classList.add('disabled');
      document.getElementById('modeSeg').addEventListener('click', (e)=>{
        const isExam = e.target.getAttribute && (e.target.getAttribute('for') === 'modeExam');
        if (isExam) e.preventDefault();
      });

      simCard.style.borderColor = withAlpha(BRAND_CLR,'66');
      simCard.style.boxShadow = `0 0 0 2px ${withAlpha(BRAND_CLR,'55')} inset, 0 14px 30px rgba(0,0,0,.45)`;
      startBtn.style.background = BRAND_CLR;

      function updateChipVisuals(){
        chips.querySelectorAll('.chip-dom').forEach(lbl=>{
          const cb = lbl.querySelector('input[type="checkbox"]');
          lbl.classList.toggle('on', !!cb.checked);
        });
      }
      function toggleChipFor(domainCode){
        const chip = chips.querySelector(`.chip-dom[data-dn="${domainCode}"]`);
        if(!chip) return;
        const cb = chip.querySelector('input[type="checkbox"]');
        cb.checked = !cb.checked; updateChipVisuals();
      }
      dlist.addEventListener('click', (ev)=>{
        const li = ev.target.closest('.dom-item'); if(!li) return;
        dlist.querySelectorAll('.dom-item').forEach(x=>x.classList.remove('active'));
        li.classList.add('active'); toggleChipFor(li.dataset.dn); loadDomainNotes(li.dataset.dn);
      });
      chips.addEventListener('click', (ev)=>{
        const wrap = ev.target.closest('.chip-dom'); if(!wrap) return;
        const cb = wrap.querySelector('input[type="checkbox"]'); cb.checked = !cb.checked; updateChipVisuals();
      });
      updateChipVisuals();

      /* ====== Estado/scroll del bot√≥n empezar ====== */
      let quizActive = false;
      const startBtnDefaultText = startBtn.textContent;
      const header = document.querySelector('header');
      function smoothScrollTo(el){
        if(!el) return;
        const rect = el.getBoundingClientRect();
        const offset = (header?header.offsetHeight:0)+10;
        const top = rect.top + window.scrollY - offset;
        window.scrollTo({ top, behavior:'smooth' });
      }

      function setQuizActive(on){
        quizActive = !!on;
        startBtn.disabled = quizActive;
        startBtn.textContent = quizActive ? '‚è≥ En marcha‚Ä¶' : startBtnDefaultText;
        startBtn.setAttribute('aria-disabled', quizActive ? 'true' : 'false');
      }

      function waitForQuizMount(timeout=4000){
        return new Promise(resolve=>{
          if (view.children.length>0) return resolve();
          const obs = new MutationObserver(()=>{ if(view.children.length>0){ obs.disconnect(); resolve(); }});
          obs.observe(view,{childList:true});
          setTimeout(()=>{ obs.disconnect(); resolve(); }, timeout);
        });
      }

      // eventos del motor
      window.addEventListener('quiz:started', ()=>{ setQuizActive(true); smoothScrollTo(document.querySelector('#view .question-card')||view); });
      window.addEventListener('quiz:render',  ()=>{ /* opcional: hook por render */ });
      window.addEventListener('quiz:ended',   ()=>{ setQuizActive(false); });

      startBtn.addEventListener('click', async ()=>{
        if (quizActive) return;
        if (infoDom.style.display !== 'none') { infoDom.style.display='none'; }
        const count = parseInt(qCount.value,10) || 65;
        const tags = Array.from(chips.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);
        if(typeof window.start === 'function'){
          setQuizActive(true);
          window.start(QUIZ, { count, tags });
          await waitForQuizMount();
          smoothScrollTo(document.querySelector('#view .question-card')||view);
        }else{
          setQuizActive(false);
          alert('Motor de simulador no cargado.');
        }
      });
    }

    /* ====== Notas dominio ====== */
    async function loadDomainNotes(domainCode){
      const map = DOMAIN_FILES[QUIZ]||{};
      const file = map[domainCode];
      infoTitle.textContent = `${domainCode} ‚Äî Notas`;
      infoDom.style.display = 'block';
      infoContent.innerHTML = `<div class="info-empty">Cargando notas‚Ä¶</div>`;
      if(!file){ infoContent.innerHTML = `<div class="info-empty">No hay archivo de notas asignado para <b>${domainCode}</b>.</div>`; return; }
      try{
        const res = await fetch(file, {cache:'no-store'});
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        doc.querySelectorAll('script,link').forEach(n=>n.remove());
        const src = doc.querySelector('.wrap') || doc.body;
        infoContent.innerHTML = src ? src.innerHTML : html;
        const header = document.querySelector('header');
        const rect = document.getElementById('infoDom').getBoundingClientRect();
        const top = rect.top + window.scrollY - ((header?header.offsetHeight:0)+10);
        window.scrollTo({top,behavior:'smooth'});
      }catch(e){
        infoContent.innerHTML = `<div class="info-empty">No se pudieron cargar las notas de <b>${domainCode}</b>. (${e?.message||'error'})</div>`;
      }
    }
    document.getElementById('infoClose').addEventListener('click', ()=>{ document.getElementById('infoDom').style.display='none'; });

    /* ====== Modal de resultados por dominio ====== */
    const qrModal = document.getElementById('quizResultModal');
    const qrClose = document.getElementById('qrClose');
    const qrGrid  = document.getElementById('quizDomainsGrid');
    const qrScore = document.getElementById('quizScoreText');

    function percent(a,b){ return b ? Math.round((a/b)*100) : 0; }
    function barClass(p){ return p<50?'m-bad':(p<75?'m-warn':'m-ok'); }

    function showResultsModal(data){
      const s = Number(data?.score||0), t = Number(data?.total||0);
      qrScore.textContent = `Puntuaci√≥n: ${s}/${t} (${percent(s,t)}%)`;

      qrGrid.innerHTML = '';
      const byDom = data?.byDomain || null;

      if(byDom && Object.keys(byDom).length){
        Object.entries(byDom).forEach(([code,info])=>{
          const p = percent(info.correct, info.total);
          const card = document.createElement('div');
          card.className = 'panel';
          card.style.padding='12px';
          card.style.background='var(--surface2)';
          card.innerHTML = `
            <div style="font-weight:900;margin-bottom:6px">${info.name||code}</div>
            <div class="meter"><span class="${barClass(p)}" style="width:${p}%"></span></div>
            <div style="color:var(--muted);margin-top:6px">${info.correct}/${info.total} aciertos ¬∑ ${p}%</div>
          `;
          qrGrid.appendChild(card);
        });
      } else {
        const card = document.createElement('div');
        card.className='panel';
        card.style.padding='12px';
        card.style.background='var(--surface2)';
        card.innerHTML = `<div style="color:var(--muted)">No hay desglose por dominios disponible para este intento.</div>`;
        qrGrid.appendChild(card);
      }

      qrModal.classList.add('show');
      setTimeout(()=>{ qrModal.scrollIntoView({behavior:'smooth', block:'center'}); }, 50);
    }
    qrClose.addEventListener('click', ()=> qrModal.classList.remove('show'));
    qrModal.addEventListener('click', (e)=>{ if(e.target===qrModal) qrModal.classList.remove('show'); });

    window.quizResults = showResultsModal;
    window.addEventListener('quiz:results', (e)=> showResultsModal(e.detail||{}));
  </script>
</body>
</html>
