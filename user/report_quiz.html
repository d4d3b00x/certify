<!doctype html>
<html lang="es">
<head>
  <!-- Google tag (gtag.js) - igual que en tu index -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DYZ3GCXHEK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-DYZ3GCXHEK');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f1320" />
  <title>Quiz Report ¬∑ IT Hub</title>

  <style>
  /* ================== VARIABLES BASE (compatibles con tu index) ================== */
  :root{
    --bg:#0b1022; --surface:#121833; --surface2:#151c3e; --ink:#e9edff; --muted:#9ca8d9; --stroke:#2a325b;
    --accent:#78a0ff; --accent-2:#6a7cff; --ok:#2bdc8c; --bad:#ff6b6b; --warn:#ffd24d;
    --chip:#0f1734; --shadow:0 14px 38px rgba(5,8,30,.45); --radius:16px;
  }
  *{box-sizing:border-box}
  html{font-size:15px}
  body{
    margin:0;
    background:
      radial-gradient(900px 420px at 15% -10%, #121a42 0, transparent 60%),
      radial-gradient(900px 420px at 85% -10%, #1a1434 0, transparent 60%),
      linear-gradient(180deg,#0c122a,#0b0f22) fixed;
    color:var(--ink);
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    line-height:1.55;
  }
  a{color:inherit;text-decoration:none}

  /* ================== CABECERA (copiada/compat) ================== */
  header{position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);
    background:linear-gradient(180deg,rgba(15,19,32,.85),rgba(15,19,32,.55));border-bottom:1px solid var(--stroke)}
  .container{max-width:1200px;margin:0 auto;padding:0 16px}
  .nav{height:64px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900;text-transform:uppercase}
  .brand img.site-logo{height:42px;width:auto;display:block}
  nav.menu{display:flex;gap:12px;color:var(--muted);font-weight:800;align-items:center;text-transform:uppercase}
  nav.menu a.link-btn{display:inline-flex;align-items:center;justify-content:center;min-width:110px;height:40px;padding:0 12px;border-radius:10px;border:1px solid transparent;font-weight:900}
  nav.menu a.link-btn:hover{border-color:#2a3150;color:var(--ink)}
  .authwrap{display:flex;align-items:center;gap:6px;background:linear-gradient(180deg,#151b31,#12182c); border:1px solid #2a3150;
    border-radius:999px; padding:4px; box-shadow:0 6px 18px rgba(5,10,30,.35); max-height:44px;}
  .hello{display:flex;align-items:center;gap:6px;color:#cbd3ff;font-weight:800;padding:4px 8px;font-size:12px}
  .pill-btn{display:inline-flex;align-items:center;justify-content:center;min-width:88px;min-height:44px;height:34px;padding:0 12px;border-radius:10px;border:1px solid #3b2fff44;background:linear-gradient(180deg,#7a67ff,#5f48ff); color:#fff; font-weight:900; cursor:pointer;transition:transform .08s, background .12s; font-size:13px;text-transform:uppercase;}
  .pill-btn:hover{background:linear-gradient(180deg,#8a78ff,#6b54ff); transform:translateY(-1px)}

  /* ================== LAYOUT DEL REPORT ================== */
  .page{padding:26px 0}
  .card{background:linear-gradient(180deg,var(--surface),#0f1633);
    border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  h1,h2,h3{margin:0 0 8px 0}
  h1{font-size:1.25rem;font-weight:1000;letter-spacing:.2px}
  h2{font-size:1.02rem;font-weight:1000;color:#d6dcff}
  h3{font-size:.95rem;font-weight:1000;color:#cbd6ff}

  .header{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin-bottom:12px}
  .header .meta{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .badge{
    display:inline-flex;align-items:center;gap:8px;
    border:1px solid var(--stroke);background:var(--chip);
    border-radius:999px;padding:8px 12px;font-weight:900;line-height:1;
  }
  .badge.ok{border-color:#2e7a5a;background:#0f2d1f;color:#c9ffe6}
  .badge.bad{border-color:#7a2e38;background:#3a1518;color:#ffd4d4}
  .badge.warn{border-color:#b49422;background:#3a2e12;color:#ffe9b0}

  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--stroke);background:var(--surface2);color:var(--ink);
    border-radius:12px;padding:9px 12px;font-weight:900;cursor:pointer;text-decoration:none}
  .btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));border:0;color:#0c0f24}

  /* grid: izquierda estrecha */
  .grid{
    display:grid;
    grid-template-columns: 360px minmax(0,1fr);
    gap:12px;
  }
  @media (max-width:1020px){ .grid{ grid-template-columns:1fr } }

  /* KPIs 2x2 */
  .kpi-wrap{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media (max-width:520px){ .kpi-wrap{grid-template-columns:1fr} }
  .kpi{border:1px solid var(--stroke);border-radius:12px;background:linear-gradient(180deg,var(--surface2),#0f1430);padding:12px}
  .kpi h4{margin:0 0 4px 0;color:#9fb0ff;font-weight:900}
  .kpi .n{font-size:1.1rem;font-weight:1000}
  .small{font-size:.88rem;color:#aeb8ee}

  /* dominios */
  .domains table{width:100%;border-collapse:separate;border-spacing:0}
  .domains thead th{position:sticky;top:0;background:#151b3d;border:1px solid var(--stroke);padding:8px}
  .domains td{border:1px solid var(--stroke);padding:8px}
  .pbar{position:relative;height:8px;background:#0b1024;border-radius:999px;overflow:hidden}
  .pbar>i{position:absolute;inset:0 auto 0 0;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2))}

  .insights li{margin:4px 0}
  .empty{opacity:.8;padding:16px;text-align:center}

  /* filtros y preguntas */
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
  .tag{background:#10183a;border:1px solid var(--stroke);padding:8px 14px;border-radius:999px;color:#cbd6ff;font-weight:900;cursor:pointer;box-shadow:0 0 0 1px rgba(124,146,255,.12) inset}
  .tag.active{outline:2px solid rgba(124,146,255,.3)}

  .question{background:linear-gradient(180deg,#111937,#0f1633);border:1px solid var(--stroke);border-radius:14px;padding:12px;margin:12px 0}
  .qhead{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .qleft{display:flex;flex-direction:column;align-items:flex-start;gap:4px}
  .domain{font-weight:900;text-transform:uppercase;color:#9cc0ff}
  .qtitle{font-weight:700;font-size:0.94rem} /* m√°s fina */
  .opt{border:1px solid var(--stroke);background:#0f1730;border-radius:12px;padding:10px 12px;margin:8px 0;display:flex;gap:10px;align-items:flex-start}
  .opt.correct{border-color:#2e7a5a;background:#0f2d1f}
  .opt.chosen{outline:2px solid rgba(255,255,255,.08)}
  .opt.bad-chosen{border-color:#7a2e38;background:#3a1518}

  /* ================== FOOTER (copiado/compat) ================== */
  footer{border-top:1px solid var(--stroke);padding:24px 0;color:#9ca8d9;background:linear-gradient(180deg,rgba(22,27,45,.6),rgba(22,27,45,.2));margin-top:20px}
  .f-grid{display:grid;gap:14px}
  @media(min-width:720px){.f-grid{grid-template-columns:1.2fr .8fr .8fr .8fr}}
  footer a{color:#cfe1ff} footer a:hover{text-decoration:underline}

  /* Modal feedback (simplificado) */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:120;padding:16px}
  .modal.show{display:flex}
  .modal-card{width:min(760px,100%);background:var(--surface);border:1px solid var(--stroke);border-radius:14px;padding:18px;box-shadow:var(--shadow)}
  .modal-card h3{margin:0 0 12px;font-size:1.1rem}
  .modal-card textarea, .modal-card input{width:100%;border:1px solid var(--stroke);border-radius:10px;background:var(--surface2);color:var(--ink);padding:10px;font-weight:700}
  .fb-status{margin-top:8px;font-weight:800}
  .fb-status.ok{color:var(--ok)} .fb-status.err{color:var(--bad)} .fb-status.info{color:var(--muted)}
  </style>
</head>
<body>
  <!-- ===== CABECERA (copiada) ===== -->
  <header role="banner">
    <div class="container nav">
      <div class="brand">
        <img class="site-logo" src="/assets/ithub-logo.svg" alt="ITHub: inicio">
      </div>
      <nav class="menu" aria-label="Navegaci√≥n principal">
        <a class="link-btn" href="/#simuladores">SIMULADORES</a>
        <a class="link-btn" href="/content/content.html">CONTENIDOS</a>
        <a class="link-btn" href="/score/ranking.html">RANKING</a>
      </nav>
      <div class="authwrap" id="authWrap" aria-label="Acciones de sesi√≥n">
        <a id="btnLogin"  class="pill-btn" href="/login/login.html" role="button">LOGIN</a>
        <a id="btnSignup" class="pill-btn" href="/login/login.html#signup" role="button">REG√çSTRATE</a>
        <div id="userArea" style="display:none;align-items:center;gap:6px">
          <div class="hello">üëã <span id="userNameTop" style="font-weight:900">USER</span></div>
          <a class="pill-btn" href="/user/profile.html" role="button">PERFIL</a>
          <button id="btnLogout" class="pill-btn" type="button">LOGOUT</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== CONTENIDO: REPORT ===== -->
  <main id="main" class="page" tabindex="-1">
    <div id="noSid" class="container" hidden>
      <div class="card" style="border-style:dashed">
        ‚ÑπÔ∏è A√±ade <code>?sessionId=...</code> a la URL para ver el informe.
      </div>
    </div>

    <div id="app" class="container" hidden>
      <div class="card">
        <div class="header">
          <div>
            <h1 id="hTitle">Quiz Report</h1>
            <div class="meta">
              <span class="badge" id="hUser">‚Äî</span>
              <span class="badge" id="hQuiz">‚Äî</span>
              <span class="badge" id="hTime">‚Äî</span>
              <span class="badge" id="hState">‚Äî</span>
            </div>
          </div>
          <div class="actions">
            <button id="btnPrint" class="btn">üñ®Ô∏è Imprimir</button>
            <button id="btnDownload" class="btn primary">‚¨áÔ∏è Descargar JSON</button>
          </div>
        </div>

        <div class="grid">
          <!-- Izquierda -->
          <div class="card" style="padding:14px">
            <h2>Resumen</h2>
            <div class="kpi-wrap" style="margin-top:8px">
              <div class="kpi"><h4>Correctas / Total</h4><div class="n" id="kCorrect">‚Äî</div></div>
              <div class="kpi"><h4>Tiempo</h4><div class="n" id="kTime">‚Äî</div><div class="small">segundos</div></div>
              <div class="kpi"><h4>Aprobado</h4><div class="n" id="kPass">‚Äî</div><div class="small">Umbral 70%</div></div>
              <div class="kpi"><h4>Velocidad Media</h4><div class="n" id="kPq">‚Äî</div><div class="small">seg/preg.</div></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Insights</h3>
              <ul id="insights" class="insights" style="padding-left:18px;margin:6px 0 0 0"></ul>
            </div>
          </div>

          <!-- Derecha -->
          <div class="card" style="padding:14px">
            <h2>Desglose por dominio</h2>
            <div id="domains" class="domains" style="margin-top:8px"></div>

            <div class="toolbar" id="filters" hidden>
              <span class="tag active" data-f="all">Todas</span>
              <span class="tag" data-f="ok">Correctas</span>
              <span class="tag" data-f="bad">Incorrectas</span>
              <span class="tag" data-f="marked">Marcadas</span>
            </div>

            <div id="questions"></div>
            <div id="empty" class="empty" hidden>No hay preguntas para este filtro.</div>
          </div>
        </div>

        <div id="fallbackMsg" class="small" hidden style="margin-top:10px;opacity:.8">
          ‚ö†Ô∏è Esta sesi√≥n no contiene <code>questions</code>. El informe se reconstruy√≥ con <code>questionBank</code> y <code>answerItems</code>.
        </div>
      </div>
    </div>
  </main>

  <!-- ===== FOOTER (copiado) ===== -->
  <footer role="contentinfo">
    <div class="container f-grid">
      <div>
        <div class="brand" style="text-transform:none">
          <span class="logo-pill" aria-hidden="true" style="width:18px;height:34px;border-radius:10px;background:linear-gradient(180deg,#8aa0ff 0%,#425dff 100%);box-shadow:0 0 0 6px rgba(108,139,255,.18)"></span>
          <span>ITHUB.ES</span>
        </div>
        <p style="margin:8px 0 0;">Aprende, practica y aprueba tus certificaciones IT mientras compites con el resto del mundo.</p>
      </div>
      <div>
        <div style="font-weight:800">SIMULADORES</div>
        <div><a href="/certification/microsoft-azure/az-104/lz-azure-az-104.html">MICROSOFT AZURE AZ-104</a></div>
        <div><a href="/certification/microsoft-azure/az-305/lz-azure-az-305.html">MICROSOFT AZURE AZ-305</a></div>
        <div><a href="/certification/amazon aws/aws-saa-c03/lz-aws-saa-c03.html">AMAZON AWS SAA-C03</a></div>
      </div>
      <div>
        <div style="font-weight:800">DESTACADOS</div>
        <div><a href="/content/azure-identity-az104.html">Azure ¬∑ Identidad y Acceso</a></div>
        <div><a href="/content/azure-network-security-az104.html">Azure ¬∑ Seguridad en la red</a></div>
        <div><a href="/content/azure-cost-governance-az104.html">Azure ¬∑ Coste y Gobernanza</a></div>
        <div><a href="/content/azure-landing-zone.html">Azure ¬∑ Landing Zone</a></div>
      </div>
      <div>
        <div style="font-weight:800">CONTACTO</div>
        <button id="footerContactBtn" type="button"
                style="background:none;border:none;color:#cfe1ff;font-weight:800;display:inline-flex;align-items:center;gap:6px;cursor:pointer;padding:0;margin-top:6px;">
          üí¨ <span>Cont√°ctanos</span>
        </button>
      </div>
    </div>
    <div class="container" style="margin-top:12px;font-size:12px;">¬© <span id="y"></span> ITHub.es</div>
  </footer>

  <!-- Modal Feedback (simplificado) -->
  <div class="modal" id="feedbackModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="fbTitle">
    <div class="modal-card" role="document" tabindex="-1">
      <h3 id="fbTitle">üí¨ ENVIAR FEEDBACK</h3>
      <input id="feedbackEmail" type="email" placeholder="Tu email (opcional)">
      <textarea id="feedbackText" rows="5" placeholder="Escribe aqu√≠ tu sugerencia‚Ä¶"></textarea>
      <div id="fbStatus" class="fb-status" aria-live="polite"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn" id="btnCancelFeedback" type="button">CANCELAR</button>
        <button class="pill-btn" id="btnSendFeedback" type="button">ENVIAR</button>
        <button class="pill-btn" id="btnOkFeedback" type="button" style="display:none">ACEPTAR</button>
      </div>
    </div>
  </div>

  <script>
  /* ======= Utils ======= */
  const qs = n => new URLSearchParams(location.search).get(n) || "";
  const el = id => document.getElementById(id);
  const letter = i => String.fromCharCode(65 + (i||0));

  /* ======= Header auth (mismo comportamiento b√°sico) ======= */
  function getCurrentUser(){ try{ return JSON.parse(localStorage.getItem("currentUser")||"null"); }catch{ return null; } }
  function renderHeaderAuth(){
    const u=getCurrentUser();
    const login=el('btnLogin');
    const signup=el('btnSignup');
    const userArea=el('userArea');
    const nameTop=el('userNameTop');
    if(u){ login.style.display='none'; signup.style.display='none'; userArea.style.display='flex'; nameTop.textContent=(u.name||u.email||'USER').toUpperCase(); }
    else{ login.style.display='inline-flex'; signup.style.display='inline-flex'; userArea.style.display='none'; }
  }
  el('btnLogout')?.addEventListener('click', ()=>{ localStorage.removeItem('currentUser'); renderHeaderAuth(); });
  renderHeaderAuth();

  /* ======= Data fetch ======= */
  const BASE = "https://uougu1cm26.execute-api.eu-central-1.amazonaws.com";
  async function fetchSession(sessionId){
    const paths = ["/progress","/prod/progress","/dev/progress"];
    for (const p of paths){
      const url = `${BASE}${p}?sessionId=${encodeURIComponent(sessionId)}`;
      try{
        const r = await fetch(url, {mode:"cors",cache:"no-store"});
        if(r.ok){ const j = await r.json(); if (j && j.item) return j.item; }
      }catch(e){}
    }
    throw new Error("No se pudo obtener la sesi√≥n.");
  }

  /* ======= Normalizar preguntas ======= */
  function normalizeQuestions(item){
    if (Array.isArray(item.questions) && item.questions.length)
      return {questions:item.questions.slice(), rebuilt:false};

    const bank = Array.isArray(item.questionBank)? item.questionBank: [];
    const answers = Array.isArray(item.answerItems)? item.answerItems: [];
    const byBank=new Map(), byAns=new Map();
    bank.forEach(b=>{ if(typeof b.index==='number') byBank.set(b.index,b); });
    answers.forEach(a=>{ if(typeof a.index==='number') byAns.set(a.index,a); });
    const idxs = new Set([...byBank.keys(), ...byAns.keys()]);
    if(!idxs.size){
      const ids = Array.isArray(item.questionIds)? item.questionIds: [];
      const qs = ids.map((qid,i)=>{
        const a=byAns.get(i)||{}, chosen=(typeof a.chosenIndex==='number')?a.chosenIndex:null;
        const correctShownIndex=(typeof a.isCorrect==='boolean'&&typeof chosen==='number')?(a.isCorrect?chosen:null):null;
        return { index:i, questionId:qid, questionText:"(texto no disponible)", domain:a.domain||null, category:a.category||"General",
                 optionsShown:[], correctShownIndex, chosenIndex:chosen, isCorrect:(typeof a.isCorrect==='boolean')?a.isCorrect:null };
      });
      return {questions:qs, rebuilt:true};
    }
    const out=[];
    [...idxs].sort((a,b)=>a-b).forEach(i=>{
      const b=byBank.get(i)||{}, a=byAns.get(i)||{};
      const opts=Array.isArray(b.optionsShown)?b.optionsShown.slice():Array.isArray(b.options)?b.options.slice():[];
      const cor=(typeof b.correctShownIndex==='number')?b.correctShownIndex:null;
      const chosen=(typeof a.chosenIndex==='number')?a.chosenIndex:null;
      let ok=null; if(typeof a.isCorrect==='boolean') ok=a.isCorrect; else if(chosen!=null&&cor!=null) ok=(chosen===cor);
      out.push({ index:i, questionId:b.questionId||a.questionId||null, questionText:b.questionText||a.questionText||"(texto no disponible)",
                 domain:b.domain||a.domain||null, category:b.category||a.category||"General", optionsShown:opts,
                 correctShownIndex:cor, chosenIndex:chosen, isCorrect:ok });
    });
    return {questions:out, rebuilt:true};
  }

  /* ======= UI helpers ======= */
  function buildDomainsTable(questions){
    const host = el("domains"); host.innerHTML="";
    if(!questions.length){ host.innerHTML='<div class="empty">Sin datos</div>'; return {}; }
    const m={};
    for(const q of questions){
      const key=(q.domain||"D?").toString();
      if(!m[key]) m[key]={domain:key,total:0,correct:0,name:q.category||"GENERAL"};
      m[key].total++; if(q.isCorrect) m[key].correct++;
    }
    const rows=Object.values(m).sort((a,b)=> a.domain.localeCompare(b.domain));
    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr><th>Dominio</th><th>Nombre</th><th>Aciertos</th><th>Total</th><th>%</th></tr></thead>`;
    const tb=document.createElement('tbody');
    rows.forEach(r=>{
      const pct=r.total?Math.round(r.correct*100/r.total):0;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><b>${r.domain}</b></td><td>${(r.name||'').toUpperCase()}</td><td>${r.correct}</td><td>${r.total}</td>
                    <td>${pct}% <div class="pbar"><i style="width:${pct}%"></i></div></td>`;
      tb.appendChild(tr);
    });
    tbl.appendChild(tb); host.appendChild(tbl); return m;
  }

  function renderQuestions(questions,item,filter="all"){
    const root=el("questions"); root.innerHTML=""; const empty=el("empty");
    let list=questions.slice();
    if(filter==="ok") list=list.filter(q=>q.isCorrect===true);
    if(filter==="bad") list=list.filter(q=>q.isCorrect===false);
    if(filter==="marked"){
      const marked=new Set(
        Array.isArray(item.markedItems)?item.markedItems.map(x=>x.index):
        Object.entries(item.marked||{}).filter(([i,v])=>v).map(([i])=>+i)
      );
      list=list.filter(q=>marked.has(q.index));
    }
    if(!list.length){ empty.hidden=false; return; } empty.hidden=true;

    list.forEach(q=>{
      const box=document.createElement('section'); box.className='question';
      const head=document.createElement('div'); head.className='qhead';
      const left=document.createElement('div'); left.className='qleft';
      const d=document.createElement('div'); d.className='domain';
      d.textContent=(q.category||"GENERAL")+(q.domain?` (${q.domain})`:"");
      const t=document.createElement('div'); t.className='qtitle';
      t.textContent=`${(q.index!=null?q.index+1:"‚Äî")}. ${q.questionText||"(texto no disponible)"}`;
      left.appendChild(d); left.appendChild(t);

      const badge=document.createElement('span');
      let cls="badge ",txt="‚Ä¢ Sin responder";
      if(q.isCorrect===true){cls+="ok";txt="Correcta";}
      else if(q.isCorrect===false&&q.chosenIndex!=null){cls+="bad";txt="Incorrecta";}
      else {cls+="warn";txt="Sin responder";}
      badge.className=cls; badge.textContent=txt;

      head.appendChild(left); head.appendChild(badge); box.appendChild(head);

      const opts=Array.isArray(q.optionsShown)?q.optionsShown:[];
      if(!opts.length){
        const warn=document.createElement('div'); warn.className='small'; warn.textContent="Opciones no disponibles en esta sesi√≥n."; box.appendChild(warn);
      }
      opts.forEach((txt,i)=>{
        const line=document.createElement('div'); line.className='opt';
        const chosen=(q.chosenIndex===i), cor=(q.correctShownIndex===i);
        if(cor) line.classList.add('correct'); if(chosen) line.classList.add('chosen'); if(chosen&&!cor) line.classList.add('bad-chosen');
        line.innerHTML=`<b>${letter(i)}.</b> <span>${txt}</span>`; box.appendChild(line);
      });

      root.appendChild(box);
    });
  }

  function buildInsights(item,questions,domainMap){
    const total=questions.length, correct=questions.reduce((a,q)=>a+(q.isCorrect?1:0),0);
    const pct= total? Math.round(correct*100/total): (+item.pct||0);
    const secs=+item.elapsedSec||0, spq= total? Math.round(secs/total):0;
    const rows=Object.values(domainMap); let best=null,worst=null;
    rows.forEach(r=>{const p=r.total?Math.round(r.correct*100/r.total):0; const rec={...r,pct:p}; if(!best||p>best.pct) best=rec; if(!worst||p<worst.pct) worst=rec;});
    const list=[];
    if(pct>=70) list.push(`<span>‚úÖ Buen trabajo: resultado global ${pct}%.</span>`);
    else list.push(`<span>üéØ Objetivo: alcanza ‚â•70% (actual ${pct}%).</span>`);
    if(worst) list.push(`<span>üõ†Ô∏è Mejora: <b>${(worst.name||'').toUpperCase()}</b> (${worst.domain}) ¬∑ ${worst.pct}% (${worst.correct}/${worst.total}).</span>`);
    if(best&&best!==worst) list.push(`<span>üèÖ Fortaleza: <b>${(best.name||'').toUpperCase()}</b> (${best.domain}) ¬∑ ${best.pct}% (${best.correct}/${best.total}).</span>`);
    if(spq){ const tip = spq>45?"Ve con calma y usa eliminaci√≥n de opciones.": spq<15?"Buen ritmo; evita errores por prisa.":"Ritmo equilibrado."; list.push(`<span>‚è±Ô∏è ${spq} seg/preg. ${tip}</span>`); }
    const wrong=questions.filter(q=>q.isCorrect===false).length;
    const marked=Array.isArray(item.markedItems)?item.markedItems.length:Object.values(item.marked||{}).filter(Boolean).length;
    if(wrong||marked) list.push(`<span>üìò Revisi√≥n: ${wrong} incorrectas${marked?`, ${marked} marcadas`:''}.</span>`);
    el("insights").innerHTML=list.map(x=>`<li>${x}</li>`).join("");
  }

  /* ======= main ======= */
  async function loadReport(sessionId){
    const app=el("app"); const noSid=el("noSid");
    try{
      const item=await fetchSession(sessionId);
      const {questions,rebuilt}=normalizeQuestions(item);

      el("hTitle").textContent=`Resultado ¬∑ ${String(item.quizId||'').toUpperCase()}`;
      el("hUser").textContent=`${item.userName||item.userId||'Usuario'} (${item.email||'‚Äî'})`;
      el("hQuiz").textContent=`${item.track||'-'} ¬∑ ${item.mode||'-'}`;
      el("hTime").textContent=`${(+item.elapsedSec||0)} seg`;
      el("hState").textContent=item.finished?"Finalizado":(item.status||"in_progress");

      const total=questions.length, correct=questions.reduce((a,q)=>a+(q.isCorrect?1:0),0);
      const pct= total? Math.round(correct*100/total): (+item.pct||0);
      el("kCorrect").textContent=`${correct}/${total}`;
      el("kTime").textContent= String(+item.elapsedSec || 0);
      el("kPass").textContent=pct>=70?"S√≠":"No";
      el("kPq").textContent= total? Math.round((+item.elapsedSec||0)/total):0;

      const domains=buildDomainsTable(questions);
      buildInsights(item,questions,domains);

      el("filters").hidden=false;
      document.querySelectorAll('#filters .tag').forEach(t=>{
        t.onclick=()=>{ document.querySelectorAll('#filters .tag').forEach(x=>x.classList.remove('active')); t.classList.add('active'); renderQuestions(questions,item,t.dataset.f); };
      });
      renderQuestions(questions,item,"all");

      el("btnPrint").onclick=()=>window.print();
      el("btnDownload").onclick=()=>{ const blob=new Blob([JSON.stringify(item,null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`quizSession-${sessionId}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); };
      if(rebuilt) el("fallbackMsg").hidden=false;

      noSid.hidden=true; app.hidden=false;
    }catch(e){
      console.error(e);
      noSid.hidden=false; app.hidden=true;
    }
  }

  // Footer year
  el('y').textContent = new Date().getFullYear();

  // Feedback modal
  const fbModal = el('feedbackModal');
  const fbEmail = el('feedbackEmail');
  const fbText  = el('feedbackText');
  const fbStatus= el('fbStatus');
  function openFeedbackModal(){
    fbEmail.value=''; fbText.value=''; fbStatus.textContent=''; fbStatus.className='fb-status';
    el('btnSendFeedback').style.display=''; el('btnCancelFeedback').style.display=''; el('btnOkFeedback').style.display='none';
    fbModal.classList.add('show'); fbModal.setAttribute('aria-hidden','false');
  }
  function closeFeedback(){ fbModal.classList.remove('show'); fbModal.setAttribute('aria-hidden','true'); }
  el('footerContactBtn')?.addEventListener('click', openFeedbackModal);
  el('btnCancelFeedback')?.addEventListener('click', closeFeedback);
  fbModal.addEventListener('click', e=>{ if(e.target===fbModal) closeFeedback(); });
  el('btnOkFeedback')?.addEventListener('click', closeFeedback);

  // Env√≠o feedback (misma API /items)
  const API_BASE = 'https://uougu1cm26.execute-api.eu-central-1.amazonaws.com';
  const NOTES_ENDPOINT = `${API_BASE}/items`;
  el('btnSendFeedback')?.addEventListener('click', async ()=>{
    const message=(fbText.value||'').trim(); const from=(fbEmail.value||'').trim();
    if(!message){ fbStatus.textContent='Por favor, escribe tu sugerencia.'; fbStatus.className='fb-status err'; return; }
    fbStatus.textContent='Enviando‚Ä¶'; fbStatus.className='fb-status info';
    const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ('note_' + Date.now());
    const params = new URLSearchParams();
    params.set('table','notes'); params.set('id', id);
    params.set('content', JSON.stringify({ id, type:'feedback', title:'Feedback Report', message, email:from || null, path:location.pathname+location.search, createdAt:new Date().toISOString() }));
    try{
      const res = await fetch(NOTES_ENDPOINT, { method:'POST', body:params });
      if(!res.ok) throw new Error('HTTP '+res.status);
      fbStatus.textContent='¬°Gracias! Mensaje recibido üëå'; fbStatus.className='fb-status ok';
      el('btnSendFeedback').style.display='none'; el('btnCancelFeedback').style.display='none'; el('btnOkFeedback').style.display='';
    }catch(err){
      fbStatus.textContent='No se pudo enviar la info.'; fbStatus.className='fb-status err';
      el('btnSendFeedback').style.display='none'; el('btnCancelFeedback').style.display='none'; el('btnOkFeedback').style.display='';
    }
  });

  // Cargar directamente por ?sessionId=
  window.addEventListener('DOMContentLoaded', ()=>{
    const sid = qs('sessionId');
    if (!sid){ el('noSid').hidden = false; return; }
    loadReport(sid);
  });
  </script>
</body>
</html>
