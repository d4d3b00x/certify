<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz Report ¬∑ IT Hub</title>
<style>
:root{
  --bg:#0b1022; --surface:#121833; --surface2:#151c3e; --ink:#e9edff; --muted:#9ca8d9; --stroke:#2a325b;
  --accent:#78a0ff; --accent-2:#6a7cff; --ok:#2bdc8c; --bad:#ff6b6b; --warn:#ffd24d;
  --chip:#0f1734; --shadow:0 14px 38px rgba(5,8,30,.45); --radius:16px;
}
*{box-sizing:border-box}
html{font-size:15px}
body{
  margin:0;
  background:
    radial-gradient(900px 420px at 15% -10%, #121a42 0, transparent 60%),
    radial-gradient(900px 420px at 85% -10%, #1a1434 0, transparent 60%),
    linear-gradient(180deg,#0c122a,#0b0f22) fixed;
  color:var(--ink);
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
}
.container{max-width:1200px;margin:28px auto;padding:0 16px}
.card{background:linear-gradient(180deg,var(--surface),#0f1633);
  border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
h1,h2,h3{margin:0 0 8px 0}
h1{font-size:1.35rem;font-weight:1000;letter-spacing:.2px}
h2{font-size:1.05rem;font-weight:1000;color:#d6dcff}
h3{font-size:.95rem;font-weight:1000;color:#cbd6ff}

.header{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin-bottom:12px}
.header .meta{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.badge{
  display:inline-flex;align-items:center;gap:8px;
  border:1px solid var(--stroke);background:var(--chip);
  border-radius:999px;padding:8px 12px;font-weight:900;line-height:1;
}
.badge.ok{border-color:#2e7a5a;background:#0f2d1f;color:#c9ffe6}
.badge.bad{border-color:#7a2e38;background:#3a1518;color:#ffd4d4}
.badge.warn{border-color:#b49422;background:#3a2e12;color:#ffe9b0}
.badge.ok::before{content:"‚úì"; font-weight:900}
.badge.bad::before{content:"‚úó"; font-weight:900}
.badge.warn::before{content:"‚Ä¢"; font-weight:900}

.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--stroke);background:var(--surface2);color:var(--ink);
  border-radius:12px;padding:9px 12px;font-weight:900;cursor:pointer;text-decoration:none}
.btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));border:0;color:#0c0f24}

/* ====== NUEVO LAYOUT: izquierda estrecha ====== */
.grid{
  display:grid;
  grid-template-columns: 380px minmax(0,1fr); /* izquierda m√°s estrecha */
  gap:12px;
}
@media (max-width:1020px){
  .grid{ grid-template-columns:1fr; }
}

/* KPIs: siempre 2x2 en escritorio */
.kpi-wrap{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media (max-width:520px){ .kpi-wrap{grid-template-columns:1fr} }
.kpi{border:1px solid var(--stroke);border-radius:12px;background:linear-gradient(180deg,var(--surface2),#0f1430);padding:12px}
.kpi h4{margin:0 0 4px 0;color:#9fb0ff;font-weight:900}
.kpi .n{font-size:1.2rem;font-weight:1000}
.small{font-size:.88rem;color:#aeb8ee}

/* Tabla dominios */
.domains table{width:100%;border-collapse:separate;border-spacing:0}
.domains thead th{position:sticky;top:0;background:#151b3d;border:1px solid var(--stroke);padding:8px}
.domains td{border:1px solid var(--stroke);padding:8px}
.pbar{position:relative;height:8px;background:#0b1024;border-radius:999px;overflow:hidden}
.pbar>i{position:absolute;inset:0 auto 0 0;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2))}

.insights li{margin:4px 0}
.empty{opacity:.8;padding:16px;text-align:center}

/* Filtros + preguntas */
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.tag{background:#10183a;border:1px solid var(--stroke);padding:6px 10px;border-radius:999px;color:#cbd6ff;font-weight:900;cursor:pointer}
.tag.active{outline:2px solid rgba(124,146,255,.25)}

.question{background:linear-gradient(180deg,#111937,#0f1633);border:1px solid var(--stroke);border-radius:14px;padding:12px;margin:12px 0}
.qhead{display:flex;align-items:center;justify-content:space-between;gap:10px}
.qleft{display:flex;flex-direction:column;align-items:flex-start;gap:4px}
.domain{font-weight:900;text-transform:uppercase;color:#9cc0ff}
/* ‚Üì M√ÅS FINA y algo m√°s peque√±a que antes */
.qtitle{font-weight:700;font-size:0.96rem}
.opt{border:1px solid var(--stroke);background:#0f1730;border-radius:12px;padding:10px 12px;margin:8px 0;display:flex;gap:10px;align-items:flex-start}
.opt.correct{border-color:#2e7a5a;background:#0f2d1f}
.opt.chosen{outline:2px solid rgba(255,255,255,.08)}
.opt.bad-chosen{border-color:#7a2e38;background:#3a1518}

.note{max-width:1200px;margin:20px auto;padding:0 16px}
.note .msg{border:1px dashed var(--stroke);background:rgba(20,26,56,.5);padding:12px;border-radius:12px;color:#cbd6ff}
</style>
</head>
<body>

<div id="noSid" class="note" hidden>
  <div class="msg">‚ÑπÔ∏è A√±ade <code>?sessionId=...</code> a la URL para ver el informe.</div>
</div>

<div id="app" class="container" hidden>
  <div class="card">
    <div class="header">
      <div>
        <h1 id="hTitle">Quiz Report</h1>
        <div class="meta">
          <span class="badge" id="hUser">‚Äî</span>
          <span class="badge" id="hQuiz">‚Äî</span>
          <span class="badge" id="hTime">‚Äî</span>
          <span class="badge" id="hState">‚Äî</span>
        </div>
      </div>
      <div class="actions">
        <button id="btnPrint" class="btn">üñ®Ô∏è Imprimir</button>
        <button id="btnDownload" class="btn primary">‚¨áÔ∏è Descargar JSON</button>
      </div>
    </div>

    <div class="grid">
      <!-- ===== Izquierda (estrecha) ===== -->
      <div class="card" style="padding:14px">
        <h2>Resumen</h2>
        <div class="kpi-wrap" style="margin-top:8px">
          <div class="kpi"><h4>Correctas / Total</h4><div class="n" id="kCorrect">‚Äî</div></div>
          <div class="kpi"><h4>Tiempo</h4><div class="n" id="kTime">‚Äî</div><div class="small">segundos</div></div>
          <div class="kpi"><h4>Aprobado</h4><div class="n" id="kPass">‚Äî</div><div class="small">Umbral 70%</div></div>
          <div class="kpi"><h4>Velocidad Media</h4><div class="n" id="kPq">‚Äî</div><div class="small">seg/preg.</div></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Insights</h3>
          <ul id="insights" class="insights" style="padding-left:18px;margin:6px 0 0 0"></ul>
        </div>
      </div>

      <!-- ===== Derecha (ancha) ===== -->
      <div class="card" style="padding:14px">
        <h2>Desglose por dominio</h2>
        <div id="domains" class="domains" style="margin-top:8px"></div>

        <div class="toolbar" id="filters" hidden>
          <span class="tag active" data-f="all">Todas</span>
          <span class="tag" data-f="ok">Correctas</span>
          <span class="tag" data-f="bad">Incorrectas</span>
          <span class="tag" data-f="marked">Marcadas</span>
        </div>

        <div id="questions"></div>
        <div id="empty" class="empty" hidden>No hay preguntas para este filtro.</div>
      </div>
    </div>

    <div id="fallbackMsg" class="small" hidden style="margin-top:10px;opacity:.8">
      ‚ö†Ô∏è Esta sesi√≥n no contiene <code>questions</code>. El informe se reconstruy√≥ con <code>questionBank</code> y <code>answerItems</code>.
    </div>
  </div>
</div>

<script>
const BASE = "https://uougu1cm26.execute-api.eu-central-1.amazonaws.com";

/* ==== utils ==== */
const qs = (n)=> new URLSearchParams(location.search).get(n)||"";
const el = (id)=> document.getElementById(id);
const letter = (i)=> String.fromCharCode(65 + (i||0));

/* ==== fetch ==== */
async function fetchSession(sessionId){
  const paths = ["/progress","/prod/progress","/dev/progress"];
  for (const p of paths){
    const url = `${BASE}${p}?sessionId=${encodeURIComponent(sessionId)}`;
    try{
      const r = await fetch(url, {mode:"cors",cache:"no-store"});
      if(r.ok){
        const j = await r.json();
        if (j && j.item) return j.item;
      }
    }catch(e){}
  }
  throw new Error("No se pudo obtener la sesi√≥n.");
}

/* ==== normalize ==== */
function normalizeQuestions(item){
  if (Array.isArray(item.questions) && item.questions.length){
    return {questions:item.questions.slice(), rebuilt:false};
  }
  const bank = Array.isArray(item.questionBank)? item.questionBank: [];
  const answers = Array.isArray(item.answerItems)? item.answerItems: [];
  const byBank=new Map(), byAns=new Map();
  bank.forEach(b=>{ if(typeof b.index==='number') byBank.set(b.index,b); });
  answers.forEach(a=>{ if(typeof a.index==='number') byAns.set(a.index,a); });
  const idxs = new Set([...byBank.keys(), ...byAns.keys()]);
  if(!idxs.size){
    const ids = Array.isArray(item.questionIds)? item.questionIds: [];
    const qs = ids.map((qid,i)=>{
      const a=byAns.get(i)||{}, chosen=(typeof a.chosenIndex==='number')?a.chosenIndex:null;
      const correctShownIndex=(typeof a.isCorrect==='boolean'&&typeof chosen==='number')?(a.isCorrect?chosen:null):null;
      return { index:i, questionId:qid, questionText:"(texto no disponible)", domain:a.domain||null, category:a.category||"General",
               optionsShown:[], correctShownIndex, chosenIndex:chosen, isCorrect:(typeof a.isCorrect==='boolean')?a.isCorrect:null };
    });
    return {questions:qs, rebuilt:true};
  }
  const out=[];
  [...idxs].sort((a,b)=>a-b).forEach(i=>{
    const b=byBank.get(i)||{}, a=byAns.get(i)||{};
    const opts=Array.isArray(b.optionsShown)?b.optionsShown.slice():Array.isArray(b.options)?b.options.slice():[];
    const cor=(typeof b.correctShownIndex==='number')?b.correctShownIndex:null;
    const chosen=(typeof a.chosenIndex==='number')?a.chosenIndex:null;
    let ok=null; if(typeof a.isCorrect==='boolean') ok=a.isCorrect; else if(chosen!=null&&cor!=null) ok=(chosen===cor);
    out.push({ index:i, questionId:b.questionId||a.questionId||null, questionText:b.questionText||a.questionText||"(texto no disponible)",
               domain:b.domain||a.domain||null, category:b.category||a.category||"General", optionsShown:opts,
               correctShownIndex:cor, chosenIndex:chosen, isCorrect:ok });
  });
  return {questions:out, rebuilt:true};
}

/* ==== UI helpers ==== */
function buildDomainsTable(questions){
  const host = el("domains"); host.innerHTML="";
  if(!questions.length){ host.innerHTML='<div class="empty">Sin datos</div>'; return {}; }
  const m={};
  for(const q of questions){
    const key=(q.domain||"D?").toString();
    if(!m[key]) m[key]={domain:key,total:0,correct:0,name:q.category||"GENERAL"};
    m[key].total++; if(q.isCorrect) m[key].correct++;
  }
  const rows=Object.values(m).sort((a,b)=> a.domain.localeCompare(b.domain));
  const tbl=document.createElement('table');
  tbl.innerHTML=`<thead><tr><th>Dominio</th><th>Nombre</th><th>Aciertos</th><th>Total</th><th>%</th></tr></thead>`;
  const tb=document.createElement('tbody');
  rows.forEach(r=>{
    const pct=r.total?Math.round(r.correct*100/r.total):0;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><b>${r.domain}</b></td><td>${(r.name||'').toUpperCase()}</td><td>${r.correct}</td><td>${r.total}</td>
                  <td>${pct}% <div class="pbar"><i style="width:${pct}%"></i></div></td>`;
    tb.appendChild(tr);
  });
  tbl.appendChild(tb); host.appendChild(tbl); return m;
}

function renderQuestions(questions,item,filter="all"){
  const root=el("questions"); root.innerHTML=""; const empty=el("empty");
  let list=questions.slice();
  if(filter==="ok") list=list.filter(q=>q.isCorrect===true);
  if(filter==="bad") list=list.filter(q=>q.isCorrect===false);
  if(filter==="marked"){
    const marked=new Set(
      Array.isArray(item.markedItems)?item.markedItems.map(x=>x.index):
      Object.entries(item.marked||{}).filter(([i,v])=>v).map(([i])=>+i)
    );
    list=list.filter(q=>marked.has(q.index));
  }
  if(!list.length){ empty.hidden=false; return; } empty.hidden=true;

  list.forEach(q=>{
    const box=document.createElement('section'); box.className='question';
    const head=document.createElement('div'); head.className='qhead';
    const left=document.createElement('div'); left.className='qleft';
    const d=document.createElement('div'); d.className='domain';
    d.textContent=(q.category||"GENERAL")+(q.domain?` (${q.domain})`:"");
    const t=document.createElement('div'); t.className='qtitle';
    t.textContent=`${(q.index!=null?q.index+1:"‚Äî")}. ${q.questionText||"(texto no disponible)"}`;
    left.appendChild(d); left.appendChild(t);

    const badge=document.createElement('span');
    let cls="badge ",txt="‚Ä¢ Sin responder";
    if(q.isCorrect===true){cls+="ok";txt="Correcta";}
    else if(q.isCorrect===false&&q.chosenIndex!=null){cls+="bad";txt="Incorrecta";}
    else {cls+="warn";txt="Sin responder";}
    badge.className=cls; badge.textContent=txt;

    head.appendChild(left); head.appendChild(badge); box.appendChild(head);

    const opts=Array.isArray(q.optionsShown)?q.optionsShown:[];
    if(!opts.length){
      const warn=document.createElement('div'); warn.className='small'; warn.textContent="Opciones no disponibles en esta sesi√≥n."; box.appendChild(warn);
    }
    opts.forEach((txt,i)=>{
      const line=document.createElement('div'); line.className='opt';
      const chosen=(q.chosenIndex===i), cor=(q.correctShownIndex===i);
      if(cor) line.classList.add('correct'); if(chosen) line.classList.add('chosen'); if(chosen&&!cor) line.classList.add('bad-chosen');
      line.innerHTML=`<b>${letter(i)}.</b> <span>${txt}</span>`; box.appendChild(line);
    });

    root.appendChild(box);
  });
}

function buildInsights(item,questions,domainMap){
  const total=questions.length, correct=questions.reduce((a,q)=>a+(q.isCorrect?1:0),0);
  const pct= total? Math.round(correct*100/total): (+item.pct||0);
  const secs=+item.elapsedSec||0, spq= total? Math.round(secs/total):0;
  const rows=Object.values(domainMap); let best=null,worst=null;
  rows.forEach(r=>{const p=r.total?Math.round(r.correct*100/r.total):0; const rec={...r,pct:p}; if(!best||p>best.pct) best=rec; if(!worst||p<worst.pct) worst=rec;});
  const list=[];
  if(pct>=70) list.push(`<span>‚úÖ Buen trabajo: resultado global ${pct}%.</span>`);
  else list.push(`<span>üéØ Objetivo: alcanza ‚â•70% (actual ${pct}%).</span>`);
  if(worst) list.push(`<span>üõ†Ô∏è Mejora: <b>${(worst.name||'').toUpperCase()}</b> (${worst.domain}) ¬∑ ${worst.pct}% (${worst.correct}/${worst.total}).</span>`);
  if(best&&best!==worst) list.push(`<span>üèÖ Fortaleza: <b>${(best.name||'').toUpperCase()}</b> (${best.domain}) ¬∑ ${best.pct}% (${best.correct}/${best.total}).</span>`);
  if(spq){ const tip = spq>45?"Ve con calma y usa eliminaci√≥n de opciones.": spq<15?"Buen ritmo; evita errores por prisa.":"Ritmo equilibrado."; list.push(`<span>‚è±Ô∏è ${spq} seg/preg. ${tip}</span>`); }
  const wrong=questions.filter(q=>q.isCorrect===false).length;
  const marked=Array.isArray(item.markedItems)?item.markedItems.length:Object.values(item.marked||{}).filter(Boolean).length;
  if(wrong||marked) list.push(`<span>üìò Revisi√≥n: ${wrong} incorrectas${marked?`, ${marked} marcadas`:''}.</span>`);
  el("insights").innerHTML=list.map(x=>`<li>${x}</li>`).join("");
}

/* ==== main ==== */
async function loadReport(sessionId){
  const app=el("app"); const noSid=el("noSid");
  try{
    const item=await fetchSession(sessionId);
    const {questions,rebuilt}=normalizeQuestions(item);

    el("hTitle").textContent=`Resultado ¬∑ ${String(item.quizId||'').toUpperCase()}`;
    el("hUser").textContent=`${item.userName||item.userId||'Usuario'} (${item.email||'‚Äî'})`;
    el("hQuiz").textContent=`${item.track||'-'} ¬∑ ${item.mode||'-'}`;
    el("hTime").textContent=`${(+item.elapsedSec||0)} seg`;   /* s√≥lo segundos */
    el("hState").textContent=item.finished?"Finalizado":(item.status||"in_progress");

    const total=questions.length, correct=questions.reduce((a,q)=>a+(q.isCorrect?1:0),0);
    const pct= total? Math.round(correct*100/total): (+item.pct||0);
    el("kCorrect").textContent=`${correct}/${total}`;
    el("kTime").textContent= String(+item.elapsedSec || 0);
    el("kPass").textContent=pct>=70?"S√≠":"No";
    el("kPq").textContent= total? Math.round((+item.elapsedSec||0)/total):0;

    const domains=buildDomainsTable(questions);
    buildInsights(item,questions,domains);

    el("filters").hidden=false;
    document.querySelectorAll('#filters .tag').forEach(t=>{
      t.onclick=()=>{ document.querySelectorAll('#filters .tag').forEach(x=>x.classList.remove('active')); t.classList.add('active'); renderQuestions(questions,item,t.dataset.f); };
    });
    renderQuestions(questions,item,"all");

    el("btnPrint").onclick=()=>window.print();
    el("btnDownload").onclick=()=>{ const blob=new Blob([JSON.stringify(item,null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`quizSession-${sessionId}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); };
    if(rebuilt) el("fallbackMsg").hidden=false;

    noSid.hidden=true; app.hidden=false;
  }catch(e){
    console.error(e);
    noSid.hidden=false; app.hidden=true;
  }
}

window.addEventListener('DOMContentLoaded', ()=>{
  const sid = qs('sessionId');
  if (!sid){ el('noSid').hidden = false; return; }
  loadReport(sid);
});
</script>
</body>
</html>
