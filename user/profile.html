<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DYZ3GCXHEK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-DYZ3GCXHEK');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CertiFY ‚Äî Quizzers Profile</title>

  <style>
    :root{
      /* Paleta oscura compartida */
      --bg:#0f1320; --surface:#161b2d; --surface2:#1b2140; --card:#111937;
      --ink:#e8ecff; --muted:#9ca8d9; --stroke:#283056; --shadow:0 12px 28px rgba(6,12,40,.45);
      --radius:16px;

      /* Acentos (naranja por defecto, azul cuando se necesite) */
      --accent:#ff9900; --accent-2:#ffb84d; --accent-ring:rgba(255,153,0,.28);
      --accent-az:#0078d4; --accent-az-2:#5fb3ff;

      --ok:#25b873; --ok-ink:#b9f4d6; --ok-bg:#0e1f1a;
      --danger:#ff6b6b; --gap:12px;
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Helvetica Neue","Noto Sans",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 520px at 12% -10%, #101738 0, transparent 60%),
        radial-gradient(1200px 520px at 88% -10%, #1a1430 0, transparent 60%),
        linear-gradient(180deg, var(--surface) 0%, var(--bg) 100%);
      line-height:1.6; min-height:100vh; overflow-x:hidden;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:20px}

    /* Tarjetas */
    .card{
      background:linear-gradient(180deg, var(--card), #0f1633);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
      color:var(--ink);
    }

    /* Hero */
    .hero{
      text-align:left;
      padding:16px 18px;
      background:linear-gradient(180deg, #111937 0, #0f1633 100%);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      margin:0 0 var(--gap);
    }
    .hero h1{ margin:4px 0 6px; font-size:clamp(1.4rem,1.4vw + 1rem,1.9rem); font-weight:900; color:var(--ink); }
    .hero .desc{ color:var(--muted); margin:0; }

    /* Barra de autenticaci√≥n */
    .authbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 14px; background:var(--surface);
      border:1px solid var(--stroke); border-radius:999px;
      color:var(--ink); font-weight:800; box-shadow:var(--shadow);
      margin:0 0 var(--gap);
    }
    .authbar .actions{ display:flex; gap:8px; }
    .hidden{ display:none !important; }

    /* Grid principal */
    .grid{ display:grid; grid-template-columns: 320px minmax(0,1fr); gap:var(--gap); align-items:start; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .col-right{ display:flex; flex-direction:column; gap:var(--gap); }
    .col-right > .card{ width:100%; }

    /* Perfil */
    .profile{ display:grid; grid-template-columns:auto 1fr; gap:12px; align-items:center; }
    .avatar{
      width:86px; height:86px; border-radius:14px; overflow:hidden;
      border:1px solid var(--stroke); background:var(--surface);
      display:flex; align-items:center; justify-content:center; font-weight:900; color:#cbd6ff; font-size:1.4rem;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; }
    .muted{ color:var(--muted) }
    .divider{ border:0; border-top:1px solid var(--stroke); margin:12px 0; }

    /* Campos / inputs */
    .field{ display:flex; flex-direction:column; gap:6px; margin:8px 0; }
    .field label{ font-weight:900; color:#cbd6ff; }
    .control{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--stroke); border-radius:12px; padding:10px 12px; background:var(--surface2);
    }
    .control input{
      border:none; outline:none; background:transparent; width:100%;
      font-weight:800; color:var(--ink); padding:4px 0;
    }
    .control input::placeholder{ color:#7f8ac2; }
    .hint{ font-size:.92rem; color:var(--muted) }
    .ok{ color:var(--ok); font-weight:800; }
    .err{ color:var(--danger); font-weight:800; }

    /* Botones */
    .btn{
      appearance:none; border:1px solid var(--stroke); cursor:pointer; background:var(--surface2); color:var(--ink);
      font-weight:900; letter-spacing:.2px; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow);
      transition:transform .08s, box-shadow .12s, filter .12s, border-color .12s; text-decoration:none;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.35); }
    .btn.primary{ background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#111; border-color:transparent; }
    .btn.small{ padding:6px 10px; font-size:.9rem; }
    .btn.upper{ text-transform:uppercase; letter-spacing:.3px; }

    /* Tabs */
    .tabs{ display:flex; gap:8px; background:var(--surface); border:1px solid var(--stroke); border-radius:12px; padding:6px; width:fit-content; }
    .tab-btn{ border:1px solid transparent; background:transparent; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:900; color:#e2e7ff; }
    .tab-btn.active{ background:var(--surface2); border-color:var(--stroke); }

    /* Tabla resultados */
    .table-wrap{
      background:var(--surface); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow); padding:12px; overflow:auto;
    }
    table{ width:100%; min-width:680px; border-collapse:separate; border-spacing:0; }
    thead th{
      position:sticky; top:0; z-index:1;
      background:var(--surface2); color:#dbe3ff; font-weight:900; letter-spacing:.01em; text-align:center; padding:10px; border-bottom:1px solid var(--stroke)
    }
    tbody td{ padding:10px; text-align:center; border-bottom:1px solid #1f2446; background:var(--surface); color:var(--ink) }
    tbody tr:nth-child(even) td{ background:#171d36 }
    tbody tr:hover td{ background:#1b2240 }

    .badge{
      display:inline-block; padding:4px 10px; border-radius:999px; font-weight:900; font-size:.8rem;
      background:rgba(108,139,255,.12); color:#cbd6ff; border:1px solid var(--stroke);
    }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:5px 10px; border-radius:999px;
      background:rgba(108,139,255,.10); color:#d8e2ff; border:1px solid var(--stroke); font-weight:800;
    }
    .pct{ display:flex; align-items:center; justify-content:center; gap:8px; font-variant-numeric:tabular-nums; font-weight:900; }
    .pbar{ position:relative; flex:1 1 120px; height:8px; background:#0b1024; border-radius:999px; overflow:hidden; max-width:160px; margin:0 auto; }
    .pbar>i{ position:absolute; inset:0 auto 0 0; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); }

    /* KPIs */
    .kpis{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .kpi{
      text-align:center; border:1px solid var(--stroke); border-radius:12px; padding:12px;
      background:linear-gradient(180deg, var(--surface2), var(--surface));
    }
    .kpi h4{ margin:0; font-size:1rem; color:#cbd6ff; font-weight:900; }
    .kpi .n{ font-size:1.4rem; font-weight:900; }

    /* Heatmap & badges */
    .heat{display:grid;grid-template-columns:repeat(14,1fr);gap:4px;margin-top:8px}
    .heat i{display:block;height:14px;border-radius:4px;background:#0b1024;border:1px solid var(--stroke)}
    .heat i.lv1{background:#15224a}
    .heat i.lv2{background:#1c2b5d}
    .heat i.lv3{background:#213471}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .badge-chip{border:1px solid var(--stroke);background:var(--surface2);color:#dbe3ff;border-radius:999px;padding:6px 10px;font-weight:900}

    .tool{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .tool select, .tool input[type="range"]{
      border:1px solid var(--stroke);border-radius:10px;padding:6px 8px;font-weight:800;background:var(--surface2);color:var(--ink)
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card hero">
      <h1>Wellcome to your Quizzer's Profile</h1>
      <p class="desc">Manage your profile and review your recent quiz results.</p>
    </section>

    <section class="authbar" id="authBar">
      <span id="authText" class="muted">üîí You‚Äôre not signed in.</span>
      <div class="actions">
        <button id="btnHome" class="btn small hidden">üè† Home</button>
        <button id="btnLogout" class="btn small hidden">Sign out</button>
      </div>
    </section>

    <section class="grid">
      <div class="col-left">
        <article class="card">
          <h3 style="margin:0 0 10px;font-weight:900">Profile</h3>
          <div class="profile">
            <div class="avatar" id="avatarBox">üë§</div>
            <div>
              <div id="userNameTxt" style="font-weight:900">‚Äî</div>
              <div id="userEmailTxt" class="muted">‚Äî</div>
            </div>
          </div>
          <hr class="divider">
          <form id="formProfile">
            <div class="field">
              <label for="name">Name</label>
              <div class="control"><input id="name" required placeholder="Your name"></div>
            </div>
            <div class="field">
              <label for="email">Email</label>
              <div class="control"><input id="email" type="email" required placeholder="you@email.com"></div>
            </div>
            <div class="field">
              <label for="avatarUrl">Avatar URL (optional)</label>
              <div class="control"><input id="avatarUrl" type="url" placeholder="https://.../avatar.png"></div>
            </div>
            <div class="hint">Tip: if you don‚Äôt set an avatar, we‚Äôll use your initials.</div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
              <button type="button" class="btn" id="btnResetProfile">Reset</button>
              <button class="btn primary" type="submit">Save</button>
            </div>
            <div id="profMsg" class="hint" style="margin-top:6px"></div>
          </form>
        </article>

        <article class="card">
          <h3 style="margin:0 0 10px;font-weight:900;">Study goals & streak</h3>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <label for="weeklyGoal" style="font-weight:900;color:#cbd6ff;">Weekly goal (attempts)</label>
            <input id="weeklyGoal" type="number" min="1" step="1" value="7" style="width:90px;padding:8px;border:1px solid var(--stroke);border-radius:10px;font-weight:900;background:var(--surface2);color:var(--ink);">
            <button id="btnSaveGoal" class="btn small">Save goal</button>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="font-weight:900;">This week</div>
            <div style="position:relative;flex:1;height:10px;background:#0b1024;border-radius:999px;overflow:hidden;border:1px solid var(--stroke);">
              <i id="goalFill" style="position:absolute;inset:0 auto 0 0;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));"></i>
            </div>
            <div id="goalText" style="font-weight:900;">0 / 7</div>
          </div>
          <div style="margin-top:10px;" class="hint">
            Current streak: <b id="streakDays">0</b> day(s)
          </div>

          <div style="margin-top:10px;">
            <div class="muted" style="margin-bottom:6px;">Last 14 days activity</div>
            <div id="heat14" class="heat"></div>
          </div>

          <div style="margin-top:10px;">
            <div class="muted" style="margin-bottom:6px;">Badges</div>
            <div id="badgesBox" class="badges"></div>
          </div>
        </article>
      </div>

      <div class="col-right">
        <article class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <h3 style="margin:0;font-weight:900">Your latest results</h3>
            <div class="tabs">
              <button id="tabAll"  class="tab-btn active" type="button">All</button>
              <button id="tabAZ"   class="tab-btn" type="button">AZ-104</button>
              <button id="tabAWS"  class="tab-btn" type="button">AWS SAA-C03</button>
            </div>
          </div>

          <div class="kpis" style="margin:10px 0 12px">
            <div class="kpi"><h4>Total attempts</h4><div id="kpiAttempts" class="n">0</div></div>
            <div class="kpi"><h4>Average %</h4><div id="kpiAvg" class="n">0%</div></div>
            <div class="kpi"><h4>Best %</h4><div id="kpiBest" class="n">0%</div></div>
          </div>

          <div class="tool">
            <label>Range:
              <select id="rangeSel">
                <option value="all">All</option>
                <option value="7">Last 7 days</option>
                <option value="30">Last 30 days</option>
                <option value="90">Last 90 days</option>
              </select>
            </label>
            <label>Min %:
              <input id="minPct" type="range" min="0" max="100" value="0">
              <span id="minPctVal" style="font-weight:900">0</span>
            </label>
            <span class="muted" id="filterCount"></span>
          </div>

          <div id="resultsWrap" class="table-wrap">Loading‚Ä¶</div>

          <div style="display:flex;gap:8px;justify-content:space-between;margin-top:10px;align-items:center;">
            <div id="trendHint" class="muted">‚Äî</div>
            <a class="btn upper" href="/score/ranking.html">üèÜ LEADERBOARD</a>
          </div>
        </article>

        <article class="card">
          <h3 style="margin:0 0 10px;font-weight:900;">Your marked question</h3>
          <div id="markedWrap" class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>QUIZ</th><th>Question</th><th>Note</th>
                </tr>
              </thead>
              <tbody id="markedBody">
                <tr><td colspan="4" style="text-align:center;">No marked questions yet.</td></tr>
              </tbody>
            </table>
          </div>
        </article>
      </div>
    </section>
  </div>

  <script>
    const API_BASE = "https://uougu1cm26.execute-api.eu-central-1.amazonaws.com";
    const AUTH_KEY = "currentUser";
    const GOAL_KEY = "weeklyGoal";

    const byId = id => document.getElementById(id);
    const toInt = v => Number.isFinite(Number(v)) ? (Number(v)|0) : 0;
    const pad = n => String(n).padStart(2,'0');
    const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const fmtDuration = sec => { sec = toInt(sec); if (!sec || sec<0) return "‚Äî"; const m=Math.floor(sec/60), s=sec%60; return `${pad(m)}:${pad(s)}`; };
    const fmtDate = iso => { if(!iso) return "‚Äî"; try{ return new Date(iso).toLocaleString([], {year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});}catch{ return iso; } };
    const norm = s => (s||"").toString().trim().toLowerCase();

    function getUser(){ try{ return JSON.parse(localStorage.getItem(AUTH_KEY)||"null"); }catch{return null;} }
    function getUserAny(){ let u=getUser(); if(!u){ try{u=JSON.parse(localStorage.getItem("certify_user")||"null")}catch{} } return u; }
    function setUser(u){ localStorage.setItem(AUTH_KEY, JSON.stringify(u)); renderAuth(); }
    function initialsOf(name){ const s=(name||"").trim(); if(!s) return "üë§"; const parts=s.split(/\s+/).slice(0,2); return parts.map(x=>x[0]?.toUpperCase()||"").join("")||"üë§"; }

    const getGoal = ()=>{ const v = toInt(localStorage.getItem(GOAL_KEY)||"7"); return v>0? v:7; }
    const setGoal = (n)=> localStorage.setItem(GOAL_KEY, String(Math.max(1,toInt(n))));

    const toDateOnly = (d)=> new Date(d.getFullYear(), d.getMonth(), d.getDate());
    function isWithinDays(date, days){ const now=new Date(); const diff = (now - new Date(date)) / 86400000; return diff>=0 && diff<=days; }

    function renderAuth(){
      const u = getUserAny();
      const authText = byId("authText");
      const btnLogout = byId("btnLogout");
      const btnHome = byId("btnHome");
      if (u){
        authText.textContent = `‚úÖ Signed in as: ${u.name} (${u.email})`;
        btnLogout.classList.remove("hidden");
        btnHome.classList.remove("hidden");
      }else{
        authText.textContent = "üîí You‚Äôre not signed in.";
        btnLogout.classList.add("hidden");
        btnHome.classList.add("hidden");
      }
      renderProfileForm();
      renderGoalUI();
    }

    function renderProfileForm(){
      const u = getUserAny() || {};
      byId("userNameTxt").textContent = u.name || "‚Äî";
      byId("userEmailTxt").textContent = u.email || "‚Äî";
      byId("name").value = u.name || "";
      byId("email").value = u.email || "";
      byId("avatarUrl").value = u.avatarUrl || "";
      const box = byId("avatarBox");
      box.innerHTML = "";
      if (u.avatarUrl){
        const im = new Image(); im.src = u.avatarUrl; im.alt = "avatar";
        im.onload = () => { box.innerHTML = ""; box.appendChild(im); }
        im.onerror = () => { box.textContent = initialsOf(u.name); }
      }else{
        box.textContent = initialsOf(u.name);
      }
    }

    async function loadRemoteMe(){
      const u = getUserAny(); if(!u) return;
      try{
        const res = await fetch(`${API_BASE}/me`, {mode:"cors",cache:"no-store"});
        if(res.ok){
          const data = await res.json();
          const merged = {...u, ...data};
          setUser(merged);
        }
      }catch{}
    }

    async function fetchMyResults(limit=500){
      const u = getUserAny(); if (!u) return [];
      const uid = (u.userId || u.id || "").toString();
      const uemail = norm(u.email);

      const qs = new URLSearchParams({ limit: String(limit) });
      if (uid) qs.set("userId", uid);
      if (uemail) qs.set("email", uemail);

      const res = await fetch(`${API_BASE}/results?${qs.toString()}`, {mode:"cors",cache:"no-store"});
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);

      const items = Array.isArray(data.items) ? data.items : [];

      const isMine = (x) => {
        const xid = (x.userId || x.id || x?.user?.id || "").toString();
        const xemail = norm(x.email || x.userEmail || x?.user?.email || x?.profile?.email);
        return (uid && xid && uid === xid) || (uemail && xemail && uemail === xemail);
      };

      const mine = items.filter(isMine);

      const pick = v => (typeof v === "string" ? v.trim() : "");
      const getName = x => pick(x.userName)||pick(x.username)||pick(x.displayName)||pick(x.name)||pick(x?.user?.name)||pick(x?.profile?.name)||"(no name)";

      return mine.map(x => ({
        userId: x.userId || x.id || "(unknown)",
        userName: getName(x),
        quizId: (x.quizId || "-").toLowerCase(),
        correct: (x.correct|0),
        total: (x.total|0),
        pct: (x.pct|0),
        durationSec: (x.durationSec|0),
        ts: x.ts || null
      }));
    }

    function calcKPIs(rows){
      const n = rows.length;
      const avg = n ? Math.round(rows.reduce((a,b)=>a + ((b.pct|0)||0),0)/n) : 0;
      const best = rows.reduce((m,b)=> Math.max(m, (b.pct|0)||0), 0);
      byId("kpiAttempts").textContent = String(n);
      byId("kpiAvg").textContent = `${avg}%`;
      byId("kpiBest").textContent = `${best}%`;
    }

    function computeStreak(rows){
      if (!rows.length) return 0;
      const datesSet = new Set(rows.filter(r=>r.ts).map(r=> new Date(r.ts)).map(d=> toDateOnly(d).toISOString().slice(0,10)));
      let streak = 0;
      let cursor = toDateOnly(new Date());
      while (datesSet.has(cursor.toISOString().slice(0,10))){
        streak++;
        cursor = new Date(cursor.getTime() - 86400000);
      }
      return streak;
    }
    function weeklyProgress(rows){
      const goal = getGoal();
      const attempts = rows.filter(r=> r.ts && isWithinDays(r.ts, 6)).length;
      const pct = Math.min(100, Math.round((attempts / Math.max(1,goal)) * 100));
      return { attempts, goal, pct };
    }
    function renderGoalUI(){
      const goal = getGoal();
      byId("weeklyGoal").value = goal;
      byId("goalText").textContent = `0 / ${goal}`;
      byId("goalFill").style.width = `0%`;
    }

    window.__filters = {days:'all', minPct:0, fromDate:null};
    const activeFilterKey = ()=> {
      const t = document.querySelector('.tab-btn.active')?.textContent || 'All';
      return t.toLowerCase().includes('aws') ? 'aws-saa-c03'
           : t.toLowerCase().includes('az')  ? 'az-104'
           : 'all';
    };

    function renderResults(rows, filter="all"){
      const root = byId("resultsWrap");
      let list = rows.slice().sort((a,b)=> (b.ts||"").localeCompare(a.ts||""));
      const f = filter.toLowerCase();
      if (f==="az-104" || f==="aws-saa-c03") list = list.filter(x=>x.quizId===f);

      const { days, minPct } = window.__filters || {};
      if (days && days!=="all"){
        const cutoff = Date.now() - Number(days)*86400000;
        list = list.filter(x=> x.ts && new Date(x.ts).getTime() >= cutoff);
      }
      if (typeof minPct === "number"){
        list = list.filter(x=> (x.pct|0) >= minPct);
      }

      byId("filterCount").textContent = list.length ? `${list.length} shown` : '0 shown';

      const rowsForKpi = (f==="all" ? rows : rows.filter(x=>x.quizId===f));
      calcKPIs(rowsForKpi);

      const streak = computeStreak(rows);
      byId("streakDays").textContent = String(streak);
      const {attempts, goal, pct} = weeklyProgress(rows);
      byId("goalText").textContent = `${attempts} / ${goal}`;
      byId("goalFill").style.width = `${pct}%`;

      if (!list.length){
        root.innerHTML = `<div class="table-wrap"><p style="text-align:center;margin:12px 0;">No results yet.</p></div>`;
        return;
      }
      let html = `<table>
        <thead><tr>
          <th>#</th><th>QUIZ</th><th>Correct</th><th>Total</th><th>Score</th><th>Duration</th><th>Date</th><th>Review</th>
        </tr></thead><tbody>`;
      list.slice(0,10).forEach((r,i)=>{
        const pct = Math.min(100, Math.max(0, (r.pct|0)));
        html += `<tr>
          <td>${i+1}</td>
          <td><span class="badge">${escapeHtml(r.quizId).toUpperCase()}</span></td>
          <td>${r.correct}</td>
          <td>${r.total}</td>
          <td>
            <div class="pct">
              <div class="pbar"><i style="width:${pct}%"></i></div>
              <span>${pct}%</span>
            </div>
          </td>
          <td><span class="chip">${fmtDuration(r.durationSec)}</span></td>
          <td>${fmtDate(r.ts)}</td>
          <td><span class="review-icon" title="Review coming soon">üîç</span></td>
        </tr>`;
      });
      html += `</tbody></table>`;
      root.innerHTML = html;
    }

    /* ======== MARCADAS ======== */
    function getLastSessionId() {
      const keys = Object.keys(localStorage).filter(k => k.startsWith("quiz.session."));
      keys.sort().reverse();
      for (const k of keys) {
        const sid = localStorage.getItem(k);
        if (sid) return sid;
      }
      return null;
    }

    async function fetchMyMarked(limit=200){
      const out = [];
      try{
        const u = getUserAny();
        if (u && (u.userId || u.id || u.email)) {
          const uid = (u.userId || u.id || "").toString();
          const uemail = norm(u.email);
          const qs = new URLSearchParams({ limit: String(limit) });
          if (uid) qs.set("userId", uid);
          if (uemail) qs.set("email", uemail);

          const r = await fetch(`${API_BASE}/progress?${qs.toString()}`, {mode:"cors",cache:"no-store"});
          const data = await r.json().catch(()=> ({}));
          if (r.ok && Array.isArray(data.items)) {
            const sessions = data.items.slice().sort((a,b)=> String(b.updatedAt||'').localeCompare(String(a.updatedAt||'')));
            for (const it of sessions) {
              const quiz = String(it.quizId||'-').toLowerCase();
              const items = Array.isArray(it.markedItems) ? it.markedItems : [];
              if (items.length){
                for (const m of items) {
                  out.push({
                    quizId: quiz,
                    questionId: m.questionId || null,
                    question: m.question || '(no text)',
                    domain: m.domain || null,
                    category: m.category || null,
                    sessionId: m.sessionId || it.sessionId || '',
                    idx: (typeof m.index==='number'? m.index : null),
                    markedAt: m.markedAt || it.updatedAt || it.startedAt || null
                  });
                }
                continue;
              }
              const questionIds = Array.isArray(it.questionIds) ? it.questionIds : [];
              const markedMap   = (typeof it.marked === 'object' && it.marked) ? it.marked : {};
              Object.entries(markedMap).forEach(([idxStr,flag])=>{
                if(!flag) return;
                const idx = parseInt(idxStr,10);
                const qid = (idx>=0 && idx<questionIds.length) ? questionIds[idx] : null;
                out.push({
                  quizId: quiz,
                  questionId: qid,
                  question: '(marked question ‚Äî open session to review)',
                  domain: null, category: null, sessionId: it.sessionId || '',
                  idx, markedAt: it.updatedAt || it.startedAt || null
                });
              });
            }
          }
        }

        if (out.length === 0) {
          const sid = getLastSessionId();
          if (sid) {
            const r2 = await fetch(`${API_BASE}/progress?sessionId=${encodeURIComponent(sid)}`, {mode:"cors",cache:"no-store"});
            const data2 = await r2.json().catch(()=> ({}));
            if (r2.ok && data2 && data2.item) {
              const it = data2.item;
              const quiz = String(it.quizId||'-').toLowerCase();
              const items = Array.isArray(it.markedItems) ? it.markedItems : [];
              if (items.length){
                for (const m of items) {
                  out.push({
                    quizId: quiz,
                    questionId: m.questionId || null,
                    question: m.question || '(no text)',
                    domain: m.domain || null,
                    category: m.category || null,
                    sessionId: m.sessionId || it.sessionId || '',
                    idx: (typeof m.index==='number'? m.index : null),
                    markedAt: m.markedAt || it.updatedAt || it.startedAt || null
                  });
                }
              } else {
                const questionIds = Array.isArray(it.questionIds) ? it.questionIds : [];
                const markedMap   = (typeof it.marked === 'object' && it.marked) ? it.marked : {};
                Object.entries(markedMap).forEach(([idxStr,flag])=>{
                  if(!flag) return;
                  const idx = parseInt(idxStr,10);
                  const qid = (idx>=0 && idx<questionIds.length) ? questionIds[idx] : null;
                  out.push({
                    quizId: quiz,
                    questionId: qid,
                    question: '(marked question ‚Äî open session to review)',
                    domain: null, category: null, sessionId: it.sessionId || '',
                    idx, markedAt: it.updatedAt || it.startedAt || null
                  });
                });
              }
            }
          }
        }

        out.sort((a,b)=> String(b.markedAt||'').localeCompare(String(a.markedAt||'')));
        return out.slice(0, 50);
      }catch(e){
        console.warn('Marked fetch failed:', e);
        return out.slice(0,50);
      }
    }

    function renderMarked(rows){
      const body = byId('markedBody');
      if(!rows.length){
        body.innerHTML = `<tr><td colspan="4" style="text-align:center;">No marked questions yet.</td></tr>`;
        return;
      }
      body.innerHTML = rows.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td><span class="badge">${escapeHtml(r.quizId).toUpperCase()}</span></td>
          <td style="text-align:left">${escapeHtml(r.question)}</td>
          <td>${escapeHtml(r.domain || r.category || '')}</td>
        </tr>
      `).join('');
    }

    function computeTrend(rows){
      const ordered = rows.filter(r=>r.ts).slice().sort((a,b)=> new Date(a.ts)-new Date(b.ts));
      if (ordered.length<6) return {delta:0, dir:'='};
      const mid = Math.floor(ordered.length/2);
      const prev = ordered.slice(0, mid);
      const last = ordered.slice(mid);
      const avg = a => Math.round(a.reduce((s,x)=>s+(x.pct||0),0)/Math.max(1,a.length));
      const p1=avg(prev), p2=avg(last), d=p2-p1;
      return {delta:d, dir: d>0?'up':(d<0?'down':'=')};
    }

    function renderHeat14(rows){
      const root = byId('heat14'); if(!root) return;
      root.innerHTML = '';
      const now = toDateOnly(new Date());
      const perDay = {};
      rows.forEach(r=>{
        if(!r.ts) return;
        const key = toDateOnly(new Date(r.ts)).toISOString().slice(0,10);
        perDay[key] = (perDay[key]||0)+1;
      });
      for(let i=13;i>=0;i--){
        const d = new Date(now.getTime()-i*86400000);
        const k = d.toISOString().slice(0,10);
        const n = perDay[k]||0;
        const cell = document.createElement('i');
        if(n>=3) cell.className='lv3'; else if(n===2) cell.className='lv2'; else if(n===1) cell.className='lv1';
        root.appendChild(cell);
      }
    }

    function computeBadges(rows){
      const n=rows.length;
      const streak = computeStreak(rows);
      const hasFast = rows.some(r=> (r.durationSec||0) <= 600);
      const avg = n? Math.round(rows.reduce((a,b)=>a+(b.pct||0),0)/n) : 0;
      const badges=[];
      if(n>=5) badges.push('üèÅ Warm-up (5 attempts)');
      if(streak>=3) badges.push('üî• Consistent (3-day streak)');
      if(hasFast) badges.push('‚ö° Fast Thinker (<10m)');
      if(avg>=70) badges.push('üõ°Ô∏è Solid (avg ‚â•70%)');
      if(avg>=85) badges.push('üåü Elite (avg ‚â•85%)');
      return badges;
    }
    function renderBadges(rows){
      const b = computeBadges(rows);
      const host = byId('badgesBox'); 
      host.innerHTML = b.map(x=>`<span class="badge-chip">${escapeHtml(x)}</span>`).join('') || '<span class="muted">No badges yet.</span>';
    }

    // Events
    byId("btnHome").onclick = ()=>{ location.href = "/"; };
    byId("btnLogout").onclick = ()=>{ localStorage.removeItem(AUTH_KEY); location.href = "/"; };
    byId("btnResetProfile").onclick = ()=>{ renderProfileForm(); byId("profMsg").textContent=""; };
    byId("btnSaveGoal").onclick = ()=>{
      const val = Math.max(1, toInt(byId("weeklyGoal").value));
      setGoal(val);
      const rows = window.__myRows || [];
      const {attempts, goal, pct} = weeklyProgress(rows);
      byId("goalText").textContent = `${attempts} / ${goal}`;
      byId("goalFill").style.width = `${pct}%`;
    };

    function activateTab(which){
      byId("tabAll").classList.toggle("active", which==="all");
      byId("tabAZ").classList.toggle("active", which==="az-104");
      byId("tabAWS").classList.toggle("active", which==="aws-saa-c03");
    }
    byId("tabAll").onclick  = ()=>{ activateTab("all"); renderResults(window.__myRows||[], "all"); };
    byId("tabAZ").onclick   = ()=>{ activateTab("az-104"); renderResults(window.__myRows||[], "az-104"); };
    byId("tabAWS").onclick  = ()=>{ activateTab("aws-saa-c03"); renderResults(window.__myRows||[], "aws-saa-c03"); };

    byId('rangeSel').onchange = (e)=>{
      window.__filters.days = e.target.value;
      renderResults(window.__myRows||[], activeFilterKey());
    };
    byId('minPct').oninput = (e)=>{
      const v=Number(e.target.value)||0;
      byId('minPctVal').textContent=v;
      window.__filters.minPct=v;
      renderResults(window.__myRows||[], activeFilterKey());
    };

    // ===== Init =====
    document.addEventListener("DOMContentLoaded", async ()=>{
      renderAuth();
      loadRemoteMe();

      try{
        const rows = await fetchMyResults(500);
        window.__myRows = rows;
        renderResults(rows, "all");
        renderHeat14(rows);
        renderBadges(rows);

        const tr = computeTrend(rows);
        const arrow = tr.dir==='up'?'‚¨ÜÔ∏è':(tr.dir==='down'?'‚¨áÔ∏è':'‚û°Ô∏è');
        byId('trendHint').textContent = `${arrow} Trend vs. previous period: ${tr.delta>0?'+':''}${tr.delta}%`;

        const plan = weeklyProgress(rows);
        if(plan.attempts < plan.goal){
          const remain = Math.max(0, plan.goal - plan.attempts);
          byId('trendHint').textContent += ` ‚Ä¢ ${remain} to reach weekly goal`;
        }
      }catch(e){
        document.getElementById("resultsWrap").innerHTML = `<div class="table-wrap"><p style="text-align:center;color:#ff8f8f;">Error loading results or not signed in.</p></div>`;
        console.warn('Results fetch failed:', e);
      }

      try{
        const marked = await fetchMyMarked(200);
        renderMarked(marked);
      }catch(e){
        console.warn('Marked render failed:', e);
      }
    });
  </script>
</body>
</html>
