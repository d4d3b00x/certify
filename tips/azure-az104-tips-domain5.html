<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AZ-104 ‚Äî Dominio 5 ¬∑ Monitorizar y mantener recursos</title>
  <style>
    :root{
      --bg:#0b1020;--card:#111a3a;--border:#2a3b82;--text:#e8edff;--muted:#a7b4ff;
      --accent:#7ac7ff;--pink:#ff6ac1;--green:#6af7c0;--yellow:#ffd15c;--red:#ff9b9b;
      --blue:#74a8ff;--purple:#c59cff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(1200px 600px at 10% -10%,#141a3c 0,#0b1020 50%,#070b18 100%);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      line-height:1.65;
    }
    a{color:var(--accent)}
    .wrap{max-width:1000px;margin:0 auto;padding:28px}
    .badge{
      display:inline-flex;align-items:center;gap:10px;
      border:1px solid var(--border);
      background:linear-gradient(180deg,#0f1844,#0d1438);
      padding:8px 14px;
      border-radius:999px;
      font-weight:900;
      color:#cbd6ff;
      box-shadow:0 0 0 3px #00000044;
    }
    h1{margin:10px 0 10px;font-size:1.9rem}
    h2{margin:22px 0 10px;font-size:1.25rem}
    .muted{color:var(--muted)}
    .card{
      background:linear-gradient(180deg,#101a48,#0d1538);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      margin:12px 0;
      box-shadow:0 6px 32px #00000055;
    }
    ul{padding-left:18px;margin:6px 0}
    li+li{margin-top:6px}
    .ok{color:var(--green)}
    .warn{color:var(--yellow)}
    .bad{color:var(--red)}
    code,.mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    .toc{
      background:linear-gradient(180deg,#0f1a4a,#0b1230);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin:12px 0;
      display:grid;
      gap:6px;
    }
    .toc a{color:#e3ecff;text-decoration:none}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:12px;
    }
    .kicker{
      font-size:.85rem;
      letter-spacing:.06em;
      color:#cfd6ff;
      text-transform:uppercase;
    }
    .pill{
      display:inline-block;
      font-size:.75rem;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#0e1740;
      margin-right:6px;
    }
    .hl{
      background:linear-gradient(90deg,#1c245c,#191f4a);
      border-left:3px solid var(--accent);
      padding:10px;
      border-radius:10px;
    }
    .note{
      background:linear-gradient(180deg,#102f38,#0b2025);
      border:1px solid #2a5f6a;
    }
    .tip{
      background:linear-gradient(180deg,#163310,#10230b);
      border:1px solid #2a6a2a;
    }
    .warnbox{
      background:linear-gradient(180deg,#3a1b1b,#2a1010);
      border:1px solid #7a2a2a;
    }
    kbd{
      border:1px solid #3a4a88;
      border-bottom-width:3px;
      border-radius:6px;
      padding:1px 6px;
      background:#0e1640;
    }
    pre{
      background:#0a122e;
      border:1px solid #26336e;
      border-radius:12px;
      padding:12px;
      overflow:auto;
    }
    .footer{
      color:#aab7ff;
      font-size:.9rem;
      margin-top:22px;
    }
    .small{font-size:.9rem}
    strong{font-weight:600}
  </style>
</head>
<body>
<div class="wrap">
  <span class="badge">Azure ¬∑ Operaciones</span>
  <h1>AZ-104 ‚Äî Dominio 5 ¬∑ Monitorizar y mantener recursos</h1>
  <p class="muted">
    Aqu√≠ se junta todo lo operativo: Azure Monitor, Log Analytics, KQL, alertas, Update Manager, Automation, Backup y Site Recovery.
    Es el dominio que separa ‚Äús√© desplegar cosas‚Äù de ‚Äús√© operarlas en serio‚Äù.
  </p>

  <div class="toc">
    <div class="kicker">√çndice r√°pido para estudiar</div>
    <div class="grid">
      <a href="#conceptos">Conceptos clave</a>
      <a href="#decision">Gu√≠a de decisi√≥n</a>
      <a href="#comandos">Comandos y KQL</a>
      <a href="#escenarios">Escenarios tipo examen</a>
      <a href="#errores">Errores comunes</a>
      <a href="#cross">Cross-links con otros dominios</a>
    </div>
  </div>

  <div class="card" id="conceptos">
    <h2>Conceptos clave</h2>
    <ul>
      <li>
        <strong>Azure Monitor (visi√≥n general)</strong><br>
        <span class="small">
          Es el ‚Äúparaguas‚Äù que agrupa:
          <ul>
            <li><strong>M√©tricas</strong>: valores num√©ricos (CPU, IOPS, latencia) en intervalos cortos.</li>
            <li><strong>Logs</strong>: eventos detallados enviados a Log Analytics.</li>
            <li><strong>Alertas</strong>, <strong>dashboards</strong>, <strong>workbooks</strong>, <strong>mapas de dependencia</strong>, etc.</li>
          </ul>
          Fundamental: saber cu√°ndo usar m√©trica vs log para una alerta.
        </span>
      </li>
      <li>
        <strong>Log Analytics y KQL</strong><br>
        <span class="small">
          <ul>
            <li><strong>Workspaces</strong>: contenedores donde se almacenan logs (Perf, Heartbeat, AzureActivity, etc.).</li>
            <li><strong>KQL</strong> (Kusto Query Language): lenguaje de consulta para esos datos.</li>
            <li><strong>Retenci√≥n</strong>: d√≠as que guardas los datos (impacta en coste).</li>
          </ul>
          Ejemplo de consulta t√≠pica:
          <pre><code>Heartbeat
| summarize lastSeen=max(TimeGenerated) by Computer
| order by lastSeen desc</code></pre>
        </span>
      </li>
      <li>
        <strong>Alertas, Action Groups y Action Rules</strong><br>
        <span class="small">
          <ul>
            <li><strong>Alertas de m√©tricas</strong>: muy r√°pidas, para condiciones como ‚ÄúCPU &gt; 80% 5 minutos‚Äù.</li>
            <li><strong>Alertas de logs</strong>: basadas en KQL, m√°s flexibles pero algo m√°s lentas.</li>
            <li><strong>Action Groups</strong>: qu√© pasa cuando salta la alerta (email, SMS, webhook, ITSM, Runbook‚Ä¶).</li>
            <li><strong>Action Rules</strong>: suprimir, enrutar o modificar alertas en ciertos periodos/condiciones.</li>
          </ul>
        </span>
      </li>
      <li>
        <strong>Data Collection Rules (DCR)</strong><br>
        <span class="small">
          Definen qu√© datos se recogen de qu√© recursos y a qu√© workspace/endpoint se env√≠an.
          Permiten separar claramente la parte de recolecci√≥n (DCR) de la de an√°lisis (workspaces).
        </span>
      </li>
      <li>
        <strong>Update Manager (parcheo)</strong><br>
        <span class="small">
          Gestiona las actualizaciones de VMs:
          <ul>
            <li>Eval√∫a cumplimiento de parches.</li>
            <li>Crea <strong>deployment schedules</strong> por grupos de m√°quinas (din√°micos por tags, etc.).</li>
            <li>Permite exclusiones y ventanas de mantenimiento.</li>
          </ul>
        </span>
      </li>
      <li>
        <strong>Automation y runbooks</strong><br>
        <span class="small">
          <ul>
            <li><strong>Automation Account</strong>: contenedor para runbooks (PowerShell/Python).</li>
            <li><strong>Runbooks</strong>: scripts que se ejecutan bajo una identidad (generalmente managed identity).</li>
            <li>Pueden lanzarse por horario, por webhook o desde alertas.</li>
          </ul>
        </span>
      </li>
      <li>
        <strong>Backup (Recovery Services Vaults)</strong><br>
        <span class="small">
          <ul>
            <li>Protege VMs, SQL, Azure Files, etc.</li>
            <li>Pol√≠ticas de backup: frecuencia de copias, retenci√≥n corta/larga.</li>
            <li>Restores a nivel de VM completa, disco, o archivos (seg√∫n workload).</li>
          </ul>
        </span>
      </li>
      <li>
        <strong>Site Recovery (ASR)</strong><br>
        <span class="small">
          Servicio de replicaci√≥n y continuidad:
          <ul>
            <li>Replica VMs entre regiones o desde on-prem a Azure.</li>
            <li>Define <strong>planes de recuperaci√≥n</strong> con orden de arranque, scripts, etc.</li>
            <li>Permite <strong>test failover</strong> sin impacto en producci√≥n.</li>
          </ul>
        </span>
      </li>
      <li>
        <strong>Service Health y Azure Advisor</strong><br>
        <span class="small">
          <ul>
            <li><strong>Service Health</strong>: estado de servicios de Azure, incidencias, mantenimiento planificado.</li>
            <li><strong>Advisor</strong>: recomendaciones de coste, seguridad, fiabilidad y rendimiento.</li>
          </ul>
        </span>
      </li>
    </ul>

    <div class="hl note" style="margin-top:10px">
      <span class="pill">üìò Tip del examen</span>
      Preguntas de ‚Äúc√≥mo enterarse r√°pido de X‚Äù ‚Üí piensa en <strong>alerta + Action Group</strong>.  
      Preguntas de ‚Äúanalizar tendencias o correlaciones‚Äù ‚Üí <strong>logs + KQL + workbooks</strong>.
    </div>
  </div>

  <div class="card" id="decision">
    <h2>Gu√≠a de decisi√≥n r√°pida</h2>
    <ul>
      <li>
        <strong>‚ÄúQueremos saber en segundos si una m√©trica se dispara‚Äù</strong><br>
        <span class="small">
          ‚Üí <strong>Alerta de m√©trica</strong> con ventana corta (por ejemplo 5 minutos) + Action Group.
        </span>
      </li>
      <li>
        <strong>‚ÄúQueremos alertar cuando pase algo m√°s complejo (ej: cambios RBAC)‚Äù</strong><br>
        <span class="small">
          ‚Üí <strong>Alerta de logs</strong> sobre AzureActivity / otros logs + consulta KQL.
        </span>
      </li>
      <li>
        <strong>‚ÄúHay demasiadas alertas cuando hacemos mantenimiento programado‚Äù</strong><br>
        <span class="small">
          ‚Üí <strong>Action Rules</strong> para suprimir alertas por horario, por recurso etiquetado con <code>maintenance=true</code>, etc.
        </span>
      </li>
      <li>
        <strong>‚ÄúQueremos automatizar una acci√≥n cuando salte una alerta‚Äù</strong><br>
        <span class="small">
          ‚Üí Alertas que llamen a un <strong>Runbook de Automation</strong> o a una funci√≥n.
        </span>
      </li>
      <li>
        <strong>‚ÄúNecesitamos copias de seguridad de VMs y datos importantes‚Äù</strong><br>
        <span class="small">
          ‚Üí <strong>Backup (RSV)</strong> con pol√≠tica adecuada de frecuencia y retenci√≥n.
        </span>
      </li>
      <li>
        <strong>‚ÄúQueremos poder levantar la plataforma en otra regi√≥n si hay desastre‚Äù</strong><br>
        <span class="small">
          ‚Üí <strong>Site Recovery (ASR)</strong> con replicaci√≥n y planes de recuperaci√≥n probados.
        </span>
      </li>
    </ul>

    <div class="hl tip" style="margin-top:10px">
      <span class="pill">üéØ Estrategia</span>
      Clasifica siempre el problema: <strong>detectar</strong> (alertas), <strong>investigar</strong> (logs/KQL),
      <strong>automatizar respuesta</strong> (runbooks), <strong>proteger datos</strong> (backup)
      o <strong>mantener servicio</strong> (ASR).
    </div>
  </div>

  <div class="card" id="comandos">
    <h2>Comandos y consultas KQL √∫tiles</h2>
    <div class="grid">
      <div class="card" style="background:#0c1332">
        <div class="kicker">Habilitar diagn√≥sticos hacia Log Analytics</div>
        <pre><code>az monitor diagnostic-settings create \
  --name sendToLA \
  --resource &lt;resourceId&gt; \
  --workspace &lt;laWorkspaceId&gt; \
  --logs '[
    {"category": "Administrative", "enabled": true}
  ]' \
  --metrics '[
    {"category": "AllMetrics", "enabled": true}
  ]'</code></pre>
        <p class="small">
          Portal: en cada recurso, pesta√±a <strong>Diagnostic settings</strong>.
        </p>
      </div>

      <div class="card" style="background:#0c1332">
        <div class="kicker">Crear alerta de m√©trica (CPU alta)</div>
        <pre><code>az monitor metrics alert create \
  -g rg-demo \
  -n cpuHigh \
  --scopes &lt;vmResourceId&gt; \
  --condition "avg Percentage CPU &gt; 80" \
  --window-size 5m \
  --evaluation-frequency 1m \
  --action-group &lt;actionGroupId&gt;</code></pre>
        <p class="small">
          Portal: <strong>Azure Monitor &gt; Alerts &gt; + Create</strong>.
        </p>
      </div>

      <div class="card" style="background:#0c1332">
        <div class="kicker">KQL: cambios de rol RBAC</div>
        <pre><code>AzureActivity
| where OperationNameValue == "Microsoft.Authorization/roleAssignments/write"
| project TimeGenerated, Caller, ActivityStatus, ResourceGroup, SubscriptionId</code></pre>
        <p class="small">
          √ötil para escenarios de auditor√≠a de permisos.
        </p>
      </div>

      <div class="card" style="background:#0c1332">
        <div class="kicker">Backup de VM</div>
        <pre><code>az backup protection enable-for-vm \
  -g rg-demo \
  -v myVault \
  -n vm-prod-01 \
  --policy-name DailyPolicy</code></pre>
        <p class="small">
          Portal: <strong>Recovery Services vaults &gt; Backup</strong>.
        </p>
      </div>
    </div>

    <p class="muted small">
      No hace falta ser ninja de KQL para el AZ-104, pero s√≠ reconocer consultas sencillas y entender qu√© hacen.
    </p>
  </div>

  <div class="card" id="escenarios">
    <h2>Escenarios tipo examen</h2>
    <ul>
      <li>
        <strong>Escenario 1: Avisar cuando se cambian permisos cr√≠ticos</strong><br>
        <span class="small">
          El equipo de seguridad quiere alertas cuando alguien asigne roles de Owner a recursos.  
          Soluci√≥n:
          <ul>
            <li>Enviar <strong>AzureActivity</strong> a Log Analytics.</li>
            <li>Crear consulta KQL filtrando <code>roleAssignments/write</code> con rol Owner.</li>
            <li>Crear <strong>alerta de log</strong> con esa consulta + Action Group al equipo de seguridad.</li>
          </ul>
        </span>
      </li>
      <li>
        <strong>Escenario 2: Reducir ruido en mantenimiento</strong><br>
        <span class="small">
          Cada domingo por la noche hay alertas masivas por reinicios de VMs planificados.  
          ‚Üí Crear <strong>Action Rule</strong> que suprima ciertas alertas en ese horario
          o para recursos con tag <code>maintenance=true</code>.
        </span>
      </li>
      <li>
        <strong>Escenario 3: Recuperar VM frente a ransomware</strong><br>
        <span class="small">
          Una VM ha sido cifrada por ransomware, quieren volver a un estado correcto.  
          Soluci√≥n ‚Äúde libro‚Äù:
          <ul>
            <li>Restaurar desde <strong>backup reciente</strong> en Recovery Services Vault.</li>
            <li>Preferible en una nueva VM para evitar contaminaci√≥n.</li>
          </ul>
        </span>
      </li>
      <li>
        <strong>Escenario 4: Ensayar DR a otra regi√≥n</strong><br>
        <span class="small">
          La organizaci√≥n quiere probar que puede levantar servicios en otra regi√≥n sin parar producci√≥n.  
          ‚Üí Usar <strong>ASR</strong> con <strong>test failover</strong> a una red aislada, validar, y despu√©s limpiar recursos de prueba.
        </span>
      </li>
      <li>
        <strong>Escenario 5: Centralizar el parcheo de VMs</strong><br>
        <span class="small">
          Heterogeneidad de parches en docenas de VMs.  
          ‚Üí <strong>Azure Update Manager</strong>, grupos din√°micos por tags (por ejemplo <code>env=Prod</code>),
          campa√±as de parches escalonadas y ventanas de mantenimiento claras.
        </span>
      </li>
    </ul>

    <div class="hl tip" style="margin-top:10px">
      <span class="pill">üß™ C√≥mo practicar</span>
      Elige un recurso: VM, Storage, App Service‚Ä¶  
      Activa diagn√≥sticos ‚Üí env√≠a a Log Analytics ‚Üí crea una consulta KQL ‚Üí crea una alerta ‚Üí as√≠ cierras todo el circuito.
    </div>
  </div>

  <div class="card warnbox" id="errores">
    <h2>Errores comunes</h2>
    <ul>
      <li>
        <strong>Mandar todos los logs de todo a un workspace sin control</strong><br>
        <span class="small">
          Suben mucho los costes y adem√°s hay ruido.  
          Lo correcto es usar <strong>DCR</strong>, filtrar categor√≠as y ajustar retenci√≥n.
        </span>
      </li>
      <li>
        <strong>Crear alertas sin Action Group √∫til</strong><br>
        <span class="small">
          Una alerta que no env√≠a correo, webhook o no dispara runbook es b√°sicamente ruido mudo.
        </span>
      </li>
      <li>
        <strong>No probar los planes de recuperaci√≥n</strong><br>
        <span class="small">
          Tener ASR configurado sin hacer <strong>test failover</strong> no es un plan real.  
          El examen suele premiar respuestas que incluyen pruebas peri√≥dicas.
        </span>
      </li>
      <li>
        <strong>Depender solo de m√©tricas cuando necesitas contexto</strong><br>
        <span class="small">
          Las m√©tricas te dicen ‚ÄúCPU alta‚Äù; los logs te dicen <em>por qu√©</em>.  
          Para correlaciones y auditor√≠a, piensa en logs + KQL.
        </span>
      </li>
      <li>
        <strong>No etiquetar recursos</strong><br>
        <span class="small">
          Sin tags es m√°s dif√≠cil crear dashboards, agrupar en Update Manager, filtrar alertas, etc.
        </span>
      </li>
    </ul>
  </div>

  <div class="card" id="cross">
    <h2>Cross-links con otros dominios</h2>
    <ul>
      <li>
        <strong>Con identidades y gobierno</strong><br>
        <span class="small">
          Logs de Entra ID, AzureActivity (RBAC, Policy), PIM.  
          Alertas cuando haya cambios sensibles de permisos o incumplimiento de pol√≠ticas.
        </span>
      </li>
      <li>
        <strong>Con almacenamiento</strong><br>
        <span class="small">
          M√©tricas de capacidad y rendimiento en Storage, logs de acceso para detectar patrones an√≥malos,
          backup de datos clave.
        </span>
      </li>
      <li>
        <strong>Con c√≥mputo</strong><br>
        <span class="small">
          Monitorizaci√≥n de VMs y VMSS (CPU, RAM, disco, conexiones), flujos de red, parches y backups de las instancias.
        </span>
      </li>
      <li>
        <strong>Con redes</strong><br>
        <span class="small">
          Network Watcher, NSG flow logs, Connection Monitor, m√©tricas de Load Balancer / App Gateway / Firewall.
        </span>
      </li>
    </ul>

    <p class="muted small">
      Piensa en este dominio como la ‚Äúcapa de observabilidad y resiliencia‚Äù que se apoya en todo lo que montas
      en los otros cuatro dominios.
    </p>
  </div>

  <div class="footer">
    <span class="pill">üß† Consejo final</span>
    No necesitas memorizar todos los men√∫s del portal, sino entender el flujo:
    <strong>generar datos ‚Üí recogerlos ‚Üí consultarlos ‚Üí alertar ‚Üí automatizar respuesta ‚Üí proteger con backup/DR</strong>.  
    Si eso lo tienes claro, vas muy fuerte en este dominio.
  </div>

</div>
</body>
</html>
