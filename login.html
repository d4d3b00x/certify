

  

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 2rem; max-width: 720px; margin: auto; }
    button { padding: .7rem 1rem; font-size: 1rem; cursor: pointer; }
    pre { white-space: pre-wrap; background:#f7f7f9; padding:1rem; border:1px solid #eee; border-radius:8px; }
  </style>
</head>
<body>
  <h1>Iniciar sesión</h1>
  <p>Este botón te llevará al Hosted UI de Cognito y, tras autenticar, volverás a <code>index.html</code>.</p>

  <button id="loginBtn">Iniciar sesión con Cognito</button>
  <pre id="out">Listo para iniciar sesión…</pre>

  <script type="module">
        // ====== CONFIG ======
   const authority= "https://cognito-idp.eu-central-1.amazonaws.com/eu-central-1_Nm2FEuL1J";
    const USER_POOL_ID = "eu-central-1_Nm2FEuL1J";
    const APP_CLIENT_ID = "2rg0eg5ve63uo4ocn25scbrstg";
    const IDENTITY_POOL_ID = "eu-central-1:71122039-a3d7-4450-b3fb-f5c5ee33a8ec";
    const HOSTED_UI_DOMAIN = "https://eu-central-1nm2feul1j.auth.eu-central-1.amazoncognito.com";
    const REDIRECT_URI = "https://main.drlgxq3ev7tby.amplifyapp.com"; // asegúrate que esté en "Allowed callback URLs"
   const SCOPES = ["email"];

    // ========================
    // PKCE helpers
    // ========================
    async function sha256(buf) { return crypto.subtle.digest("SHA-256", buf); }
    function b64u(uint8) {
      return btoa(String.fromCharCode(...new Uint8Array(uint8)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
    async function createPKCE() {
      const verifier = b64u(crypto.getRandomValues(new Uint8Array(32)));
      const challenge = b64u(await sha256(new TextEncoder().encode(verifier)));
      // Guardamos el verifier en sessionStorage para que index.html pueda hacer el intercambio code->tokens
      sessionStorage.setItem("pkce_verifier", verifier);
      return { verifier, challenge };
    }

    // ========================
    // Lanzar Hosted UI (authorize)
    // ========================
    async function startLogin() {
      try {
        const { challenge } = await createPKCE();

        const url = new URL(`${HOSTED_UI_DOMAIN}/oauth2/authorize`);
        url.searchParams.set("client_id", APP_CLIENT_ID);
        url.searchParams.set("response_type", "code");
        url.searchParams.set("redirect_uri", REDIRECT_URI);
        url.searchParams.set("scope", SCOPES.join(" "));
        url.searchParams.set("code_challenge_method", "S256");
        url.searchParams.set("code_challenge", challenge);

        document.getElementById("out").textContent = "Redirigiendo al Hosted UI…";
        location.assign(url.toString());
      } catch (e) {
        document.getElementById("out").textContent = "❌ Error preparando login: " + (e?.message || e);
      }
    }

    // UI
    document.getElementById("loginBtn").addEventListener("click", startLogin);

    // Pequeña ayuda: si viniste aquí con ?error=... desde Cognito, muéstralo
    const params = new URLSearchParams(location.search);
    const err = params.get("error") || params.get("error_description");
    if (err) {
      document.getElementById("out").textContent = "⚠️ Cognito devolvió un error: " + err;
    }
  </script>
</body>
</html>
