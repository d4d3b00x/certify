<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arena Battle ‚Äì Quizzes Rel√°mpago</title>
<meta name="theme-color" content="#0b0f1e" />
<style>
:root{
  --bg:#0b0f1e;--panel:#0f1530;--panel2:#121a3b;--line:#26305e;--ink:#e8edff;--muted:#9fb2ff;
  --ok:#39e08d;--bad:#ff7d7d;--chip:#0f1736;--chipLine:#324081;--azure:#2a7bff22;--aws:#ff990022;
  --pill:#10183a;--accent:#7e6bff;--radius:14px;--shadow:0 16px 40px rgba(6,12,40,.45);
}
*{box-sizing:border-box}
html,body{margin:0;background:radial-gradient(1200px 600px at 80% -10%, rgba(126,107,255,.12),transparent 60%),radial-gradient(900px 500px at 0% -20%, rgba(124,212,255,.10),transparent 60%),var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

/* header */
header{background:#0e1328;border-bottom:1px solid var(--line)}
.nav{max-width:1260px;margin:0 auto;padding:10px 18px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.logo{width:28px;height:28px;border-radius:9px;background:linear-gradient(180deg,#8aa0ff,#425dff);box-shadow:0 0 0 6px rgba(130,150,255,.16)}
.nav-right{display:flex;gap:8px;align-items:center}
.badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--pill);border:1px solid #2b356a;font-weight:900}
.user{font-weight:900;border-radius:12px;padding:8px 12px;background:#0f183b;border:1px solid #2b356a}

/* container & layout */
.container{max-width:1260px;margin:0 auto;padding:18px}
.layout{display:grid;grid-template-columns:1fr 360px;gap:16px}
@media(max-width:1040px){.layout{grid-template-columns:1fr}}
.panel{background:linear-gradient(180deg,var(--panel),#0e1533);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}

/* head (dos l√≠neas ordenadas) */
.panel-head{display:grid;grid-template-columns:1fr auto;row-gap:8px;column-gap:12px;padding:12px;border-bottom:1px solid var(--line);background:var(--panel2)}
.h-row1{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.h-row2{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between}
.filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.filter{position:relative;display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--chipLine);background:linear-gradient(180deg,#0f1736,#121d48);border-radius:999px;font-weight:900;cursor:pointer;color:#dfe7ff}
.filter.active{background:linear-gradient(180deg,#7890ff,#5c70ff);color:#fff;border-color:#6f82ff;box-shadow:0 10px 22px rgba(80,95,255,.25)}
.filter[data-cert^="AZ"]::after{content:attr(data-count);position:absolute;right:-6px;top:-8px;font-size:.72rem;font-weight:900;background:#23306b;border:2px solid #6f82ff;color:#cfe1ff;border-radius:999px;padding:2px 6px}
.filter[data-cert^="SAA"]{background:linear-gradient(180deg,#1a1622,#2a1f30);border-color:#5d4670}
.filter[data-cert^="SAA"]::after{content:attr(data-count);position:absolute;right:-6px;top:-8px;font-size:.72rem;font-weight:900;background:#3a2c3f;border:2px solid #ff9900;color:#ffe6cc;border-radius:999px;padding:2px 6px}
.title-chip{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;border:1px solid var(--chipLine);background:var(--chip);font-weight:900}
.goal-wrap{display:flex;align-items:center;gap:10px}
.goal-pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--chipLine);background:var(--chip);border-radius:999px;padding:8px 12px;font-weight:900}
.prog{flex:1;position:relative;height:14px;border-radius:999px;background:#0b1028;border:1px solid var(--line);overflow:hidden;min-width:220px}
.prog>span{position:absolute;left:0;top:0;height:100%;width:0;background:linear-gradient(90deg,#3be180,#76f4bc);transition:width .35s ease}
.reset{padding:8px 14px;border-radius:999px;border:1px solid #4151a8;background:#111a3e;color:#dfe7ff;font-weight:900}

/* grid 3x3 */
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:12px}
@media(max-width:1040px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:620px){.grid{grid-template-columns:1fr}}

.card{position:relative;background:linear-gradient(180deg,#10183a,#0f1736);border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;grid-template-rows:auto auto 1fr auto;row-gap:8px}
.meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--chipLine);background:var(--chip);font-weight:900;white-space:nowrap}
.cert{background:var(--azure);border-color:#2d4eaa;color:#cfe6ff}
.cert.aws{background:var(--aws);border-color:#9c6b22;color:#ffe2c0}
.diff{gap:6px}
.diff .dot{width:10px;height:10px;border-radius:999px;background:#5ce083;box-shadow:0 0 0 4px rgba(92,224,131,.18)}
.diff.medio .dot{background:#ffd66b;box-shadow:0 0 0 4px rgba(255,214,107,.18)}
.diff.dificil .dot{background:#ff7d7d;box-shadow:0 0 0 4px rgba(255,125,125,.18)}
.xp::before{content:"‚ö°"}
.title{font-weight:900}
.desc{color:var(--muted)}
.controls{display:flex;gap:10px;align-items:center}
.play{flex:1;display:inline-flex;align-items:center;justify-content:center;height:42px;border-radius:12px;border:1px solid #4655a8;background:linear-gradient(180deg,#6677ff,#5a6df7);color:#fff;font-weight:900;cursor:pointer}
.kill{width:42px;height:42px;border-radius:12px;border:1px solid #3a4270;background:#111a33;color:#cfe1ff;cursor:pointer}

/* ribbons & fx */
.ribbon{position:absolute;right:-30px;bottom:14px;transform:rotate(-12deg);font-weight:900;padding:6px 30px;border-radius:10px;border:2px solid rgba(0,0,0,.15);box-shadow:0 8px 18px rgba(0,0,0,.25);display:none}
.card.win .ribbon{display:block;background:var(--ok);color:#05361c}
.card.fail .ribbon{display:block;background:var(--bad);color:#3b0a0a}
.card.out{opacity:0;transform:scale(.92) translateY(6px);transition:opacity .35s ease, transform .35s ease}
.card.new{animation:pop .35s ease}
@keyframes pop{0%{opacity:0;transform:scale(.9)}100%{opacity:1;transform:scale(1)}}

/* modal quiz */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:60}
.modal.show{display:flex}
.modal-card{width:min(820px,92vw);max-height:86vh;overflow:auto;background:var(--panel2);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px}
.mhead{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:10px}
.meta-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.close{border:1px solid var(--line);background:#182152;color:#cfe1ff;border-radius:10px;padding:8px 12px;font-weight:900;cursor:pointer}
.qbox{background:#0f1736;border:1px solid var(--line);border-radius:12px;padding:14px}
.qtitle{font-weight:900;margin:0 0 10px}
.opt{display:grid;grid-template-columns:auto 1fr;column-gap:10px;align-items:start;margin:8px 0;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0e1633;cursor:pointer}
.opt.correct{background:rgba(57,224,141,.10);border-color:rgba(57,224,141,.7)}
.opt.wrong{background:rgba(255,125,125,.10);border-color:rgba(255,125,125,.7)}

/* ranking + recomendado */
.sidebar{padding:12px}
.rtitle{font-weight:900;margin:0 0 10px}
.rlist{display:grid;gap:8px}
.rrow{display:grid;grid-template-columns:28px minmax(0,1fr) auto auto;gap:10px;align-items:center;background:#0f1736;border:1px solid var(--line);border-radius:12px;padding:8px 10px}
.rrow.me{outline:2px solid rgba(124,212,255,.55)}
.rname{font-weight:800;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rlvl,.rxp{display:inline-flex;align-items:center;gap:8px;background:#12204c;border:1px solid #3856a8;border-radius:999px;padding:6px 12px;font-weight:900}
.rxp::before{content:"‚ö°"}
.reco{margin-top:14px;padding:12px;background:#0f1736;border:1px solid var(--line);border-radius:12px}
.reco h4{margin:0;font-weight:900}

/* toast & fly chip */
.toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#12204c;border:1px solid #3856a8;color:#dfe7ff;padding:10px 14px;border-radius:12px;font-weight:900;z-index:80;display:none}
.toast.show{display:block;animation:fade 1.1s ease}
@keyframes fade{0%{opacity:0;transform:translate(-50%,-6px)}20%{opacity:1;transform:translate(-50%,0)}80%{opacity:1}100%{opacity:0}}

.fly{position:fixed;pointer-events:none;background:#12204c;border:1px solid #3856a8;color:#dfe7ff;padding:6px 10px;border-radius:999px;font-weight:900;z-index:90;box-shadow:0 10px 24px rgba(0,0,0,.4)}
/* rules (plegable) */
.rules{padding:12px;border-top:1px solid var(--line)}
.rule-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #4655a8;background:linear-gradient(180deg,#6677ff,#5a6df7);color:#fff;font-weight:900;cursor:pointer}
.rule-body{display:none;margin-top:10px;padding:16px;background:linear-gradient(180deg,#0e1533,#0d1431);border:1px solid var(--line);border-radius:12px}
.rule-body.show{display:block}

/* congrats modal */
#congrats .modal-card{max-width:560px}
</style>
</head>
<body>

<header>
  <div class="nav">
    <div class="brand"><span class="logo"></span><span>IT <strong>Hub</strong> .es</span></div>
    <div class="nav-right">
      <span class="badge" id="greeter">üëã Hola, Quizzer!</span>
      <span class="badge">Arena Battle</span>
      <span class="badge" id="badgeLv">Lv. 5</span>
      <span class="badge" id="badgeXP">‚ö° 5200</span>
      <span class="user">BALLESTER21</span>
    </div>
  </div>
</header>

<main class="container">
  <h1 style="margin:6px 0 2px">Arena Battle ‚Äì Quizzes Rel√°mpago</h1>
  <p style="color:#9fb2ff;margin:0 0 14px">Elige certificaci√≥n y resuelve misiones de 1, 2 o 3 preguntas. Acierta para puntuar y sube de nivel.</p>

  <div class="layout">
    <!-- ARENA -->
    <section class="panel" id="arena">
      <div class="panel-head">
        <!-- l√≠nea 1 -->
        <div class="h-row1">
          <div class="title-chip">üéØ Elige certificaci√≥n</div>
          <div class="filters" id="filters">
            <button class="filter active" data-cert="ALL">Todas</button>
            <button class="filter" data-cert="AZ-104" data-count="0">AZ-104</button>
            <button class="filter" data-cert="AZ-305" data-count="0">AZ-305</button>
            <button class="filter" data-cert="SAA-C03" data-count="0">SAA-C03</button>
          </div>
        </div>
        <!-- l√≠nea 2 -->
        <div class="h-row2">
          <div class="goal-wrap">
            <div class="goal-pill">üéØ <span id="goalTxt">0 / 70</span></div>
            <div class="prog"><span id="goalBar"></span></div>
          </div>
          <button id="btnReset" class="reset">RESET</button>
        </div>
      </div>

      <div class="grid" id="grid"></div>

      <div class="rules">
        <button class="rule-btn" id="toggleRules">üìñ Ver Reglas del juego</button>
        <div class="rule-body" id="rulesBody">
          <h3>Reglas</h3>
          <ul>
            <li>Tablero <b>3√ó3</b> (hasta 9 cartas). No se repiten misiones superadas.</li>
            <li><b>XP = nivel</b>: cada <b>1000 XP</b> subes <b>+1</b> nivel.</li>
            <li>Dificultad: <span class="chip diff"><span class="dot"></span>F√°cil</span> / <span class="chip diff medio"><span class="dot"></span>Medio</span> / <span class="chip diff dificil"><span class="dot"></span>Dif√≠cil</span>  
              ‚Üí a m√°s dif√≠cil, m√°s XP.</li>
            <li>Al acertar: aparece <b>YEAH :)</b>, sumas XP y la carta se sustituye por otra disponible.</li>
            <li>Al fallar: <b>OH NO :(</b> durante 2s y puedes reintentar m√°s tarde.</li>
            <li><b>Objetivo semanal</b>: al llegar a <b>70/70</b> ver√°s un modal de enhorabuena, recibes <b>+120 XP</b> y el objetivo se resetea.</li>
            <li><b>Completar una certificaci√≥n</b> (todas sus misiones) concede un <b>bonus de +500 XP</b>.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- SIDEBAR -->
    <aside class="panel">
      <div class="sidebar">
        <div class="rtitle">üèÜ Ranking tiempo real (Lv / XP)</div>
        <div class="rlist" id="rlist"></div>

        <div class="reco">
          <h4>üîó Recomendado</h4>
          <!-- vac√≠o a prop√≥sito -->
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- QUIZ MODAL -->
<div class="modal" id="modal">
  <div class="modal-card">
    <div class="mhead">
      <div class="meta-inline" id="mMeta"></div>
      <div class="meta-inline" id="mInfo"></div>
      <button class="close" id="mClose">CERRAR</button>
    </div>
    <div class="qbox">
      <h3 class="qtitle" id="mTitle">...</h3>
      <div id="mOpts"></div>
    </div>
  </div>
</div>

<!-- Congrats modal -->
<div class="modal" id="congrats">
  <div class="modal-card">
    <h2>üéâ ¬°Objetivo semanal completado!</h2>
    <p>Has alcanzado <b>70/70</b>. Recibes un <b>bonus de +120 XP</b> y el objetivo se reinicia para que sigas compitiendo.</p>
    <div style="text-align:right;margin-top:10px">
      <button class="close" id="cgOk">¬°A seguir!</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<!-- chip que vuela -->
<div class="fly" id="fly" style="display:none">+0 XP</div>

<script>
/* ================= BANK (ids √∫nicos, dominio¬∑concepto, dificultad) ================= */
const BANK = {
  "AZ-104":[
    {id:"az104_fd",   title:"Red ¬∑ Front Door (WAF/TLS)", diff:"dificil",  xp:36,  q:{q:"Servicio global L7 con WAF y TLS al edge",opts:["Traffic Manager","Azure Front Door","App GW","LB"], ok:1}},
    {id:"az104_id",   title:"Identidad ¬∑ Acceso",         diff:"medio",    xp:22,  q:{q:"Servicio para RBAC",opts:["Azure Policy","RBAC","Blueprints","PIM"], ok:1}},
    {id:"az104_st",   title:"Almacenamiento ¬∑ Inmutabilidad", diff:"medio",xp:22,  q:{q:"WORM legal",opts:["Soft delete","Immutable Time-based","Versioning","GZRS"], ok:1}},
    {id:"az104_net",  title:"Red ¬∑ Multizona web",        diff:"facil",    xp:10,  q:{q:"TLS + WAF gestionado",opts:["Front Door","App GW","LB","TM"], ok:0}},
    {id:"az104_bast", title:"Seguridad ¬∑ Acceso VM",      diff:"facil",    xp:10,  q:{q:"SSH temporal sin 22 abierto",opts:["Bastion","JIT Defender","NSG Allow","IP p√∫blica"], ok:1}}
  ],
  "AZ-305":[
    {id:"az305_tag",  title:"Gobernanza ¬∑ Etiquetado",    diff:"facil",    xp:10,  q:{q:"Imponer tags y regiones",opts:["RBAC","Policy (iniciativa)","Advisor","Arc"], ok:1}},
    {id:"az305_vwan", title:"Red ¬∑ Hub global seguro",    diff:"medio",    xp:22,  q:{q:"Opci√≥n recomendada",opts:["Mesh","vWAN + Hub seguro","NVAs en spokes","App GW"], ok:1}},
    {id:"az305_cos",  title:"Datos ¬∑ Global multi-master",diff:"medio",    xp:22,  q:{q:"DB adecuada",opts:["SQL MI","Cosmos DB","PG Flex","VM"], ok:1}},
    {id:"az305_evt",  title:"Serverless ¬∑ Eventos Blobs", diff:"facil",    xp:10,  q:{q:"Patr√≥n correcto",opts:["WebJobs","Functions + Event Grid","Timer","Service Fabric"], ok:1}},
    {id:"az305_front",title:"Edge ¬∑ WAF + TLS",           diff:"dificil",  xp:36,  q:{q:"Servicio",opts:["LB","AFD","TM","App GW Basic"], ok:1}}
  ],
  "SAA-C03":[
    {id:"saa_sns",    title:"Eventos ¬∑ SNS fanout",       diff:"dificil",  xp:36,  q:{q:"Patr√≥n fanout",opts:["SQS FIFO","SNS","S3 events","Kinesis FH"], ok:1}},
    {id:"saa_s3vpce", title:"Red ¬∑ S3 sin Internet",      diff:"medio",    xp:22,  q:{q:"Acceso privado",opts:["Gateway VPCE","Interface","NAT","IGW"], ok:0}},
    {id:"saa_secr",   title:"Seguridad ¬∑ Secrets Manager",diff:"facil",    xp:10,  q:{q:"Gesti√≥n de secretos con rotaci√≥n",opts:["Param Store","KMS","Secrets Manager","CloudHSM"], ok:2}},
    {id:"saa_rds",    title:"HA ¬∑ RDS Multi-AZ",          diff:"facil",    xp:10,  q:{q:"Failover autom√°tico",opts:["Multi-AZ","Aurora Srv","DynamoDB","Replica"], ok:0}},
    {id:"saa_cf",     title:"CDN ¬∑ CloudFront",           diff:"medio",    xp:22,  q:{q:"CDN global",opts:["ALB","CloudFront","NLB","GA"], ok:1}}
  ]
};

/* ================= STATE ================= */
const GRID_SIZE = 9;
let filterCert = "ALL";

// XP / LEVEL
let userXP = 5200; 
let userLv = Math.floor(userXP/1000);
const badgeXP = document.getElementById('badgeXP');
const badgeLv = document.getElementById('badgeLv');

function addXP(x){
  userXP += x;
  const oldLv = userLv;
  userLv = Math.floor(userXP/1000);
  badgeXP.textContent = `‚ö° ${userXP}`;
  if(userLv>oldLv){ badgeLv.textContent = `Lv. ${userLv}`; pulse(badgeLv); }
}

// Weekly goal
let weekly = Number(localStorage.getItem('weekly')||"12");
const goalTxt = document.getElementById('goalTxt');
const goalBar = document.getElementById('goalBar');
function updateGoal(v){
  weekly = Math.min(70, Math.max(0, v));
  localStorage.setItem('weekly', weekly);
  goalTxt.textContent = `${weekly} / 70`;
  goalBar.style.width = `${(weekly/70)*100}%`;
}

// Pools: remaining, inPlay, completed
const remaining = {};
const inPlay = {};
const completed = {};
Object.keys(BANK).forEach(c=>{
  remaining[c]=new Set(BANK[c].map(x=>x.id));
  inPlay[c]=new Set();
  completed[c]=new Set();
});

// DOM refs
const grid = document.getElementById('grid');
const filters = document.getElementById('filters');

// helper
const rand = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;
const byId = (id)=> {
  for(const c of Object.keys(BANK)){ const f=BANK[c].find(x=>x.id===id); if(f) return f; }
  return null;
};
function availableIds(cert){ // ids que no est√°n en juego y siguen pendientes
  const ids = Array.from(remaining[cert]).filter(id=>!inPlay[cert].has(id));
  return ids;
}
function pickOne(cert){
  const pool = availableIds(cert);
  if(pool.length===0) return null;
  return pool[rand(0,pool.length-1)];
}
function updateFilterCounts(){
  for(const btn of filters.querySelectorAll('.filter[data-cert]')){
    const c = btn.dataset.cert;
    if(c==="ALL") continue;
    btn.setAttribute('data-count', remaining[c].size);
  }
}

// construir grid seg√∫n filtro
function buildGrid(){
  grid.innerHTML = '';
  // vaciar inPlay para reconstruir limpio en el filtro actual
  Object.keys(inPlay).forEach(c=> inPlay[c].clear());
  const addCard = (id)=>{
    if(!id) return;
    const m = byId(id);
    const card = createCard(m);
    grid.appendChild(card);
    inPlay[mCert(m).cert].add(id);
  };
  if(filterCert==="ALL"){
    // repartir entre certificaciones mientras haya sitio y disponibles
    let slots = GRID_SIZE;
    const order = Object.keys(BANK);
    let guard = 0;
    while(slots>0 && guard<100){
      guard++;
      // seleccionar la pr√≥xima cert con disponibles
      let picked = null, pickedCert=null;
      for(const c of order){
        const id = pickOne(c);
        if(id){ picked=id; pickedCert=c; break; }
      }
      if(!picked) break;
      addCard(picked);
      slots--;
    }
  }else{
    const ids = availableIds(filterCert).slice(0, GRID_SIZE);
    ids.forEach(addCard);
  }
  updateFilterCounts();
}
function mCert(m){ // devuelve {cert}
  for(const c of Object.keys(BANK)) if(BANK[c].some(x=>x.id===m.id)) return {cert:c};
  return {cert:""};
}

/* ============== CARD / QUIZ FLOW ============== */
const modal = document.getElementById('modal');
const mClose = document.getElementById('mClose');
const mMeta = document.getElementById('mMeta');
const mInfo = document.getElementById('mInfo');
const mTitle = document.getElementById('mTitle');
const mOpts = document.getElementById('mOpts');

let activeCard=null, activeMission=null;

function createCard(m){
  const {cert} = mCert(m);
  const diff = m.diff; const xp = m.xp;
  const card = document.createElement('article');
  card.className='card new';
  card.dataset.id = m.id; card.dataset.cert = cert;
  const aws = (cert==="SAA-C03")?' aws':'';
  card.innerHTML = `
    <div class="meta">
      <span class="chip cert${aws}">${cert}</span>
      <span class="chip diff ${diff}"><span class="dot"></span>${cap(diff)}</span>
      <span class="chip xp">+${xp} XP</span>
    </div>
    <div class="title">${m.title}</div>
    <div class="desc">Acierta para puntuar.</div>
    <div class="controls">
      <button class="play">JUGAR</button>
      <button class="kill" title="Quitar">‚úñ</button>
    </div>
    <div class="ribbon">YEAH :)</div>
  `;
  card.querySelector('.play').onclick=()=>openMission(card,m);
  card.querySelector('.kill').onclick=()=>removeCard(card,false);
  return card;
}

function openMission(card,m){
  activeCard=card; activeMission=m;
  const {cert} = mCert(m);
  mMeta.innerHTML = `
    <span class="chip cert ${cert==="SAA-C03"?'aws':''}">${cert}</span>
    <span class="chip diff ${m.diff}"><span class="dot"></span>${cap(m.diff)}</span>
    <span class="chip xp">+${m.xp} XP</span>`;
  mInfo.textContent = "Selecciona la respuesta correcta";
  mTitle.textContent = m.q.q;
  mOpts.innerHTML='';
  m.q.opts.forEach((t,idx)=>{
    const el = document.createElement('label');
    el.className='opt';
    el.innerHTML=`<input type="radio" name="opt"> <span>${t}</span>`;
    el.onclick=()=>{
      const correct = (idx===m.q.ok);
      Array.from(mOpts.children).forEach((o,i)=>{
        o.classList.toggle('correct', i===m.q.ok);
        if(i===idx && !correct) o.classList.add('wrong');
      });
      setTimeout(()=> correct? onWin(m) : onFail(), 350);
    };
    mOpts.appendChild(el);
  });
  modal.classList.add('show');
}
mClose.onclick=()=>modal.classList.remove('show');
modal.addEventListener('click',e=>{if(e.target===modal) modal.classList.remove('show');});

function removeCard(card, consume){
  const cert = card.dataset.cert, id = card.dataset.id;
  // si consume = true (acertada) pasa a completed, si no, vuelve a remaining
  inPlay[cert].delete(id);
  if(consume){ remaining[cert].delete(id); completed[cert].add(id); }
  // bonus si completas toda la cert
  if(consume && remaining[cert].size===0){
    addXP(500); showToast("üéñÔ∏è ¬°Certificaci√≥n completa! +500 XP");
  }
  // reemplazar por otra disponible
  const nxt = pickOne(cert);
  card.classList.add('out');
  setTimeout(()=>{
    card.remove();
    if(nxt){
      const m = byId(nxt);
      grid.appendChild(createCard(m));
      inPlay[cert].add(nxt);
    }
    updateFilterCounts();
  },350);
}

function onWin(m){
  modal.classList.remove('show');
  const card = activeCard;
  card.classList.remove('fail'); card.classList.add('win');
  card.querySelector('.ribbon').textContent = 'YEAH :)';

  // sumar XP + goal preguntas (1 misi√≥n = 1 pregunta en este banco)
  addXP(m.xp);
  updateGoal(weekly+1);
  flyToMe(`+${m.xp} XP`, card);

  setTimeout(()=> removeCard(card,true), 1100);
  // congrats weekly
  if(weekly>=70){ setTimeout(()=>showCongrats(), 700); }
}
function onFail(){
  modal.classList.remove('show');
  const card = activeCard;
  card.classList.remove('win'); card.classList.add('fail');
  card.querySelector('.ribbon').textContent = 'OH NO :(';
  setTimeout(()=> card.classList.remove('fail'), 2000);
}

/* ============== Ranking (me) ============== */
const players = [
  {name:"CloudNinja", lv:11, xp:10614},
  {name:"AKS_Master", lv:10, xp:9748},
  {name:"S3Wizard",   lv:10, xp:9457},
  {name:"Ballester21",lv:userLv, xp:userXP, me:true},
  {name:"NetSecX",    lv:8,  xp:7631},
  {name:"DevOpsGuy",  lv:7,  xp:6532},
  {name:"KubeQueen",  lv:7,  xp:6400},
  {name:"IaCWizard",  lv:6,  xp:5890},
  {name:"StackHero",  lv:6,  xp:5710},
  {name:"LambdaLad",  lv:5,  xp:4980}
];
const rlist = document.getElementById('rlist');

function renderRanking(){
  // refrescar mis datos
  const me = players.find(p=>p.me);
  me.xp = userXP; me.lv = userLv;
  players.sort((a,b)=> b.xp - a.xp);
  rlist.innerHTML='';
  players.slice(0,10).forEach((p,i)=>{
    const row = document.createElement('div');
    row.className = 'rrow'+(p.me?' me':'');
    row.dataset.name = p.name;
    row.innerHTML = `
      <div>${i+1}</div>
      <div class="rname">${p.name}</div>
      <div class="rlvl">Lv ${p.lv}</div>
      <div class="rxp">${p.xp}</div>`;
    rlist.appendChild(row);
  });
}
setInterval(()=>{ // tick fake
  const idx = rand(0, players.length-1); if(players[idx].me) return;
  players[idx].xp += rand(1,15); players[idx].lv = Math.floor(players[idx].xp/1000);
  renderRanking();
}, 1800);

/* ============== UI utils ============== */
function cap(s){return s[0].toUpperCase()+s.slice(1)}
function pulse(el){el.animate([{transform:'scale(1)'},{transform:'scale(1.08)'},{transform:'scale(1)'}],{duration:420});}
const toast = document.getElementById('toast');
function showToast(t){ toast.textContent=t; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1100); }

const fly = document.getElementById('fly');
function flyToMe(text, fromCard){
  const meRow = rlist.querySelector('.rrow.me'); if(!meRow) return;
  const start = fromCard.getBoundingClientRect();
  const end   = meRow.getBoundingClientRect();
  fly.textContent = text;
  fly.style.display='block';
  fly.style.left = (start.left+start.width/2)+'px';
  fly.style.top  = (start.top)+'px';
  fly.animate([
    {transform:'translate(-50%,0)', opacity:1},
    {transform:`translate(${end.left - (start.left+start.width/2)}px, ${end.top - start.top}px)`, opacity:0.6}
  ],{duration:1200, easing:'cubic-bezier(.2,.9,.2,1)'}).onfinish=()=>{
    fly.style.display='none';
    renderRanking(); // asegurar refresco visual
  };
}

/* congrats weekly */
const congrats = document.getElementById('congrats');
document.getElementById('cgOk').onclick = ()=>{ congrats.classList.remove('show'); updateGoal(0); };
function showCongrats(){ congrats.classList.add('show'); addXP(120); renderRanking(); }

/* rules toggle + scroll */
const rulesBtn = document.getElementById('toggleRules');
const rulesBody = document.getElementById('rulesBody');
rulesBtn.onclick=()=>{
  rulesBody.classList.toggle('show');
  rulesBtn.textContent = rulesBody.classList.contains('show') ? "üìñ Ocultar Reglas" : "üìñ Ver Reglas del juego";
  if(rulesBody.classList.contains('show')) rulesBody.scrollIntoView({behavior:'smooth',block:'start'});
};

/* filters */
filters.addEventListener('click', e=>{
  const b = e.target.closest('.filter'); if(!b) return;
  document.querySelectorAll('.filter').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  filterCert = b.dataset.cert;
  buildGrid();
});

/* reset */
document.getElementById('btnReset').onclick=()=>{
  updateGoal(0);
  showToast('üîÑ Progreso semanal a 0');
};

/* INIT */
function init(){
  // saluda con destello
  document.getElementById('greeter').animate([{filter:'brightness(1)'},{filter:'brightness(1.4)'},{filter:'brightness(1)'}],{duration:900});
  updateGoal(weekly);
  updateFilterCounts();
  buildGrid();
  renderRanking();
}
init();
</script>
</body>
</html>
