<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DYZ3GCXHEK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-DYZ3GCXHEK');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IT Hub .es — Ranking</title>
  <link rel="stylesheet" href="/style_global.css"/>
  <style>
    :root{
      --bg:#0f1320; --surface:#161b2d; --surface2:#1b2140; --ink:#e8ecff; --muted:#9ca8d9;
      --stroke:#283056; --brand:#6c8bff; --radius:14px; --shadow:0 12px 28px rgba(6,12,40,.45);
      --aws:#ff9900; --azure:#0078d4; --aws-2:#ffb84d; --azure-2:#5fb3ff;
      --violet:#7b5cff; --violet-2:#6246ff;
      --gold:#ffd662; --silver:#e6e6e6; --bronze:#e2a97a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Helvetica Neue","Noto Sans",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 420px at 90% -10%,rgba(255,153,0,.12),transparent 60%),
        radial-gradient(800px 400px at 10% 0%,rgba(0,120,212,.12),transparent 60%),
        var(--bg);
      line-height:1.6;
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:0 20px}

    /* ===== Header estilo captura ===== */
    header{position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);
      background:linear-gradient(180deg,rgba(15,19,32,.85),rgba(15,19,32,.55));
      border-bottom:1px solid var(--stroke)}
    .nav{height:56px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
    .brand .logo{width:22px;height:22px;border-radius:6px;background:linear-gradient(180deg,#7b8cff,#4c66ff);box-shadow:0 0 0 6px rgba(108,139,255,.18)}
    .brand span{opacity:.9}
    .brand small{opacity:.6;font-weight:800}
    .menu{display:none;gap:28px;color:var(--muted);font-weight:900;letter-spacing:.04em}
    .menu a{text-transform:uppercase}
    .menu a:hover{color:#fff}
    @media(min-width:720px){.menu{display:flex}}

    .actions{display:flex;align-items:center;gap:10px}
    .userbox{
      display:flex;align-items:center;gap:12px;padding:8px 10px 8px 12px;
      border:1px solid var(--stroke);border-radius:999px;background:rgba(17,23,55,.55)
    }
    .userbox .name{font-weight:900;letter-spacing:.02em;opacity:.95}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:12px;border:1px solid var(--stroke);
      cursor:pointer;font-weight:800;background:transparent;color:var(--ink)
    }
    .btn.primary{background:linear-gradient(180deg,var(--violet),var(--violet-2));border:none;box-shadow:var(--shadow);color:#fff}
    .btn.ghost{background:transparent;border:1px solid var(--stroke)}
    .btn.equal{min-width:92px}

    /* ===== Página ===== */
    .wrap{padding:22px 0 28px}
    .card{background:linear-gradient(180deg,#111937,#0f1633);border:1px solid var(--stroke);
      border-radius:16px;padding:18px 18px;box-shadow:var(--shadow)}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:6px 0 12px}
    .header-row h2{margin:0;color:#fff;font-size:1.35rem;font-weight:900;letter-spacing:.2px}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      appearance:none;border:1px solid var(--stroke);background:var(--surface2);color:#e8ecff;
      padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:800
    }
    .pill[aria-pressed="true"]{outline:2px solid rgba(108,139,255,.3)}

    .section-title{display:flex;align-items:center;justify-content:space-between;margin:16px 0 8px}
    .section-title h3{margin:0;font-size:1.05rem}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:.8rem;
      background:var(--surface2);color:#cbd6ff;border:1px solid var(--stroke)}
    .badge.aws{background:rgba(255,153,0,.12);border-color:rgba(255,153,0,.35);color:#ffd9a1}
    .badge.az{background:rgba(0,120,212,.14);border-color:rgba(0,120,212,.35);color:#bcd9ff}

    .table-wrap{background:var(--surface);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);padding:14px;overflow:auto}
    .rank-table{width:100%;min-width:760px;border-collapse:separate;border-spacing:0}
    .rank-table thead th{
      position:sticky;top:0;z-index:1;background:var(--surface2);color:#e8ecff;
      font-weight:800;letter-spacing:.02em;text-align:center;padding:12px 10px;border-bottom:1px solid var(--stroke)
    }
    .rank-table tbody td{padding:12px 10px;text-align:center;border-bottom:1px solid #1f2747;background:#0f1430;color:#e8ecff}
    .rank-table tbody tr:nth-child(even) td{background:#101738}
    .rank-table tbody tr:hover td{background:#0e1536}
    .rank-table thead th:first-child{border-top-left-radius:12px}
    .rank-table thead th:last-child{border-top-right-radius:12px}
    .col-rank{width:64px}
    .col-name{text-align:center}
    .col-num{width:110px;font-variant-numeric:tabular-nums}
    .col-date{width:200px}
    .col-points{width:140px}

    /* Medallas (visibles) */
    .medal{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;font-weight:800;color:#1b1830}
    .medal.gold{background:linear-gradient(135deg,#ffd662,#ffb300);box-shadow:0 2px 6px rgba(255,179,0,.35)}
    .medal.silver{background:linear-gradient(135deg,#e6e6e6,#bfbfbf);box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .medal.bronze{background:linear-gradient(135deg,#e2a97a,#d18d5a);box-shadow:0 2px 6px rgba(0,0,0,.12)}

    /* Nombre destacado y color por medalla */
    .name-strong{font-weight:900}
    .name-gold{color:var(--gold)}
    .name-silver{color:var(--silver)}
    .name-bronze{color:var(--bronze)}

    /* Chips de puntos: azul solo Top 3, neutro resto */
    .points-chip{
      display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;
      font-weight:900;border:1px solid var(--stroke);background:var(--surface2);color:#e8ecff
    }
    .points-chip.top{
      background:linear-gradient(180deg,#6c8bff,#3e64ff);
      color:#fff;border:none;box-shadow:var(--shadow)
    }

    .pct{display:flex;align-items:center;justify-content:center;gap:8px;font-variant-numeric:tabular-nums;font-weight:800}
    .pbar{position:relative;flex:1 1 120px;height:8px;background:#0a0f25;border-radius:999px;overflow:hidden;max-width:160px}
    .pbar>i{position:absolute;left:0;top:0;bottom:0;width:0%}
    .pbar>i.aws{background:linear-gradient(90deg,var(--aws),var(--aws-2))}
    .pbar>i.az{background:linear-gradient(90deg,var(--azure),var(--azure-2))}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;background:var(--surface2);color:#e8ecff;border:1px solid var(--stroke);font-weight:700}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav">
      <div class="brand">
        <i class="logo"></i>
        <span>IT&nbsp;Hub</span> <small>.es</small>
      </div>
      <nav class="menu">
        <a href="/">HOME</a>
        <a href="/#simuladores">SIMULADORES</a>
        <a href="/#contenidos">CONTENIDOS</a>
      </nav>
      <div class="actions" id="navActions"></div>
    </div>
  </header>

  <main class="container wrap">
    <section class="card">
      <div class="header-row">
        <h2>📊 Ranking global (Top 10 recientes por certificación)</h2>
        <div class="filters" role="tablist" aria-label="Filtrar por examen">
          <button class="pill" id="flt-all" role="tab" aria-pressed="true" onclick="setFilter('all')">Todos</button>
          <button class="pill" id="flt-az" role="tab" aria-pressed="false" onclick="setFilter('az-104')">AZ-104</button>
          <button class="pill" id="flt-aws" role="tab" aria-pressed="false" onclick="setFilter('aws-saa-c03')">SAA-C03</button>
        </div>
      </div>

      <div id="container"></div>
    </section>
  </main>

  <script>
    /* ======= Cabecera: sesión ======= */
    function getUserAny(){
      let u=null;
      try{u=JSON.parse(localStorage.getItem("currentUser")||"null")}catch{}
      if(!u){try{u=JSON.parse(localStorage.getItem("certify_user")||"null")}catch{}}
      return u;
    }
    function renderHeaderUser(){
      const box=document.getElementById('navActions');
      const u=getUserAny();
      if(u && (u.name||u.displayName||u.userName)){
        const name = (u.name||u.displayName||u.userName||'Usuario').toUpperCase();
        box.innerHTML = `
          <div class="userbox">
            <span>🔥 <span class="name">${name}</span></span>
            <a class="btn primary equal" href="/user/profile.html">PERFIL</a>
            <button class="btn primary equal" id="logoutBtn">SALIR</button>
          </div>
        `;
        document.getElementById('logoutBtn')?.addEventListener('click', ()=>{
          try{ localStorage.removeItem('currentUser'); localStorage.removeItem('certify_user'); }catch{}
          location.reload();
        });
      } else {
        box.innerHTML = `
          <a class="btn ghost equal" href="/login/login.html">Login</a>
          <a class="btn primary equal" href="/login/login.html#signup">Crear cuenta</a>
        `;
      }
    }
    renderHeaderUser();

    /* ======= Ranking logic ======= */
    const API_BASE = "https://uougu1cm26.execute-api.eu-central-1.amazonaws.com";
    const QUIZZES = ["az-104","aws-saa-c03"];

    // utils
    const toInt = v => Number.isFinite(Number(v)) ? (Number(v)|0) : 0;
    const toNum = v => Number.isFinite(Number(v)) ? Number(v) : 0;
    const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const pad = n => String(n).padStart(2,'0');

    function fmtDuration(sec){
      sec = toInt(sec);
      if (!sec || sec < 0) return "—";
      const m = Math.floor(sec/60), s = sec%60;
      return `${pad(m)}:${pad(s)}`;
    }
    function fmtDate(iso){
      if (!iso) return "—";
      try{
        return new Date(iso).toLocaleString([], {year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      }catch{ return iso; }
    }
    const pick = v => (typeof v === "string" ? v.trim() : "");
    const getName = x => pick(x.userName)||pick(x.username)||pick(x.displayName)||pick(x.name)||pick(x?.user?.name)||pick(x?.profile?.name)||"(no name)";
    function pct01(r){
      const t = toInt(r.total), c = toInt(r.correct);
      if (t > 0) return Math.max(0, Math.min(1, c / t));
      const p = toNum(r.pct);
      return Math.max(0, Math.min(1, p > 1 ? p/100 : p));
    }

    // API
    async function fetchAll(limit=1000){
      const res = await fetch(`${API_BASE}/results?limit=${limit}`, {mode:"cors", cache:"no-store"});
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
      const items = Array.isArray(data.items) ? data.items : [];
      return items.map(x => {
        const correct = toInt(x.correct);
        return {
          userId: x.userId || "(unknown)",
          userName: getName(x),
          quizId: (x.quizId || "-").toLowerCase(),
          correct,
          total: toInt(x.total),
          pct: toNum(x.pct ?? (x.total ? (toInt(x.correct)/toInt(x.total))*100 : 0)),
          points: correct * 5,                 // PUNTOS
          durationSec: toInt(x.durationSec),
          ts: x.ts || null
        };
      });
    }

    function latest10PerQuizRanked(rows){
      const byQuiz = Object.fromEntries(QUIZZES.map(q => [q, []]));
      rows.forEach(r => { if (byQuiz[r.quizId]) byQuiz[r.quizId].push(r); });

      for (const q of QUIZZES){
        byQuiz[q].sort((a,b)=> (b.ts||"").localeCompare(a.ts||""));
        byQuiz[q] = byQuiz[q].slice(0,10).map(r => {
          const timeSafe = r.ts ? new Date(r.ts).getTime() : 0;
          const durationSafe = (toInt(r.durationSec) > 0) ? toInt(r.durationSec) : Number.MAX_SAFE_INTEGER;
          return { ...r, pct01: pct01(r), timeSafe, durationSafe };
        });
        // Orden principal por PUNTOS
        byQuiz[q].sort((a,b)=>{
          if (b.points !== a.points) return b.points - a.points;
          if (b.correct !== a.correct) return b.correct - a.correct;
          if (b.total !== a.total) return b.total - a.total;
          if (a.durationSafe !== b.durationSafe) return a.durationSafe - b.durationSafe;
          return a.timeSafe - b.timeSafe;
        });
      }
      return byQuiz;
    }

    function medalCell(i){
      if (i===0) return `<span class="medal gold">1</span>`;
      if (i===1) return `<span class="medal silver">2</span>`;
      if (i===2) return `<span class="medal bronze">3</span>`;
      return String(i+1);
    }
    function nameClassByIndex(i){
      if (i===0) return "name-strong name-gold";
      if (i===1) return "name-strong name-silver";
      if (i===2) return "name-strong name-bronze";
      return "name-strong";
    }
    function pointsChipClass(i){
      return i<3 ? "points-chip top" : "points-chip";
    }

    function tableHTML(rows, title, quizId){
      const isAz = quizId==="az-104";
      const badgeCls = isAz ? "badge az" : "badge aws";
      const pbarCls = isAz ? "az" : "aws";

      if (!rows.length){
        return `
          <div class="section-title">
            <h3>${title}</h3>
            <span class="${badgeCls}">${quizId}</span>
          </div>
          <div class="table-wrap"><p style="text-align:center;margin:18px 0;color:var(--muted)">No hay resultados aún.</p></div>
        `;
      }

      let html = `
        <div class="section-title">
          <h3>${title}</h3>
          <span class="${badgeCls}">${quizId}</span>
        </div>
        <div class="table-wrap">
          <table class="rank-table">
            <thead>
              <tr>
                <th class="col-rank">#</th>
                <th class="col-points">Puntos</th>
                <th class="col-name">Nombre</th>
                <th class="col-num">Correctas</th>
                <th class="col-num">Total</th>
                <th class="col-num">Puntuación</th>
                <th class="col-num">Duración</th>
                <th class="col-date">Fecha</th>
              </tr>
            </thead>
            <tbody>
      `;
      rows.forEach((r,i)=>{
        const pct = Math.round(Math.min(100, Math.max(0, r.pct01*100)));
        html += `
          <tr>
            <td class="col-rank">${medalCell(i)}</td>
            <td class="col-points"><span class="${pointsChipClass(i)}">⭐ ${r.points}</span></td>
            <td class="col-name"><span class="${nameClassByIndex(i)}">${escapeHtml(r.userName)}</span></td>
            <td class="col-num">${r.correct}</td>
            <td class="col-num">${r.total}</td>
            <td class="col-num">
              <div class="pct">
                <div class="pbar"><i class="${pbarCls}" style="width:${pct}%"></i></div>
                <span>${pct}%</span>
              </div>
            </td>
            <td class="col-num"><span class="chip">${fmtDuration(r.durationSec)}</span></td>
            <td class="col-date">${fmtDate(r.ts)}</td>
          </tr>
        `;
      });
      html += `</tbody></table></div>`;
      return html;
    }

    function renderView(allByQuiz, filter){
      const c = document.getElementById("container");
      const pills = { all:document.getElementById("flt-all"), az:document.getElementById("flt-az"), aws:document.getElementById("flt-aws") };
      pills.all.setAttribute("aria-pressed", String(filter==="all"));
      pills.az.setAttribute("aria-pressed", String(filter==="az-104"));
      pills.aws.setAttribute("aria-pressed", String(filter==="aws-saa-c03"));

      if (filter==="all"){
        c.innerHTML =
          tableHTML(allByQuiz["az-104"], "Microsoft Azure Administrator (AZ-104)", "az-104") +
          tableHTML(allByQuiz["aws-saa-c03"], "AWS Solutions Architect Associate (SAA-C03)", "aws-saa-c03");
      } else {
        const title = filter==="az-104" ? "Microsoft Azure Administrator (AZ-104)" : "AWS Solutions Architect Associate (SAA-C03)";
        c.innerHTML = tableHTML(allByQuiz[filter], title, filter);
      }
    }

    let cacheAllByQuiz = null;
    async function loadAndRender(filter="all"){
      const container = document.getElementById("container");
      container.innerHTML = `<div class="table-wrap" style="text-align:center;color:var(--muted)">Cargando…</div>`;
      if (!cacheAllByQuiz){
        const rows = await fetchAll(1000);
        cacheAllByQuiz = latest10PerQuizRanked(rows);
      }
      renderView(cacheAllByQuiz, filter);
    }

    function setFilter(filter){
      const allowed = ["all","az-104","aws-saa-c03"];
      if (!allowed.includes(filter)) filter = "all";
      const q = new URLSearchParams(location.search);
      if (filter==="all") q.delete("quiz"); else q.set("quiz", filter);
      history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
      loadAndRender(filter);
    }
    function initFromURL(){
      const q = new URLSearchParams(location.search);
      const filter = (q.get("quiz")||"all").toLowerCase();
      setFilter(filter);
    }
    document.addEventListener("DOMContentLoaded", initFromURL);
  </script>
</body>
</html>
