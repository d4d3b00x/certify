<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ranking global de simuladores. Certificaciones IT | ITHub.es</title>
  <meta name="description" content="Consulta el ranking global de jugadores en los simuladores de certificaciones IT de ITHub.es. Compara tu puntuaci√≥n, sube de nivel y mide tu progreso frente a otros candidatos." />
  <link rel="canonical" href="https://www.ithub.es/score/ranking.html" />
  <meta name="robots" content="index,follow" />

  <meta property="og:title" content="Ranking global de simuladores de certificaci√≥n" />
  <meta property="og:description" content="Descubre tu posici√≥n en el ranking global de ITHub.es y compite mientras preparas tus certificaciones Azure y AWS." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.ithub.es/score/ranking.html" />
  <meta property="og:site_name" content="ITHub.es" />

  <link rel="icon" type="image/svg+xml" 
        href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop stop-color='%238aa0ff'/><stop offset='1' stop-color='%23425dff'/></linearGradient></defs><rect rx='12' width='64' height='64' fill='url(%23g)'/><text x='32' y='42' font-family='Segoe UI,Arial' font-size='28' fill='white' font-weight='900' text-anchor='middle'>IT</text></svg>">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Roboto+Condensed:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1320; --surface:#161b2d; --surface2:#1b2140; --ink:#e8ecff; --muted:#9ca8d9;
      --stroke:#283056; --shadow:0 12px 28px rgba(6,12,40,.45);
      --violet:#7b5cff; --violet-2:#6246ff;
      --gold:#ffd662; --silver:#e6e6e6; --bronze:#e2a97a;
      --chip:#0f1430; --chip2:#101738;
      --tab-bg:#1b2140; --tab-on:rgba(108,139,255,.3);
      --grad1:rgba(255,153,0,.12); --grad2:rgba(0,120,212,.12);
      --azulite1:#6c8bff; --azulite2:#3e64ff; --azuliteDot:#a9bbff;

      /* Header global ITHub */
      --brand:#6c8bff;
      --pill-bg:linear-gradient(180deg,#151b31,#12182c);
      --pill-ring:#2a3150;
      --pill-btn-bg:linear-gradient(180deg,#7a67ff,#5f48ff);
      --pill-btn-bg-hover:linear-gradient(180deg,#8a78ff,#6b54ff);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Roboto Condensed","Inter",ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Helvetica Neue",sans-serif;
      font-weight:400;color:var(--ink);
      font-size:17px;
      line-height:1.45;
      background:
        radial-gradient(900px 420px at 90% -10%,var(--grad1),transparent 60%),
        radial-gradient(800px 400px at 10% 0%,var(--grad2),transparent 60%),
        var(--bg);
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:0 20px}

    /* ===== Header com√∫n (usa /includes/header.html) ===== */
    header{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:blur(10px);
      background:linear-gradient(180deg,rgba(15,19,32,.92),rgba(15,19,32,.72));
      border-bottom:1px solid var(--stroke);
    }
    .nav{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      text-transform:uppercase;
    }
    .brand img.site-logo{
      height:42px;
      width:auto;
      display:block;
    }
    nav.menu{
      display:flex;
      gap:16px;
      color:var(--muted);
      font-weight:800;
      align-items:center;
      text-transform:uppercase;
    }
    nav.menu .link-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:110px;
      min-height:44px;
      height:40px;
      padding:0 12px;
      border-radius:10px;
      border:1px solid transparent;
      font-weight:900;
      letter-spacing:.8px;
    }
    nav.menu .link-btn:hover{
      border-color:#2a3150;
      color:var(--ink);
    }

    .authwrap{
      display:flex;
      align-items:center;
      gap:6px;
      background:var(--pill-bg);
      border:1px solid var(--pill-ring);
      border-radius:999px;
      padding:4px;
      box-shadow:0 6px 18px rgba(5,10,30,.35);
      max-height:44px;
    }
    .hello{
      display:flex;
      align-items:center;
      gap:6px;
      color:#cbd3ff;
      font-weight:800;
      padding:4px 8px;
      font-size:12px;
    }
    .pill-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:100px;
      min-height:44px;
      height:34px;
      padding:0 14px;
      border-radius:12px;
      border:1px solid #3b2fff44;
      background:var(--pill-btn-bg);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      transition:transform .08s, background .12s;
      font-size:13px;
      text-transform:uppercase;
    }
    .pill-btn:hover{
      background:var(--pill-btn-bg-hover);
      transform:translateY(-1px);
    }
    @media (max-width:720px){
      nav.menu{gap:8px}
      nav.menu .link-btn{min-width:90px;height:36px}
      .authwrap{gap:4px}
      .pill-btn{min-width:82px;height:32px;padding:0 10px}
      .hello{display:none}
    }

    /* NAV DESPLEGABLE (para submen√∫s del header) */
    .menu-has-sub { gap: 6px; }
    .menu-group { position: relative; display: flex; align-items: center; }
    .has-sub-trigger { position: relative; padding-right: 18px; }
    .has-sub-trigger .caret { font-size: 0.7rem; opacity: 0.7; margin-left: 4px; }
    .menu-group .submenu {
      position: absolute;
      top: 110%;
      left: 0;
      min-width: 220px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: linear-gradient(180deg, #141b3a, #101631);
      box-shadow: 0 14px 28px rgba(5, 10, 30, 0.55);
      display: none;
      flex-direction: column;
      gap: 4px;
      z-index: 60;
    }
    .menu-group .submenu a {
      display: block;
      padding: 4px 8px;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .menu-group .submenu a:hover {
      background: rgba(108, 139, 255, 0.18);
      color: var(--ink);
      border-radius: 8px;
    }
    .submenu-title {
      margin-top: 6px;
      margin-bottom: 2px;
      padding: 2px 8px;
      font-size: 0.78rem;
      font-weight: 800;
      letter-spacing: 0.12em;
      color: #cfe1ff;
      opacity: 0.7;
      text-transform: uppercase;
    }
    .submenu.open { display: flex; }
    @media (min-width: 721px) {
      .menu-group:hover > .submenu,
      .menu-group:focus-within > .submenu {
        display: flex;
      }
    }
    @media (max-width: 720px) {
      .menu { flex-wrap: wrap; }
      .menu-group { flex-direction: column; align-items: flex-start; }
      .menu-group .submenu {
        position: static;
        margin-top: 4px;
        width: 100%;
        box-shadow: 0 6px 16px rgba(5,10,30,.35);
        display: none;
      }
      .menu-group .submenu.open { display: flex; }
    }

    /* ===== P√°gina ===== */
    .wrap{padding:20px 0 28px}
    .card{background:linear-gradient(180deg,var(--surface),var(--surface2));border:1px solid var(--stroke);
      border-radius:14px;padding:16px 16px;box-shadow:var(--shadow)}
    .header-row{display:flex;align-items:center;justify-content:space-between;margin:6px 0 12px}
    .header-row h2{margin:0;color:var(--ink);font-size:1.35rem;font-weight:700}

    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--stroke);background:var(--tab-bg);color:var(--ink);
      padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:600;font-size:.95rem;
      position:relative;transition:.15s ease
    }
    .tab[aria-pressed="true"]{
      background:linear-gradient(180deg,var(--azulite1),var(--azulite2));
      color:#fff;border-color:transparent;box-shadow:0 6px 16px rgba(95,125,255,.35);
    }
    .tab[aria-pressed="true"]::after{
      content:""; position:absolute; top:-6px; right:-6px;
      width:8px;height:8px;border-radius:50%;
      background:var(--azuliteDot); box-shadow:0 0 0 4px rgba(108,139,255,.25);
    }

    /* ===== Tabla ===== */
    .table-wrap{background:var(--surface);border:1px solid var(--stroke);border-radius:14px;box-shadow:var(--shadow);padding:10px;overflow-x:auto}
    table{width:100%;min-width:820px;border-collapse:collapse}
    thead th{background:var(--surface2);color:var(--ink);font-weight:700;text-align:center;padding:10px 8px;border-bottom:1px solid var(--stroke);font-size:1rem}
    tbody td{padding:10px 8px;text-align:center;border-bottom:1px solid var(--stroke);background:var(--surface);color:var(--ink);font-size:1rem}
    tbody tr:nth-child(even) td{background:var(--chip2)}
    tbody tr:hover td{background:var(--chip)}

    .col-rank{width:50px}
    .col-points{width:110px}
    .col-name{text-align:left}
    .col-level{white-space:nowrap}
    .col-num{width:90px}

    /* Medallas y nombres */
    .medal{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;font-weight:700;font-size:.9rem;color:#1b1830}
    .gold{background:linear-gradient(135deg,#ffd662,#ffb300)}
    .silver{background:linear-gradient(135deg,#e6e6e6,#bfbfbf)}
    .bronze{background:linear-gradient(135deg,#e2a97a,#d18d5a)}

    .namebox{display:inline-flex;align-items:center;gap:6px}
    .avatar{width:24px;height:24px;border-radius:50%;background:linear-gradient(180deg,#7b8cff,#4c66ff);font-weight:600;font-size:.8rem;color:#fff;display:flex;align-items:center;justify-content:center}
    .name-strong{
      font-weight:700;
      font-size:1.05rem;
      text-transform:uppercase;
      letter-spacing:.02em;
    }
    .name-gold{color:var(--gold)} .name-silver{color:var(--silver)} .name-bronze{color:var(--bronze)}

    /* Puntos chip */
    .points-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;font-weight:600;font-size:.95rem;border:1px solid var(--stroke);background:var(--surface2);color:var(--ink)}
    .points-chip.top{background:linear-gradient(180deg,#6c8bff,#3e64ff);color:#fff;border:none}

    /* Nivel */
    .level{display:inline-flex;align-items:center;gap:6px;font-weight:600;font-size:.95rem;padding:3px 8px;border-radius:999px;border:1px solid var(--stroke);background:rgba(0,0,0,.04)}
    .level .bar{height:6px;width:100px;background:#0a0f25;border-radius:999px;overflow:hidden;position:relative}
    .level .bar i{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#6c8bff,#3e64ff);width:0%}

    /* Reglas + Leyenda (dos columnas) */
    .below-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    @media (max-width:980px){.below-grid{grid-template-columns:1fr}}
    h3{font-weight:700;font-size:1.05rem;margin-bottom:6px;color:var(--ink)}
    .rule-list{margin:0 0 4px 18px;color:var(--ink)}
    .legend-item{display:flex;align-items:center;gap:10px;margin:6px 0;color:var(--ink)}
    .legend-name{font-weight:700}

    /* Footer */
    footer{margin-top:24px;border-top:1px solid var(--stroke);background:linear-gradient(180deg,var(--bg),var(--surface))}
    .footwrap{max-width:1100px;margin:0 auto;padding:18px 20px;display:grid;grid-template-columns:1.3fr 1fr 1fr 1fr;gap:16px;font-size:.95rem}
    @media(max-width:920px){.footwrap{grid-template-columns:1fr}}
    .footbrand{display:flex;gap:12px;align-items:flex-start}
    .footlogo{width:28px;height:28px;border-radius:8px;background:linear-gradient(180deg,#7b8cff,#4c66ff)}
    .footcol h4{font-weight:700;font-size:1rem;margin-bottom:6px;color:var(--ink)}
    .footcol li{margin:4px 0;color:var(--ink)}
    .footsmall{color:var(--muted);margin-top:8px}
  </style>
</head>

<body>
  <!-- Header com√∫n -->
  <div id="site-header"></div>

  <main class="container wrap">
    <!-- Ranking -->
    <section class="card">
      <div class="header-row">
        <h2>üèÜ RANKING GLOBAL</h2>
        <div class="tabs" role="tablist">
          <!-- Alcance temporal -->
          <button class="tab" id="tab-global" aria-pressed="true" onclick="setScope('global')">Global</button>
          <button class="tab" id="tab-season" aria-pressed="false" onclick="setScope('season')">Temporada (mes)</button>
          <button class="tab" id="tab-week" aria-pressed="false" onclick="setScope('week')">Semanal</button>
          <!-- Filtro de Examen -->
          <button class="tab" id="tab-all-exams" aria-pressed="true" onclick="clearExam()">Todos</button>
          <button class="tab" id="tab-az" aria-pressed="false" onclick="setExam('az-104')">AZ-104</button>
          <button class="tab" id="tab-az305" aria-pressed="false" onclick="setExam('az-305')">AZ-305</button>
          <button class="tab" id="tab-aws" aria-pressed="false" onclick="setExam('aws-saa-c03')">SAA-C03</button>
        </div>
      </div>
      <div class="table-wrap" id="board">Cargando‚Ä¶</div>
    </section>

    <!-- Reglas + Leyenda -->
    <div class="below-grid">
      <section class="card">
        <h3>‚öôÔ∏è Reglas de puntos</h3>
        <ul class="rule-list">
          <li><b>+5</b> por respuesta correcta.</li>
          <li><b>+50</b> por examen aprobado (‚â•70%).</li>
          <li><b>+10</b> bonus r√°pido (‚â§30s/pregunta).</li>
          <li><b>Racha</b>: +5 extra por cada aprobado consecutivo dentro de 7 d√≠as.</li>
          <li><b>Nivel</b>: cada 150 XP subes de nivel (la barra indica progreso).</li>
        </ul>
      </section>

      <section class="card">
        <h3>üéñÔ∏è Insignias</h3>
        <div class="legend-item">
          <span class="ibadge" style="background:rgba(255,179,0,.14);border-color:rgba(255,179,0,.35)">‚ö°</span>
          <span class="legend-name">R√°pido</span>
          <span style="color:var(--muted)">‚Äî Media ‚â§ 30s por pregunta en el intento.</span>
        </div>
        <div class="legend-item">
          <span class="ibadge" style="background:rgba(124,77,255,.18);border-color:rgba(124,77,255,.38)">üíØ</span>
          <span class="legend-name">Perfect</span>
          <span style="color:var(--muted)">‚Äî 100% de aciertos.</span>
        </div>
        <div class="legend-item">
          <span class="ibadge" style="background:rgba(46,204,113,.15);border-color:rgba(46,204,113,.35)">‚úÖ</span>
          <span class="legend-name">Pro</span>
          <span style="color:var(--muted)">‚Äî Examen aprobado (‚â• 70%).</span>
        </div>
        <div class="legend-item">
          <span class="ibadge" style="background:rgba(255,111,97,.14);border-color:rgba(255,111,97,.35)">üî•</span>
          <span class="legend-name">Racha</span>
          <span style="color:var(--muted)">‚Äî ‚â• 3 aprobados consecutivos en ‚â§ 7 d√≠as.</span>
        </div>
        <div class="legend-item">
          <span class="ibadge" style="background:rgba(100,181,246,.16);border-color:rgba(100,181,246,.35)">üí™</span>
          <span class="legend-name">Grinder</span>
          <span style="color:var(--muted)">‚Äî ‚â• 10 intentos totales.</span>
        </div>
        <div class="legend-item">
          <span class="ibadge" style="background:rgba(0,200,170,.15);border-color:rgba(0,200,170,.38)">üß†</span>
          <span class="legend-name">Preciso</span>
          <span style="color:var(--muted)">‚Äî Precisi√≥n media ‚â• 90%.</span>
        </div>
        <div class="legend-item">
          <span class="ibadge" style="background:rgba(255,214,98,.18);border-color:rgba(255,214,98,.45)">üèÖ</span>
          <span class="legend-name">Veterano</span>
          <span style="color:var(--muted)">‚Äî ‚â• 2000 XP acumulados.</span>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="footwrap">
      <div class="footbrand">
        <i class="footlogo"></i>
        <div>
          <h4 class="name-strong">ITHub.es</h4>
          <p style="margin:6px 0 10px;color:var(--muted)">
            Aprende, practica y aprueba tus certificaciones mientras compites con el resto del mundo.
            <br/>Todo lo que necesitas en un s√≥lo lugar.
          </p>
          <div class="footsmall">¬© 2025 ITHub.es</div>
        </div>
      </div>

      <div>
        <div style="font-weight:800">SIMULADORES</div>
        <div><a href="/certification/microsoft-azure/az-104/lz-azure-az-104.html">MICROSOFT AZURE AZ-104</a></div>
        <div><a href="/certification/microsoft-azure/az-305/lz-azure-az-305.html">MICROSOFTAZURE AZ-305</a></div>
        <div><a href="/certification/amazon aws/aws-saa-c03/lz-aws-saa-c03.html">AMAZON AWS SAA-C03</a></div>
      </div>
      <div>
        <div style="font-weight:800">DESTACADOS</div>
        <div><a href="/content/azure-identity-az104.html">Azure ¬∑ Identidad y Acceso</a></div>
        <div><a href="/content/azure-network-security-az104.html">Azure ¬∑ Seguridad en la red</a></div>
        <div><a href="/content/azure-cost-governance-az104.html">Azure ¬∑ Coste y Gobernanza</a></div>
        <div><a href="/content/azure-landing-zone.html">Azure ¬∑ Landing Zone</a></div>
        <div><a href="/content/aws-compute-elasticity-saac03.html">AWS ¬∑ Elasticidad EC2</a></div>
      </div>

      <div class="footcol">
        <h4>Contacto</h4>
        <ul>
          <li><a href="mailto:infoweb@ithub.es">infoweb(at)ithub.es</a></li>
        </ul>
      </div>
    </div>
  </footer>

<script>
  /* ======= Helpers de sesi√≥n para header ======= */
  function getCurrentUser(){
    try{
      return JSON.parse(localStorage.getItem("currentUser") || "null");
    }catch{
      return null;
    }
  }

  function renderHeaderAuth(){
    const u       = getCurrentUser();
    const login   = document.getElementById('btnLogin');
    const signup  = document.getElementById('btnSignup');
    const userArea= document.getElementById('userArea');
    const nameTop = document.getElementById('userNameTop');

    if(!login || !signup) return; // header a√∫n no montado

    if(u){
      login.style.display  = 'none';
      signup.style.display = 'none';
      if(userArea){
        userArea.style.display='flex';
        if(nameTop){
          nameTop.textContent = (u.name || u.email || 'USER').toUpperCase();
        }
      }
    }else{
      login.style.display  = 'inline-flex';
      signup.style.display = 'inline-flex';
      if(userArea){ userArea.style.display='none'; }
    }
  }

  function localLogoutHook(){
    const btnLogout = document.getElementById('btnLogout');
    if(btnLogout){
      btnLogout.addEventListener('click', ()=>{
        try{
          localStorage.removeItem('currentUser');
          localStorage.removeItem('certify_user');
          localStorage.removeItem('arenaIdToken');
        }catch{}
        renderHeaderAuth();
        // En ranking no recargamos, pero podr√≠as hacer:
        // location.reload();
      });
    }
  }

  /* ======= API / Config ranking ======= */
  const API_BASE = "https://uougu1cm26.execute-api.eu-central-1.amazonaws.com";
  const QUIZZES  = ["az-104","az-305","aws-saa-c03"];

  // Ruta securizada
  const RESULTS_PATH_SECURE = "/secure/results";

  /* ======= Utils ======= */
  const toInt=v=>Number.isFinite(Number(v))?(Number(v)|0):0;
  const pick=v=>(typeof v==="string"?v.trim():"");
  const getName=x=>pick(x.displayName)||pick(x.userName)||pick(x.username)||pick(x.name)||pick(x?.user?.name)||pick(x?.profile?.name)||"(no name)";
  const fmtDate=iso=>{ if(!iso) return "‚Äî"; try{ return new Date(iso).toLocaleDateString([], {year:'numeric',month:'short',day:'2-digit'});}catch{return iso;} };
  function weekKey(d){
    const dt=new Date(d);
    const onejan=new Date(dt.getFullYear(),0,1);
    const week=Math.ceil((((dt-onejan)/86400000)+onejan.getDay()+1)/7);
    return`${dt.getFullYear()}-W${String(week).padStart(2,'0')}`;
  }

  // Leer id_token guardado por Cognito
  function getArenaIdToken(){
    try {
      return localStorage.getItem("arenaIdToken") || "";
    } catch {
      return "";
    }
  }

  function pointsForAttempt(r){
    const correct=toInt(r.correct), total=toInt(r.total), dur=toInt(r.durationSec);
    let pts=correct*5;
    const pct=total>0?(correct/total)*100:(r.pct||0);
    if(pct>=70) pts+=50;
    if(total>0 && dur>0 && (dur/total)<=30) pts+=10;
    return { pts, passed:pct>=70, pct };
  }
  function levelFromXP(xp){
    const lvl=Math.max(1,Math.floor(xp/150)+1);
    const cur=xp%150; const p=Math.max(0,Math.min(100,Math.floor((cur/150)*100)));
    return { lvl, progress:p };
  }

  /* ======= URL helpers ======= */
  function normalizeExam(q){
    if(!q) return null;
    const s=String(q).toLowerCase().replace(/\s+/g,'').replace('%20','');
    if(s==='az104' || s==='az-104') return 'az-104';
    if(s==='az305' || s==='az-305') return 'az-305';
    if(s==='saa' || s==='saac03' || s==='saa-c03' || s==='aws' || s==='awssaa') return 'aws-saa-c03';
    return QUIZZES.includes(s) ? s : null;
  }
  function normalizeScope(x){
    const v=String(x||'').toLowerCase();
    return (v==='season'||v==='week') ? v : 'global';
  }
  function writeParams(){
    const p=new URLSearchParams();
    if(EXAM) p.set('quiz', EXAM);
    if(SCOPE!=='global') p.set('scope', SCOPE);
    const qs=p.toString();
    const url = qs ? `${location.pathname}?${qs}` : location.pathname;
    history.replaceState(null,'',url);
  }

  /* ======= Agregaci√≥n + Insignias ======= */
  function aggregate(rows, scope, exam){
    const now=new Date(); const curMonth=now.getMonth(), curYear=now.getFullYear(); const wkKey=weekKey(now);
    const byUser=new Map();

    rows.forEach(r=>{
      if(exam && r.quizId!==exam) return;
      const d=r.ts? new Date(r.ts): null;
      if(scope==='season' && d && (d.getMonth()!==curMonth || d.getFullYear()!==curYear)) return;
      if(scope==='week' && d && weekKey(d)!==wkKey) return;

      const {pts, passed, pct}=pointsForAttempt(r);
      const key=(r.userId||'')+'|'+(r.userName||'');
      if(!byUser.has(key)){
        byUser.set(key, {
          userId:r.userId,
          userName:r.userName,
          xp:0, attempts:0, passed:0, last:r.ts,
          badges:new Set(), lastPassTs:null, streak:0,
          correctSum:0, totalSum:0
        });
      }
      const u=byUser.get(key);

      if(passed){
        u.passed++;
        const t=d? d.getTime():0;
        if(u.lastPassTs && (t-u.lastPassTs)<=1000*60*60*24*7){ u.streak++; } else { u.streak=1; }
        u.lastPassTs=t;
      }

      u.xp += pts;
      u.attempts++;
      u.correctSum += Number(r.correct)||0;
      u.totalSum += Number(r.total)||0;

      if(pct===100) u.badges.add('perfect');
      if(r.total>0 && r.durationSec>0 && (r.durationSec/r.total)<=30) u.badges.add('fast');
      if(passed) u.badges.add('ok');
      u.last=r.ts||u.last;
    });

    for(const u of byUser.values()){
      if(u.streak>=3) u.badges.add('streak');
      if(u.attempts>=10) u.badges.add('grinder');
      if(u.xp>=2000) u.badges.add('veteran');
      const acc = u.totalSum>0 ? (u.correctSum/u.totalSum)*100 : 0;
      if(acc>=90) u.badges.add('sharp');
    }

    const list=[...byUser.values()].map(u=>{
      const lvl=levelFromXP(u.xp);
      return {...u, lvl:lvl.lvl, prog:lvl.progress};
    }).sort((a,b)=>{
      if(b.xp!==a.xp) return b.xp-a.xp;
      if(b.passed!==a.passed) return b.passed-a.passed;
      return String(a.userName).localeCompare(String(b.userName));
    });
    return list;
  }

  /* ======= Render ======= */
  function medalCell(i){
    if (i===0) return `<span class="medal gold">1</span>`;
    if (i===1) return `<span class="medal silver">2</span>`;
    if (i===2) return `<span class="medal bronze">3</span>`;
    return String(i+1);
  }
  function nameClass(i){
    if (i===0) return "name-strong name-gold";
    if (i===1) return "name-strong name-silver";
    if (i===2) return "name-strong name-bronze";
    return "name-strong";
  }
  function pointsChipClass(i){ return i<3 ? "points-chip top" : "points-chip"; }

  function renderBadgesSmall(set){
    const s=new Set(set);
    let out='<span class="ibadges">';
    if(s.has('fast')) out+=`<span class="ibadge" title="R√°pido">‚ö°</span>`;
    if(s.has('perfect')) out+=`<span class="ibadge" title="Perfect">üíØ</span>`;
    if(s.has('ok')) out+=`<span class="ibadge" title="Pro">‚úÖ</span>`;
    if(s.has('streak')) out+=`<span class="ibadge" title="Racha">üî•</span>`;
    if(s.has('grinder')) out+=`<span class="ibadge" title="Grinder">üí™</span>`;
    if(s.has('sharp')) out+=`<span class="ibadge" title="Preciso">üß†</span>`;
    if(s.has('veteran')) out+=`<span class="ibadge" title="Veterano">üèÖ</span>`;
    out+='</span>';
    return out;
  }

  function renderBoard(list){
    let html = `<table><thead><tr>
      <th class="col-rank">#</th>
      <th class="col-points">Puntos</th>
      <th class="col-name">Quizzer</th>
      <th class="col-num col-level">Nivel</th>
      <th class="col-num">Aprobados</th>
      <th class="col-num">Intentos</th>
      <th class="col-num">√öltimo</th>
      <th>Insignias</th>
    </tr></thead><tbody>`;

    list.forEach((u,i)=>{
      const initials = String(u.userName||'').trim().slice(0,2).toUpperCase() || 'QQ';
      html += `<tr>
        <td>${medalCell(i)}</td>
        <td><span class="${pointsChipClass(i)}">‚≠ê ${u.xp}</span></td>
        <td class="col-name">
          <span class="namebox">
            <span class="avatar">${initials}</span>
            <span class="${nameClass(i)}">${(u.userName||'(no name)')}</span>
          </span>
        </td>
        <td class="col-level"><span class="level">Lv ${u.lvl}<span class="bar"><i style="width:${u.prog}%"></i></span></span></td>
        <td>${u.passed}</td>
        <td>${u.attempts}</td>
        <td>${u.last? fmtDate(u.last) : '‚Äî'}</td>
        <td>${renderBadgesSmall(u.badges)}</td>
      </tr>`;
    });

    html += `</tbody></table>`;
    document.getElementById('board').innerHTML = html;
  }

  // ===== Estado UI / Filtros =====
  let SCOPE='global', EXAM=null, CACHE=null;

  function setScope(x){ SCOPE=x; syncTabs(); writeParams(); render(); }
  function setExam(x){ EXAM = (EXAM === x) ? null : x; syncTabs(); writeParams(); render(); }
  function clearExam(){ EXAM = null; syncTabs(); writeParams(); render(); }

  function syncTabs(){
    const set=(id,on)=>document.getElementById(id)?.setAttribute('aria-pressed', String(on));
    set('tab-global', SCOPE==='global');
    set('tab-season', SCOPE==='season');
    set('tab-week', SCOPE==='week');
    set('tab-all-exams', EXAM===null);
    set('tab-az', EXAM==='az-104');
    set('tab-az305', EXAM==='az-305');
    set('tab-aws', EXAM==='aws-saa-c03');
  }

  async function render(){
    const node = document.getElementById('board');
    node.innerHTML = 'Cargando‚Ä¶';

    try{
      const token = getArenaIdToken();
      if (!token){
        node.innerHTML = '<p style="color:var(--muted)">Necesitas iniciar sesi√≥n con Cognito para ver el ranking protegido.</p>';
        return;
      }

      if (!CACHE){
        const url = `${API_BASE}${RESULTS_PATH_SECURE}?limit=3000`;
        const res = await fetch(url, {
          method: "GET",
          mode: "cors",
          cache: "no-store",
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); }
        catch(e){
          console.error("Respuesta no JSON desde /secure/results:", text);
          throw new Error('Respuesta no v√°lida desde /secure/results');
        }

        if (!res.ok) {
          throw new Error(data.error || `HTTP ${res.status}`);
        }

        const items = Array.isArray(data.items) ? data.items : [];
        CACHE = items.map(x=>({
          userId: x.userId || "(unknown)",
          userName: getName(x),
          quizId: (x.quizId || "-").toLowerCase(),
          correct: Number(x.correct)||0,
          total: Number(x.total)||0,
          pct: Number(x.pct)||0,
          durationSec: Number(x.durationSec)||0,
          ts: x.ts || null
        })).filter(r=> QUIZZES.includes(r.quizId));
      }

      const filtered = CACHE.filter(r=> !EXAM || r.quizId===EXAM);
      const list = aggregate(filtered, SCOPE, EXAM);
      renderBoard(list.slice(0,50));
    }catch(e){
      console.error(e);
      node.innerHTML = `<p style="color:var(--muted)">Error cargando API: ${e.message}</p>`;
    }
  }

  // ===== Init ranking seg√∫n URL =====
  (function initFromUrl(){
    const p=new URLSearchParams(location.search);
    const ex=p.get('quiz'); const sc=p.get('scope');
    const mapExam=(q)=>{ if(!q) return null; q=q.toLowerCase(); if(q==='az104')return'az-104'; if(q==='az305')return'az-305'; if(q==='aws'||q==='saa-c03')return'aws-saa-c03'; return q;};
    const mapScope=(s)=>['season','week'].includes((s||'').toLowerCase())?(s||'global'):'global';
    EXAM = mapExam(ex);
    SCOPE = mapScope(sc);
    syncTabs(); writeParams(); render();
  })();
</script>

<script>
  // Cargar header com√∫n desde includes/header.html
  fetch('/includes/header.html')
    .then(r => r.text())
    .then(html => {
      const container = document.getElementById('site-header');
      if(!container) return;
      container.innerHTML = html;

      // Estado de sesi√≥n en cabecera
      renderHeaderAuth();
      localLogoutHook();

      // Funciones globales del header (si existen)
      if (typeof attachHeaderEvents === 'function') {
        attachHeaderEvents();
      }
      if (typeof initSubmenus === 'function') {
        initSubmenus();
      }
    })
    .catch(err => {
      console.error('No se pudo cargar el header com√∫n:', err);
    });
</script>

</body>
</html>
