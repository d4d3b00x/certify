<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DYZ3GCXHEK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-DYZ3GCXHEK');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IT Hub .es ‚Äî Ranking Gamificado</title>
  <link rel="stylesheet" href="/style_global.css"/>
  <style>
    :root{
      --bg:#0f1320; --surface:#161b2d; --surface2:#1b2140; --ink:#e8ecff; --muted:#9ca8d9;
      --stroke:#283056; --brand:#6c8bff; --radius:14px; --shadow:0 12px 28px rgba(6,12,40,.45);
      --aws:#ff9900; --azure:#0078d4; --aws-2:#ffb84d; --azure-2:#5fb3ff;
      --violet:#7b5cff; --violet-2:#6246ff;
      --gold:#ffd662; --silver:#e6e6e6; --bronze:#e2a97a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Helvetica Neue","Noto Sans",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 420px at 90% -10%,rgba(255,153,0,.12),transparent 60%),
        radial-gradient(800px 400px at 10% 0%,rgba(0,120,212,.12),transparent 60%),
        var(--bg);
      line-height:1.6;
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:0 20px}

    /* ===== Header como captura ===== */
    header{position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);
      background:linear-gradient(180deg,rgba(15,19,32,.85),rgba(15,19,32,.55));
      border-bottom:1px solid var(--stroke)}
    .nav{height:56px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
    .brand .logo{width:22px;height:22px;border-radius:6px;background:linear-gradient(180deg,#7b8cff,#4c66ff);box-shadow:0 0 0 6px rgba(108,139,255,.18)}
    .brand span{opacity:.9}
    .brand small{opacity:.6;font-weight:800}
    .menu{display:none;gap:28px;color:var(--muted);font-weight:900;letter-spacing:.04em}
    .menu a{text-transform:uppercase}
    .menu a:hover{color:#fff}
    @media(min-width:720px){.menu{display:flex}}

    .actions{display:flex;align-items:center;gap:10px}
    .userbox{
      display:flex;align-items:center;gap:12px;padding:8px 10px 8px 12px;
      border:1px solid var(--stroke);border-radius:999px;background:rgba(17,23,55,.55)
    }
    .userbox .name{font-weight:900;letter-spacing:.02em;opacity:.95}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:12px;border:1px solid var(--stroke);
      cursor:pointer;font-weight:800;background:transparent;color:var(--ink)
    }
    .btn.primary{background:linear-gradient(180deg,var(--violet),var(--violet-2));border:none;box-shadow:var(--shadow);color:#fff}
    .btn.ghost{background:transparent;border:1px solid var(--stroke)}
    .btn.equal{min-width:92px}

    /* ===== P√°gina ===== */
    .wrap{padding:22px 0 28px}
    .layout{display:grid;grid-template-columns: 1fr 320px; gap:18px}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg,#111937,#0f1633);border:1px solid var(--stroke);
      border-radius:16px;padding:18px 18px;box-shadow:var(--shadow)}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:6px 0 12px}
    .header-row h2{margin:0;color:#fff;font-size:1.35rem;font-weight:900;letter-spacing:.2px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      appearance:none;border:1px solid var(--stroke);background:var(--surface2);color:#e8ecff;
      padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:800
    }
    .tab[aria-pressed="true"]{outline:2px solid rgba(108,139,255,.3)}

    .table-wrap{background:var(--surface);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);padding:14px;overflow:auto}
    table{width:100%;min-width:860px;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;z-index:1;background:var(--surface2);color:#e8ecff;font-weight:800;text-align:center;padding:12px 10px;border-bottom:1px solid var(--stroke)}
    tbody td{padding:12px 10px;text-align:center;border-bottom:1px solid #1f2747;background:#0f1430;color:#e8ecff}
    tbody tr:nth-child(even) td{background:#101738}
    tbody tr:hover td{background:#0e1536}
    thead th:first-child{border-top-left-radius:12px}
    thead th:last-child{border-top-right-radius:12px}
    .col-rank{width:64px}
    .col-name{text-align:left}
    .col-num{width:110px;font-variant-numeric:tabular-nums}
    .col-date{width:200px}
    .col-points{width:140px}
    .col-level{white-space:nowrap} /* evita salto en el chip de nivel */

    /* Medallas Top 3 */
    .medal{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;font-weight:800;color:#1b1830}
    .medal.gold{background:linear-gradient(135deg,#ffd662,#ffb300);box-shadow:0 2px 6px rgba(255,179,0,.35)}
    .medal.silver{background:linear-gradient(135deg,#e6e6e6,#bfbfbf);box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .medal.bronze{background:linear-gradient(135deg,#e2a97a,#d18d5a);box-shadow:0 2px 6px rgba(0,0,0,.12)}

    /* Nombre destacado y color por medalla */
    .name-strong{font-weight:900}
    .name-gold{color:var(--gold)}
    .name-silver{color:var(--silver)}
    .name-bronze{color:var(--bronze)}

    /* Puntos: azul solo Top 3 */
    .points-chip{
      display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;
      font-weight:900;border:1px solid var(--stroke);background:var(--surface2);color:#e8ecff
    }
    .points-chip.top{background:linear-gradient(180deg,#6c8bff,#3e64ff);color:#fff;border:none;box-shadow:var(--shadow)}

    .avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(180deg,#7b8cff,#4c66ff);display:inline-flex;align-items:center;justify-content:center;font-weight:900;color:#fff;margin-right:8px}

    /* Nivel alineado en una sola l√≠nea */
    .level{
      display:inline-flex;align-items:center;gap:8px;
      font-weight:900;padding:4px 10px;border-radius:999px;
      border:1px solid var(--stroke);background:rgba(255,255,255,.04)
    }
    .level .bar{display:inline-block;height:8px;width:110px;background:#0a0f25;border-radius:999px;position:relative;overflow:hidden}
    .level .bar i{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#6c8bff,#3e64ff);width:0%}

    .badge2{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;background:var(--surface2);color:#e8ecff;border:1px solid var(--stroke);font-weight:800;margin:2px}
    .badge2.fast{background:rgba(255,179,0,.14);border-color:rgba(255,179,0,.35);color:#ffe3a6}
    .badge2.perfect{background:rgba(124,77,255,.18);border-color:rgba(124,77,255,.38);color:#e0d6ff}
    .badge2.ok{background:rgba(46,204,113,.15);border-color:rgba(46,204,113,.35);color:#b8ffd7}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav">
      <div class="brand">
        <i class="logo"></i>
        <span>IT&nbsp;Hub</span> <small>.es</small>
      </div>
      <nav class="menu">
        <a href="/#simuladores">SIMULADORES</a>
        <a href="/#contenidos">CONTENIDOS</a>
        <a href="/score/ranking.html">RANKING</a>
      </nav>
      <div class="actions" id="navActions"></div>
    </div>
  </header>

  <main class="container wrap">
    <div class="layout">
      <section class="card">
        <div class="header-row">
          <h2>üèÜ Ranking Gamificado</h2>
          <div class="tabs" role="tablist">
            <button class="tab" id="tab-global" aria-pressed="true" onclick="setScope('global')">Global</button>
            <button class="tab" id="tab-season" aria-pressed="false" onclick="setScope('season')">Temporada (mes)</button>
            <button class="tab" id="tab-week" aria-pressed="false" onclick="setScope('week')">Semanal</button>
            <button class="tab" id="tab-az" aria-pressed="false" onclick="setExam('az-104')">AZ-104</button>
            <button class="tab" id="tab-aws" aria-pressed="false" onclick="setExam('aws-saa-c03')">SAA-C03</button>
          </div>
        </div>

        <div class="table-wrap" id="board">Cargando‚Ä¶</div>
      </section>

      <aside class="side">
        <div class="card">
          <h3 style="margin:0 0 8px">‚öôÔ∏è Reglas de puntos</h3>
          <ul style="margin:0 0 6px 18px">
            <li><b>+5</b> por respuesta correcta.</li>
            <li><b>+50</b> por examen aprobado (‚â•70%).</li>
            <li><b>+10</b> bonus r√°pido (‚â§30s/pregunta).</li>
            <li><b>Racha</b>: +5 extra por aprobado consecutivo en 7 d√≠as.</li>
          </ul>
          <p style="margin:8px 0 0">Nivel cada 150 XP. Top 3 con medalla y chip azul.</p>
        </div>
        <div class="card" id="myPosition" style="margin-top:12px;display:none"></div>
      </aside>
    </div>
  </main>

  <script>
    /* ======= Cabecera: sesi√≥n (como tu web) ======= */
    function getUserAny(){
      let u=null;
      try{u=JSON.parse(localStorage.getItem("currentUser")||"null")}catch{}
      if(!u){try{u=JSON.parse(localStorage.getItem("certify_user")||"null")}catch{}}
      return u;
    }
    function renderHeaderUser(){
      const box=document.getElementById('navActions');
      const u=getUserAny();
      if(u && (u.name||u.displayName||u.userName)){
        const name=(u.name||u.displayName||u.userName||'Usuario').toUpperCase();
        box.innerHTML = `
          <div class="userbox">
            <span>üî• <span class="name">${name}</span></span>
            <a class="btn primary equal" href="/user/profile.html">PERFIL</a>
            <button class="btn primary equal" id="logoutBtn">SALIR</button>
          </div>
        `;
        document.getElementById('logoutBtn')?.addEventListener('click', ()=>{
          try{ localStorage.removeItem('currentUser'); localStorage.removeItem('certify_user'); }catch{}
          location.reload();
        });
      } else {
        box.innerHTML = `
          <a class="btn ghost equal" href="/login/login.html">Login</a>
          <a class="btn primary equal" href="/login/login.html#signup">Crear cuenta</a>
        `;
      }
    }
    renderHeaderUser();

    /* ======= Config API ======= */
    const API_BASE = "https://uougu1cm26.execute-api.eu-central-1.amazonaws.com";
    const QUIZZES = ["az-104","aws-saa-c03"];

    /* ======= Utils ======= */
    const toInt = v => Number.isFinite(Number(v)) ? (Number(v)|0) : 0;
    const toNum = v => Number.isFinite(Number(v)) ? Number(v) : 0;
    const pick = v => (typeof v === "string" ? v.trim() : "");
    const getName = x => pick(x.displayName)||pick(x.userName)||pick(x.username)||pick(x.name)||pick(x?.user?.name)||pick(x?.profile?.name)||"(no name)";
    const pad = n => String(n).padStart(2,'0');
    const fmtDate = (iso)=>{ if (!iso) return "‚Äî"; try{ return new Date(iso).toLocaleString([], {year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});}catch{ return iso; }};

    function pointsForAttempt(r){
      const correct = toInt(r.correct), total = toInt(r.total), dur = toInt(r.durationSec);
      let pts = correct * 5; // base
      const pct = total>0 ? (correct/total)*100 : (r.pct||0);
      if (pct >= 70) pts += 50;               // aprobado
      if (total>0 && dur>0 && (dur/total) <= 30) pts += 10; // r√°pido (‚â§30s/pregunta)
      return { pts, passed: pct>=70, pct };
    }
    function levelFromXP(xp){
      const lvl = Math.max(1, Math.floor(xp/150)+1); // 150 XP por nivel
      const cur = xp % 150; const p = Math.max(0, Math.min(100, Math.floor((cur/150)*100)));
      return {lvl, progress:p};
    }

    /* ======= API ======= */
    async function fetchAll(limit=3000){
      const res = await fetch(`${API_BASE}/results?limit=${limit}`, {mode:"cors", cache:"no-store"});
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
      const items = Array.isArray(data.items) ? data.items : [];
      return items.map(x=>({
        userId: x.userId || "(unknown)",
        userName: getName(x),
        quizId: (x.quizId || "-").toLowerCase(),
        correct: toInt(x.correct),
        total: toInt(x.total),
        pct: toNum(x.pct ?? 0),
        durationSec: toInt(x.durationSec),
        ts: x.ts || null
      })).filter(r=> QUIZZES.includes(r.quizId));
    }

    /* ======= Agregaci√≥n ======= */
    function weekKey(d){ const dt=new Date(d); const onejan=new Date(dt.getFullYear(),0,1); const week=Math.ceil((((dt-onejan)/86400000)+onejan.getDay()+1)/7); return `${dt.getFullYear()}-W${String(week).padStart(2,'0')}`; }

    function aggregate(rows, scope, exam){
      const now=new Date(); const curMonth=now.getMonth(), curYear=now.getFullYear(); const wkKey=weekKey(now);
      const byUser=new Map();

      rows.forEach(r=>{
        if(exam && r.quizId!==exam) return;
        const d=r.ts? new Date(r.ts): null;
        if(scope==='season' && d && (d.getMonth()!==curMonth || d.getFullYear()!==curYear)) return;
        if(scope==='week' && d && weekKey(d)!==wkKey) return;

        const {pts, passed, pct}=pointsForAttempt(r);
        const key=r.userId+'|'+r.userName;
        if(!byUser.has(key)){
          byUser.set(key, {userId:r.userId, userName:r.userName, xp:0, attempts:0, passed:0, last:r.ts, badges:new Set(), streak:0, lastPassTs:null});
        }
        const u=byUser.get(key);
        if(passed){
          u.passed++;
          const t=d? d.getTime():0;
          if(u.lastPassTs && (t-u.lastPassTs)<=1000*60*60*24*7){ u.streak++; } else { u.streak=1; }
          u.lastPassTs=t;
        }
        u.xp += pts + Math.max(0,(u.streak-1)*5);
        u.attempts++;
        if(pct===100) u.badges.add('perfect');
        if(r.total>0 && r.durationSec>0 && (r.durationSec/r.total)<=30) u.badges.add('fast');
        u.last=r.ts||u.last;
      });

      const list=[...byUser.values()].map(u=>{ const lvl=levelFromXP(u.xp); return {...u, lvl:lvl.lvl, prog:lvl.progress}; })
        .sort((a,b)=>{ if(b.xp!==a.xp) return b.xp-a.xp; if(b.passed!==a.passed) return b.passed-a.passed; return String(a.userName).localeCompare(String(b.userName)); });
      return list;
    }

    /* ======= Render ======= */
    function medalCell(i){
      if (i===0) return `<span class="medal gold">1</span>`;
      if (i===1) return `<span class="medal silver">2</span>`;
      if (i===2) return `<span class="medal bronze">3</span>`;
      return String(i+1);
    }
    function nameClass(i){
      if (i===0) return "name-strong name-gold";
      if (i===1) return "name-strong name-silver";
      if (i===2) return "name-strong name-bronze";
      return "name-strong";
    }
    function pointsChipClass(i){ return i<3 ? "points-chip top" : "points-chip"; }
    function badgeHTML(b){ if(b==='fast') return `<span class="badge2 fast">‚ö° R√°pido</span>`; if(b==='perfect') return `<span class="badge2 perfect">üíØ Perfect</span>`; return `<span class="badge2 ok">‚úÖ Pro</span>`; }

    function renderBoard(list){
      const me = getUserAny();
      const meName = (me?.name||me?.displayName||me?.userName)||null;

      let html = `<table><thead><tr>
        <th class="col-rank">#</th>
        <th class="col-points">Puntos</th>
        <th class="col-name">Jugador</th>
        <th class="col-num col-level">Nivel</th>
        <th class="col-num">Aprobados</th>
        <th class="col-num">Intentos</th>
        <th class="col-date">√öltimo</th>
        <th>Insignias</th>
      </tr></thead><tbody>`;

      list.forEach((u,i)=>{
        const initials = String(u.userName).trim().slice(0,2).toUpperCase();
        const isMe = meName && String(u.userName).toLowerCase()===String(meName).toLowerCase();
        html += `<tr${isMe? ' style="outline:2px solid rgba(108,139,255,.35)"':''}>
          <td>${medalCell(i)}</td>
          <td><span class="${pointsChipClass(i)}">‚≠ê ${u.xp}</span></td>
          <td class="col-name"><span class="avatar">${initials}</span><span class="${nameClass(i)}">${u.userName}</span></td>
          <td class="col-level"><span class="level">Lv ${u.lvl}<span class="bar"><i style="width:${u.prog}%"></i></span></span></td>
          <td>${u.passed}</td>
          <td>${u.attempts}</td>
          <td>${u.last? fmtDate(u.last) : '‚Äî'}</td>
          <td>${[...u.badges].map(b=> badgeHTML(b)).join('')}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      document.getElementById('board').innerHTML = html;

      // "Mi posici√≥n"
      const myDiv = document.getElementById('myPosition');
      if (meName){
        const idx = list.findIndex(x=> String(x.userName).toLowerCase()===meName.toLowerCase());
        if (idx>=0){
          const meU=list[idx];
          myDiv.style.display='';
          myDiv.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <div style="display:flex;align-items:center;gap:10px"><span>${medalCell(idx)}</span>
            <span class="avatar">${String(meU.userName).slice(0,2).toUpperCase()}</span>
            <span class="name-strong">${meU.userName}</span></div>
            <div><span class="${pointsChipClass(idx)}">‚≠ê ${meU.xp}</span></div>
          </div>`;
        }
      }
    }

    // Estado UI
    let SCOPE='global', EXAM=null, CACHE=null;
    function setScope(x){ SCOPE=x; syncTabs(); render(); }
    function setExam(x){ EXAM=x; syncTabs(); render(); }
    function syncTabs(){
      const set=(id,on)=>document.getElementById(id)?.setAttribute('aria-pressed', String(on));
      set('tab-global', SCOPE==='global');
      set('tab-season', SCOPE==='season');
      set('tab-week', SCOPE==='week');
      set('tab-az', EXAM==='az-104');
      set('tab-aws', EXAM==='aws-saa-c03');
    }

    async function render(){
      const node = document.getElementById('board');
      node.innerHTML = 'Cargando‚Ä¶';
      try{
        if (!CACHE){
          const rows = await fetchAll(3000);
          CACHE = rows;
        }
        const list = aggregate(CACHE, SCOPE, EXAM);
        renderBoard(list.slice(0,50));
      }catch(e){
        node.innerHTML = `<p style="color:var(--muted)">Error cargando API: ${e.message}</p>`;
      }
    }
    render();

  </script>
</body>
</html>
