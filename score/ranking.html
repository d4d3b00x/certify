<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CertiFY â€” Latest 10 Results per Exam</title>
  <link rel="stylesheet" href="/style_global.css"/>
  <style>
    :root{
      --bg:#efeaff; --surface:#f5f7fb; --card:#efeaff; --ink:#0f1330; --muted:#8e87a8;
      --brand:#0f1438; --cta:#54188d; --cta-hover:#8d12ac; --cta-ink:#efeaff; --link:#470447;
      --ring:rgba(255,153,0,.35); --shadow:0 10px 30px rgba(18,16,99,.12); --bd:#e8e6ff;
      --row:#ffffff; --row-alt:#f7f5ff; --row-hover:#f0eaff; --head:#f0ecff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Helvetica Neue","Noto Sans",sans-serif;
      color:var(--ink);
      background:linear-gradient(0deg,var(--surface) 96px,var(--bg) 96px);
      line-height:1.6;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:0 20px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:20px 22px;box-shadow:var(--shadow);}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:10px 0 14px;}
    .header h2{margin:0;color:var(--brand);font-size:1.4rem;font-weight:900;letter-spacing:.2px;}
    .hint{color:var(--muted)}
    /* Filtros */
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      appearance:none;border:1px solid #ddd;background:#fff;color:#2b1b4a;
      padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:800;
    }
    .pill[aria-pressed="true"]{border-color:#c9b6ff;background:#f6f1ff}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin:16px 0 8px}
    .section-title h3{margin:0;font-size:1.05rem}
    .badge{
      display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:.8rem;
      background:#f3ecff;color:#4a1778;border:1px solid #e3d6ff;
    }
    .table-wrap{background:#fff;border:1px solid var(--bd);border-radius:16px;box-shadow:var(--shadow);padding:14px;overflow:auto;}
    .rank-table{width:100%;min-width:820px;border-collapse:separate;border-spacing:0}
    .rank-table thead th{
      position:sticky;top:0;z-index:1;background:var(--head);color:var(--brand);
      font-weight:800;letter-spacing:.02em;text-align:center;padding:12px 10px;border-bottom:1px solid var(--bd);
    }
    .rank-table tbody td{padding:12px 10px;text-align:center;border-bottom:1px solid #eee;background:var(--row)}
    .rank-table tbody tr:nth-child(even) td{background:var(--row-alt)}
    .rank-table tbody tr:hover td{background:var(--row-hover)}
    .rank-table thead th:first-child{border-top-left-radius:12px}
    .rank-table thead th:last-child{border-top-right-radius:12px}
    .col-rank{width:64px}
    .col-name{text-align:center}
    .col-quiz{width:160px}
    .col-num{width:110px;font-variant-numeric:tabular-nums}
    .col-date{width:200px}
    .medal{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;font-weight:800;color:#1b1830}
    .medal.gold{background:linear-gradient(135deg,#ffd662,#ffb300);box-shadow:0 2px 6px rgba(255,179,0,.35)}
    .medal.silver{background:linear-gradient(135deg,#e6e6e6,#bfbfbf);box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .medal.bronze{background:linear-gradient(135deg,#e2a97a,#d18d5a);box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .pct{display:flex;align-items:center;justify-content:center;gap:8px;font-variant-numeric:tabular-nums;font-weight:800}
    .pbar{position:relative;flex:1 1 120px;height:8px;background:#eee;border-radius:999px;overflow:hidden;max-width:160px}
    .pbar>i{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#7b3fe4,#a45df2)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;background:rgba(84,24,141,.08);color:#3b2062;border:1px solid rgba(84,24,141,.2);font-weight:700}
    .actions{display:flex;gap:10px;justify-content:center;margin-top:14px}
    .btn{appearance:none;border:0;cursor:pointer;background:var(--cta);color:var(--cta-ink);font-weight:800;letter-spacing:.2px;padding:12px 18px;border-radius:12px}
    .btn:hover{background:var(--cta-hover)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <h2>ðŸ“Š TOP 10 QUIZZERS PER CERTIFICATION!!</h2>
        <div class="filters" role="tablist" aria-label="Filter by exam">
          <button class="pill" id="flt-all" role="tab" aria-pressed="true" onclick="setFilter('all')">All</button>
          <button class="pill" id="flt-az" role="tab" aria-pressed="false" onclick="setFilter('az-104')">AZ-104</button>
          <button class="pill" id="flt-aws" role="tab" aria-pressed="false" onclick="setFilter('aws-saa-c03')">AWS-SAA-C03</button>
        </div>
      </div>

      <!-- Contenedores -->
      <div id="container"></div>

      <div class="actions">
        <button class="btn" onclick="history.back()">BACK</button>
        <button class="btn" onclick="location.href='/'">HOME</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://uougu1cm26.execute-api.eu-central-1.amazonaws.com";
    const QUIZZES = ["az-104","aws-saa-c03"];

    // ---------- utils ----------
    const toInt = v => Number.isFinite(Number(v)) ? (Number(v)|0) : 0;
    const toNum = v => Number.isFinite(Number(v)) ? Number(v) : 0;
    const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const pad = n => String(n).padStart(2,'0');

    function fmtDuration(sec){
      sec = toInt(sec);
      if (!sec || sec < 0) return "â€”";
      const m = Math.floor(sec/60), s = sec%60;
      return `${pad(m)}:${pad(s)}`;
    }

    function fmtDate(iso){
      if (!iso) return "â€”";
      try{
        return new Date(iso).toLocaleString([], {year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      }catch{
        return iso;
      }
    }

    const pick = v => (typeof v === "string" ? v.trim() : "");
    const getName = x => pick(x.userName)||pick(x.username)||pick(x.displayName)||pick(x.name)||pick(x?.user?.name)||pick(x?.profile?.name)||"(no name)";

    // % acierto como 0..1 (si tienes un campo pct en 0..100 lo normalizamos)
    function pct01(r){
      const t = toInt(r.total);
      const c = toInt(r.correct);
      if (t > 0) return Math.max(0, Math.min(1, c / t));
      const p = toNum(r.pct);
      return Math.max(0, Math.min(1, p > 1 ? p/100 : p));
    }

    // ---------- API ----------
    async function fetchAll(limit=1000){
      const res = await fetch(`${API_BASE}/results?limit=${limit}`, {mode:"cors", cache:"no-store"});
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
      const items = Array.isArray(data.items) ? data.items : [];
      return items.map(x => ({
        userId: x.userId || "(unknown)",
        userName: getName(x),
        quizId: (x.quizId || "-").toLowerCase(),
        correct: toInt(x.correct),
        total: toInt(x.total),
        pct: toNum(x.pct ?? (x.total ? (toInt(x.correct)/toInt(x.total))*100 : 0)),
        durationSec: toInt(x.durationSec),
        ts: x.ts || null
      }));
    }

    // Ãºltimos 10 por examen (mÃ¡s recientes) y LUEGO ordenados con tu criterio:
    // 1) Total DESC  2) Correct DESC  3) DuraciÃ³n ASC (menos tiempo primero en el empate)
    // 4) Fecha ASC (mÃ¡s antiguo primero como desempate final para estabilidad)
    function latest10PerQuizRanked(rows){
      const byQuiz = Object.fromEntries(QUIZZES.map(q => [q, []]));
      rows.forEach(r => { if (byQuiz[r.quizId]) byQuiz[r.quizId].push(r); });

      for (const q of QUIZZES){
        // 1) Quedarnos con los 10 mÃ¡s recientes por fecha (para limitar dataset)
        byQuiz[q].sort((a,b)=> (b.ts||"").localeCompare(a.ts||""));
        byQuiz[q] = byQuiz[q].slice(0,10);

        // 2) Precalcular ayudas
        byQuiz[q] = byQuiz[q].map(r => {
          const timeSafe = r.ts ? new Date(r.ts).getTime() : 0;
          // si no hay duraciÃ³n o es 0/negativa, lo enviamos al final del empate
          const durationSafe = (toInt(r.durationSec) > 0) ? toInt(r.durationSec) : Number.MAX_SAFE_INTEGER;
          return { ...r, pct01: pct01(r), timeSafe, durationSafe };
        });

        // 3) Orden final solicitado
        byQuiz[q].sort((a,b)=>{
          if (b.total !== a.total)   return b.total - a.total;       // mÃ¡s preguntas primero
          if (b.correct !== a.correct) return b.correct - a.correct; // mÃ¡s correctas
          if (a.durationSafe !== b.durationSafe) return a.durationSafe - b.durationSafe; // MENOS tiempo primero
          return a.timeSafe - b.timeSafe; // el que lo hizo antes (fecha) como desempate Ãºltimo
        });
      }
      return byQuiz;
    }

    // ---------- render ----------
    function medalCell(i){
      if (i===0) return `<span class="medal gold">1</span>`;
      if (i===1) return `<span class="medal silver">2</span>`;
      if (i===2) return `<span class="medal bronze">3</span>`;
      return String(i+1);
    }

    function tableHTML(rows, title, quizId){
      if (!rows.length){
        return `
          <div class="section-title">
            <h3>${title}</h3>
            <span class="badge">${quizId}</span>
          </div>
          <div class="table-wrap"><p style="text-align:center;margin:18px 0;">No results yet.</p></div>
        `;
      }

      let html = `
        <div class="section-title">
          <h3>${title}</h3>
          <span class="badge">${quizId}</span>
        </div>
        <div class="table-wrap">
          <table class="rank-table">
            <thead>
              <tr>
                <th class="col-rank">#</th>
                <th class="col-name">Name</th>
                <th class="col-quiz">Quiz</th>
                <th class="col-num">Correct</th>
                <th class="col-num">Total</th>
                <th class="col-num">Score</th>
                <th class="col-num">Duration</th>
                <th class="col-date">Date</th>
              </tr>
            </thead>
            <tbody>
      `;

      rows.forEach((r,i)=>{
        const pct = Math.round(Math.min(100, Math.max(0, r.pct01*100)));
        html += `
          <tr>
            <td class="col-rank">${medalCell(i)}</td>
            <td class="col-name">${escapeHtml(r.userName)}</td>
            <td class="col-quiz"><span class="badge">${escapeHtml(r.quizId)}</span></td>
            <td class="col-num">${r.correct}</td>
            <td class="col-num">${r.total}</td>
            <td class="col-num">
              <div class="pct">
                <div class="pbar"><i style="width:${pct}%"></i></div>
                <span>${pct}%</span>
              </div>
            </td>
            <td class="col-num"><span class="chip">${fmtDuration(r.durationSec)}</span></td>
            <td class="col-date">${fmtDate(r.ts)}</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;
      return html;
    }

    function renderView(allByQuiz, filter){
      const c = document.getElementById("container");
      const pills = {
        all: document.getElementById("flt-all"),
        az: document.getElementById("flt-az"),
        aws: document.getElementById("flt-aws")
      };

      // actualizar estado de los pills
      pills.all.setAttribute("aria-pressed", String(filter==="all"));
      pills.az.setAttribute("aria-pressed", String(filter==="az-104"));
      pills.aws.setAttribute("aria-pressed", String(filter==="aws-saa-c03"));

      if (filter==="all"){
        c.innerHTML =
          tableHTML(allByQuiz["az-104"], "Microsoft Azure Administrator (AZ-104)", "az-104") +
          tableHTML(allByQuiz["aws-saa-c03"], "Amazon AWS Architect Associate (SAA-C03)", "aws-saa-c03");
      }else{
        const title = filter==="az-104" ? "Microsoft Azure Administrator (AZ-104)" : "Amazon AWS Architect Associate (SAA-C03)";
        c.innerHTML = tableHTML(allByQuiz[filter], title, filter);
      }
    }

    // ---------- filtro / navegaciÃ³n ----------
    let cacheAllByQuiz = null;

    async function loadAndRender(filter="all"){
      const container = document.getElementById("container");
      container.innerHTML = `<div class="table-wrap">Loadingâ€¦</div>`;
      if (!cacheAllByQuiz){
        const rows = await fetchAll(1000);
        cacheAllByQuiz = latest10PerQuizRanked(rows);
      }
      renderView(cacheAllByQuiz, filter);
    }

    function setFilter(filter){
      const allowed = ["all","az-104","aws-saa-c03"];
      if (!allowed.includes(filter)) filter = "all";
      const q = new URLSearchParams(location.search);
      if (filter==="all") q.delete("quiz"); else q.set("quiz", filter);
      history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
      loadAndRender(filter);
    }

    function initFromURL(){
      const q = new URLSearchParams(location.search);
      const filter = (q.get("quiz")||"all").toLowerCase();
      setFilter(filter);
    }

    document.addEventListener("DOMContentLoaded", initFromURL);
  </script>
</body>
</html>
