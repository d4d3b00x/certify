<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>JWT Lab ¬∑ ITHub.es</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{
      margin:0;padding:20px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#0b0f1e;color:#e8edff;
    }
    h1{margin-top:0}
    section{margin-bottom:24px;padding:12px 16px;border-radius:8px;background:#11162a;}
    h2{margin:0 0 8px;font-size:18px;}
    .small{font-size:13px;opacity:.85;}
    button{
      padding:8px 14px;
      border-radius:8px;
      border:1px solid #4650ff;
      background:#1a2140;
      color:#e8edff;
      cursor:pointer;
      margin:4px 4px 4px 0;
      font-size:14px;
    }
    button:hover{background:#252f5a;}
    label{font-size:13px;display:block;margin-top:4px;}
    input{
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #333a5a;
      background:#0b0f1e;
      color:#e8edff;
      font-size:13px;
      margin-right:6px;
    }
    code{background:#1a2140;padding:2px 4px;border-radius:4px;font-size:12px;}
    pre{
      background:#050814;
      padding:10px;
      border-radius:8px;
      font-size:12px;
      overflow:auto;
      max-height:260px;
      border:1px solid #202642;
    }
    .ok{color:#5af59b;}
    .err{color:#ff7b7b;}
    .pill{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      background:#202642;
      margin-left:6px;
      opacity:.9;
    }
    .status-pill{
      margin-left:8px;
      font-size:13px;
    }
    /* Tabla de auto-scan */
    table.scan {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:8px;
    }
    table.scan th, table.scan td{
      border:1px solid #202642;
      padding:4px 6px;
      text-align:left;
    }
    table.scan th{
      background:#151b33;
    }
  </style>
</head>
<body>
  <h1>JWT Lab ¬∑ ITHub.es</h1>
  <p class="small">
    Laboratorio para probar login con <b>AWS Cognito</b> y varias <b>APIs protegidas</b> con el mismo <code>id_token</code>.
  </p>

  <section id="step1"></section>
  <section id="step2"></section>
  <section id="step3"></section>

  <section>
    <h2>Log</h2>
    <pre id="log"></pre>
  </section>

<script>
/* ================== CONFIG ================== */

// Cognito (los mismos valores que en tu callback actual)
const COGNITO_DOMAIN = "https://eu-central-1iqmrkcwly.auth.eu-central-1.amazonaws.com";
const CLIENT_ID      = "592bh3ek4jdeg78qntt810g7vl";

// ESTA p√°gina como redirect_uri (debe estar en Allowed callback URLs)
const THIS_URL      = "https://www.ithub.es/login/jwt-lab.html";

// APIs que queremos probar
const API_LEADERBOARD       = "https://7p1wyrd7j7.execute-api.eu-central-1.amazonaws.com/manual/arena/leaderboard?limit=10";
const API_QUESTIONS_BASE    = "https://uougu1cm26.execute-api.eu-central-1.amazonaws.com/questions";
const API_PROGRESS          = "https://uougu1cm26.execute-api.eu-central-1.amazonaws.com/progress";
const API_PROGRESS_BY_USER  = "https://uougu1cm26.execute-api.eu-central-1.amazonaws.com/progress/by-user";
const API_RESULTS           = "https://uougu1cm26.execute-api.eu-central-1.amazonaws.com/results";

const logEl   = document.getElementById("log");
const step1El = document.getElementById("step1");
const step2El = document.getElementById("step2");
const step3El = document.getElementById("step3");

/* ================== UTILIDADES ================== */

function log(msg){
  console.log(msg);
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

function decodeJwt(token){
  try{
    const [h,p] = token.split(".");
    const header  = JSON.parse(atob(h.replace(/-/g, "+").replace(/_/g,"/")));
    const payload = JSON.parse(atob(p.replace(/-/g, "+").replace(/_/g,"/")));
    return {header, payload};
  }catch(e){
    return null;
  }
}

function buildLoginUrl(){
  const params = new URLSearchParams({
    client_id: CLIENT_ID,
    redirect_uri: THIS_URL,
    response_type: "code",
    scope: "email openid profile"
  });
  return `${COGNITO_DOMAIN}/login?${params.toString()}`;
}

async function exchangeCodeForTokens(code){
  const body = new URLSearchParams({
    grant_type: "authorization_code",
    client_id:  CLIENT_ID,
    code:       code,
    redirect_uri: THIS_URL
  });

  log("‚Üí POST /oauth2/token con code=" + code);

  const res = await fetch(`${COGNITO_DOMAIN}/oauth2/token`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body.toString()
  });

  const text = await res.text();
  log("‚Üê /oauth2/token status " + res.status);
  log(text);

  if (!res.ok) throw new Error("Fallo al intercambiar code: " + res.status);

  let data;
  try { data = JSON.parse(text); } catch(e){ throw new Error("Respuesta no JSON: " + text); }
  return data;
}

function getStoredToken(){
  const t = localStorage.getItem("arenaIdToken");
  if (!t) {
    alert("No hay id_token en localStorage. Haz login primero.");
    return null;
  }
  return t;
}

// Pinta el estado al lado del bot√≥n manual
function setStatus(elementId, status) {
  const el = document.getElementById(elementId);
  if (!el) return;

  if (status === "ok") {
    el.innerHTML = "üü¢ OK";
    el.style.color = "#5af59b";
  } else if (status === "ko") {
    el.innerHTML = "üî¥ KO";
    el.style.color = "#ff7b7b";
  } else {
    el.innerHTML = "";
  }
}

// Llamada manual desde bot√≥n (opcionalmente con token)
async function callApi(url, token, description, statusElementId){
  log(`‚Üí GET ${url} [${description}]` + (token ? " con Authorization: Bearer <token>" : " SIN Authorization"));

  try {
    const headers = token ? { "Authorization": "Bearer " + token } : {};
    const res = await fetch(url, { method: "GET", headers });
    const text = await res.text();

    log(`‚Üê ${description} status ${res.status}`);
    log(text);

    if (res.ok) {
      setStatus(statusElementId, "ok");
    } else {
      setStatus(statusElementId, "ko");
    }

  } catch (e) {
    log(`‚úñ Error llamando a ${description}: ${e.message}`);
    setStatus(statusElementId, "ko");
  }
}

/* ====== AUTO-SCAN DE RUTAS (tabla) ====== */

function runAutoScan(idToken){
  const autoDiv = document.createElement("div");
  autoDiv.innerHTML = `
    <h2>4Ô∏è‚É£ Estado de rutas</h2>
    <p class="small">
      Se prueba cada endpoint primero <b>sin token</b> y, si responde 401/403, tambi√©n <b>con token</b>.
      La conclusi√≥n (p√∫blica/protegida) es orientativa; el detalle exacto est√° en el log.
    </p>
    <table class="scan">
      <thead>
        <tr>
          <th>Ruta</th>
          <th>URL</th>
          <th>Sin token</th>
          <th>Con token</th>
          <th>Conclusi√≥n</th>
        </tr>
      </thead>
      <tbody id="scanBody">
      </tbody>
    </table>
  `;
  step3El.appendChild(autoDiv);

  const tbody = autoDiv.querySelector("#scanBody");

  const endpoints = [
    {
      id: "leaderboard",
      label: "/arena/leaderboard",
      url: "https://7p1wyrd7j7.execute-api.eu-central-1.amazonaws.com/manual/arena/leaderboard?limit=1"
    },
    {
      id: "questions",
      label: "/questions",
      url: `${API_QUESTIONS_BASE}?exam=SAA-C03-ES&limit=1`
    },
    {
      id: "progress",
      label: "/progress",
      url: `${API_PROGRESS}?sessionId=SCAN_TEST`
    },
    {
      id: "progressByUser",
      label: "/progress/by-user",
      url: `${API_PROGRESS_BY_USER}?userId=SCAN_USER&quizId=SCAN_QUIZ`
    },
    {
      id: "results",
      label: "/results",
      url: `${API_RESULTS}?quizId=SCAN_QUIZ&track=architect&mode=exam&limit=1`
    }
  ];

  // Crear filas iniciales
  for (const ep of endpoints){
    const tr = document.createElement("tr");
    tr.id = "scan-row-" + ep.id;
    tr.innerHTML = `
      <td>${ep.label}</td>
      <td><code>${ep.url}</code></td>
      <td id="scan-no-${ep.id}">‚Ä¶</td>
      <td id="scan-auth-${ep.id}">‚Äì</td>
      <td id="scan-res-${ep.id}">Comprobando‚Ä¶</td>
    `;
    tbody.appendChild(tr);
  }

  // Lanzar las pruebas secuencialmente
  (async () => {
    for (const ep of endpoints){
      await probeEndpoint(ep, idToken);
    }
  })();
}

async function probeEndpoint(ep, idToken){
  const cellNo   = document.getElementById("scan-no-" + ep.id);
  const cellAuth = document.getElementById("scan-auth-" + ep.id);
  const cellRes  = document.getElementById("scan-res-" + ep.id);

  let noStatus = null;
  let authStatus = null;

  // 1) SIN token
  try {
    log(`(SCAN) ‚Üí GET ${ep.url} [${ep.label}] SIN Authorization`);
    const res = await fetch(ep.url, { method:"GET" });
    noStatus = res.status;
    cellNo.textContent = res.status;
    const text = await res.text();
    log(`(SCAN) ‚Üê ${ep.label} SIN token status ${res.status}`);
    log(text);
  } catch (e){
    noStatus = 0;
    cellNo.textContent = "ERR";
    log(`(SCAN) ‚úñ Error SIN token en ${ep.label}: ${e.message}`);
  }

  // 2) Si responde 401/403, probamos CON token
  if (noStatus === 401 || noStatus === 403){
    if (idToken){
      try {
        log(`(SCAN) ‚Üí GET ${ep.url} [${ep.label}] con Authorization`);
        const res2 = await fetch(ep.url, {
          method:"GET",
          headers:{ "Authorization":"Bearer "+idToken }
        });
        authStatus = res2.status;
        cellAuth.textContent = res2.status;
        const text2 = await res2.text();
        log(`(SCAN) ‚Üê ${ep.label} CON token status ${res2.status}`);
        log(text2);
      } catch (e){
        authStatus = 0;
        cellAuth.textContent = "ERR";
        log(`(SCAN) ‚úñ Error CON token en ${ep.label}: ${e.message}`);
      }
    } else {
      cellAuth.textContent = "n/a";
    }
  } else {
    cellAuth.textContent = "n/a";
  }

  // 3) Conclusi√≥n
  let resultText = "";
  let color = "";

  if (noStatus === 401 || noStatus === 403){
    if (authStatus && authStatus >=200 && authStatus < 300){
      resultText = "‚úÖ Protegida (OK con token)";
      color = "#5af59b";
    } else if (authStatus === 0 || authStatus === null){
      resultText = "‚ö†Ô∏è Prob. protegida (401/403 sin token, error con token)";
      color = "#ffb15a";
    } else if (authStatus === 401 || authStatus === 403){
      resultText = "‚ö†Ô∏è Protegida pero KO incluso con token";
      color = "#ffb15a";
    } else {
      resultText = `‚ö†Ô∏è Protegida (sin token 401/403, con token ${authStatus})`;
      color = "#ffb15a";
    }
  } else if (noStatus === 0){
    resultText = "‚ùå Error de red / CORS (ver log)";
    color = "#ff7b7b";
  } else {
    resultText = "‚ùå P√∫blica (no exige token: sin token ‚â† 401/403)";
    color = "#ff7b7b";
  }

  cellRes.textContent = resultText;
  cellRes.style.color = color;
}

/* ================== RENDER AUTH ================== */

function renderStep1NoCode(){
  step1El.innerHTML = `
    <h2>1Ô∏è‚É£ Login en Cognito</h2>
    <p class="small">Pulsa el bot√≥n para ir al Hosted UI con <code>response_type=code</code>.</p>
  `;
  const btn = document.createElement("button");
  btn.textContent = "Ir a Cognito (authorization_code)";
  btn.onclick = () => {
    const url = buildLoginUrl();
    log("Redirigiendo a Cognito: " + url);
    window.location.href = url;
  };
  step1El.appendChild(btn);

  step2El.innerHTML = "";
  step3El.innerHTML = "";
}

async function renderWithCode(code){
  step1El.innerHTML = `
    <h2>1Ô∏è‚É£ Login completado</h2>
    <p class="small ok">Code recibido: <code>${code}</code></p>
  `;
  step2El.innerHTML = `<p class="small">2Ô∏è‚É£ Intercambiando <b>code</b> por tokens en <code>/oauth2/token</code>...</p>`;

  try {
    const tokens = await exchangeCodeForTokens(code);
    const idToken = tokens.id_token;
    if (!idToken) {
      step2El.innerHTML += `<p class="small err">No se encontr√≥ <code>id_token</code> en la respuesta.</p>`;
      return;
    }

    localStorage.setItem("arenaIdToken", idToken);

    const decoded = decodeJwt(idToken);
    const short = idToken.slice(0,40) + " ‚Ä¶ " + idToken.slice(-20);

    let html = `
      <h2>2Ô∏è‚É£ Tokens recibidos</h2>
      <p class="small ok">id_token guardado en <code>localStorage["arenaIdToken"]</code>:</p>
      <pre>${short}</pre>
    `;

    if (decoded){
      html += `
        <p class="small">Header decodificado:</p>
        <pre>${JSON.stringify(decoded.header, null, 2)}</pre>
        <p class="small">Payload decodificado:</p>
        <pre>${JSON.stringify(decoded.payload, null, 2)}</pre>
      `;
    }

    step2El.innerHTML = html;

    // 3Ô∏è‚É£ Botones manuales
    renderApiTests();

    // 4Ô∏è‚É£ Auto-scan en tabla
    runAutoScan(idToken);

  } catch(e){
    console.error(e);
    step2El.innerHTML += `<p class="small err">Error al intercambiar code: ${String(e)}</p>`;
  }
}

/* ================== RENDER PRUEBAS MANUALES ================== */

function renderApiTests(){
  step3El.innerHTML = `
    <h2>3Ô∏è‚É£ Pruebas de API protegida</h2>

    <div style="margin-bottom:16px;">
      <div><b>/arena/leaderboard</b><span class="pill">ranking</span></div>
      <button id="btnLeaderboard">Probar leaderboard</button>
      <span id="statusLeaderboard" class="status-pill"></span>
    </div>

    <div style="margin-bottom:16px;">
      <div><b>/questions</b><span class="pill">banco de preguntas</span></div>
      <label>Exam <input id="qExam" value="SAA-C03-ES" /></label>
      <label>Limit <input id="qLimit" value="10" type="number" min="1" max="200" /></label>
      <button id="btnQuestions">Probar /questions</button>
      <span id="statusQuestions" class="status-pill"></span>
    </div>

    <div style="margin-bottom:16px;">
      <div><b>/progress</b><span class="pill">GET por sessionId</span></div>
      <label>sessionId <input id="pSession" placeholder="SID-123..." /></label>
      <button id="btnProgress">Probar /progress?sessionId=...</button>
      <span id="statusProgress" class="status-pill"></span>
    </div>

    <div style="margin-bottom:16px;">
      <div><b>/progress/by-user</b><span class="pill">hist√≥rico usuario</span></div>
      <label>userId <input id="pUser" placeholder="userId..." /></label>
      <label>quizId <input id="pQuiz" placeholder="AZ-305-ES" /></label>
      <button id="btnProgressUser">Probar /progress/by-user</button>
      <span id="statusProgressUser" class="status-pill"></span>
    </div>

    <div style="margin-bottom:8px;">
      <div><b>/results</b><span class="pill">ranking bruto</span></div>
      <label>quizId <input id="rQuiz" placeholder="AZ-305-ES" /></label>
      <label>track <input id="rTrack" value="architect" /></label>
      <label>mode <input id="rMode" value="exam" /></label>
      <label>limit <input id="rLimit" type="number" value="50" /></label>
      <button id="btnResults">Probar /results</button>
      <span id="statusResults" class="status-pill"></span>
    </div>
  `;

  document.getElementById("btnLeaderboard").onclick = async () => {
    setStatus("statusLeaderboard", "");
    const token = getStoredToken();
    if (!token) return;
    await callApi(API_LEADERBOARD, token, "/arena/leaderboard", "statusLeaderboard");
  };

  document.getElementById("btnQuestions").onclick = async () => {
    setStatus("statusQuestions", "");
    // ahora mismo /questions est√° p√∫blica ‚Üí sin token
    const exam  = document.getElementById("qExam").value.trim();
    const limit = document.getElementById("qLimit").value || "10";
    const url   = `${API_QUESTIONS_BASE}?exam=${encodeURIComponent(exam)}&limit=${encodeURIComponent(limit)}`;
    await callApi(url, null, "/questions", "statusQuestions");
  };

  document.getElementById("btnProgress").onclick = async () => {
    setStatus("statusProgress", "");
    const token = getStoredToken();
    if (!token) return;
    const sid = document.getElementById("pSession").value.trim();
    if (!sid){ alert("Pon un sessionId"); return; }
    const url = `${API_PROGRESS}?sessionId=${encodeURIComponent(sid)}`;
    await callApi(url, token, "/progress", "statusProgress");
  };

  document.getElementById("btnProgressUser").onclick = async () => {
    setStatus("statusProgressUser", "");
    const token = getStoredToken();
    if (!token) return;
    const userId = document.getElementById("pUser").value.trim();
    const quizId = document.getElementById("pQuiz").value.trim();
    if (!userId || !quizId){ alert("Pon userId y quizId"); return; }
    const url = `${API_PROGRESS_BY_USER}?userId=${encodeURIComponent(userId)}&quizId=${encodeURIComponent(quizId)}`;
    await callApi(url, token, "/progress/by-user", "statusProgressUser");
  };

  document.getElementById("btnResults").onclick = async () => {
    setStatus("statusResults", "");
    const token = getStoredToken();
    if (!token) return;
    const quizId = document.getElementById("rQuiz").value.trim();
    const track  = document.getElementById("rTrack").value.trim();
    const mode   = document.getElementById("rMode").value.trim();
    const limit  = document.getElementById("rLimit").value || "50";

    const params = new URLSearchParams();
    if (quizId) params.set("quizId", quizId);
    if (track)  params.set("track", track);
    if (mode)   params.set("mode", mode);
    if (limit)  params.set("limit", limit);

    const url = `${API_RESULTS}?${params.toString()}`;
    await callApi(url, token, "/results", "statusResults");
  };
}

/* ================== INIT ================== */

(function init(){
  log("[JWT LAB] Inicio");
  const url  = new URL(window.location.href);
  const code = url.searchParams.get("code");

  if (!code) {
    log("No hay ?code= en la URL. Mostrando bot√≥n de login.");
    renderStep1NoCode();
  } else {
    log("Code encontrado en la URL: " + code);
    renderWithCode(code);
  }
})();
</script>
</body>
</html>
