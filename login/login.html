<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>CertiFY - Registro y Login</title>
<style>
body { font-family: sans-serif; max-width: 600px; margin: 40px auto; line-height: 1.6; }
form { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 10px; }
label { display: block; margin-top: 10px; }
input { width: 100%; padding: 8px; margin-top: 4px; }
button { padding: 8px 14px; margin-top: 10px; font-weight: bold; }
#authBar { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
#authBtns button { margin-left: 8px; }
.hidden { display: none; }
</style>
</head>
<body>

<!-- ====== BARRA SUPERIOR ====== -->
<section id="authBar">
  <span id="authText">ðŸ”’ No Authenticated :(</span>
  <div id="authBtns">
    <button id="btnLogin">Login</button>
    <button id="btnSignup">Register</button>
    <button id="btnLogout" class="hidden">Sign out</button>
  </div>
</section>

<!-- ====== FORMULARIO DE REGISTRO ====== -->
<form id="signupForm" class="hidden">
  <h3>Register new user:</h3>
  <label>Name: <input type="text" id="signupName" required></label>
  <label>Email: <input type="email" id="signupEmail" required></label>
  <label>Password: <input type="password" id="signupPass" required></label>
  <button type="submit">Certify!</button>
</form>

<!-- ====== FORMULARIO DE LOGIN ====== -->
<form id="loginForm" class="hidden">
  <h3>Login</h3>
  <label>Email: <input type="email" id="loginEmail" required></label>
  <label>Password: <input type="password" id="loginPass" required></label>
  <button type="submit">Certify!</button>
</form>

<script>
const API_URL = "https://uougu1cm26.execute-api.eu-central-1.amazonaws.com";

// ====== AUTH STORAGE ======
const AUTH_KEY = "currentUser";
function setCurrentUser(user) {
  localStorage.setItem(AUTH_KEY, JSON.stringify(user));
  renderAuthUI();
}
function getCurrentUser() {
  try { return JSON.parse(localStorage.getItem(AUTH_KEY) || "null"); }
  catch { return null; }
}
function clearCurrentUser() {
  localStorage.removeItem(AUTH_KEY);
  renderAuthUI();
}

// ====== RENDERIZAR UI ======
function renderAuthUI() {
  const u = getCurrentUser();
  const authText = document.getElementById("authText");
  const btnLogin = document.getElementById("btnLogin");
  const btnSignup = document.getElementById("btnSignup");
  const btnLogout = document.getElementById("btnLogout");
  const loginForm = document.getElementById("loginForm");
  const signupForm = document.getElementById("signupForm");

  if (u) {
    authText.textContent = `âœ… You are sign-in as: ${u.name} (${u.email})`;
    btnLogin.classList.add("hidden");
    btnSignup.classList.add("hidden");
    btnLogout.classList.remove("hidden");
    loginForm.classList.add("hidden");
    signupForm.classList.add("hidden");
  } else {
    authText.textContent = "ðŸ”’ No Authenticated :(";
    btnLogin.classList.remove("hidden");
    btnSignup.classList.remove("hidden");
    btnLogout.classList.add("hidden");
  }
}
document.addEventListener("DOMContentLoaded", () => {
  // Muestra el estado actual de autenticaciÃ³n al cargar
  renderAuthUI();

  // Mostrar formulario de registro si se pide por hash o query
  const isSignup =
    location.hash === "#signup" ||
    new URLSearchParams(location.search).get("view") === "signup";

  if (isSignup) {
    document.getElementById("signupForm")?.classList.remove("hidden");
    document.getElementById("loginForm")?.classList.add("hidden");
  }
});

// ====== BOTONES SUPERIORES ======
document.getElementById("btnLogout").onclick = () => {
  clearCurrentUser();
  alert("SesiÃ³n cerrada");
};

document.getElementById("btnLogin").onclick = () => {
  document.getElementById("loginForm").classList.toggle("hidden");
  document.getElementById("signupForm").classList.add("hidden");
};

document.getElementById("btnSignup").onclick = () => {
  document.getElementById("signupForm").classList.toggle("hidden");
  document.getElementById("loginForm").classList.add("hidden");
};

// ====== SIGNUP ======
document.getElementById("signupForm").addEventListener("submit", async e => {
  e.preventDefault();
  const name = signupName.value.trim();
  const email = signupEmail.value.trim().toLowerCase();
  const password = signupPass.value;
  const body = new URLSearchParams({ name, email, password });
  const resp = await fetch(`${API_URL}/signup`, { method: "POST", body, mode: "cors" });
  const data = await resp.json();
  if (resp.ok) {
    alert("Usuario creado con Ã©xito, ahora puedes iniciar sesiÃ³n");
    document.getElementById("signupForm").classList.add("hidden");
    document.getElementById("loginForm").classList.remove("hidden");
  } else {
    alert(data.error || "Error en el registro");
  }
});

// ====== LOGIN ======
document.getElementById("loginForm").addEventListener("submit", async e => {
  e.preventDefault();
  const email = loginEmail.value.trim().toLowerCase();
  const password = loginPass.value;
  const body = new URLSearchParams({ email, password });
  const resp = await fetch(`${API_URL}/login`, { method: "POST", body, mode: "cors" });
  const data = await resp.json();
  if (resp.ok) {
    setCurrentUser(data.user);
    alert("SesiÃ³n iniciada correctamente");
    window.location.href = "/";
  } else {
    alert(data.error || "Error de inicio de sesiÃ³n");
  }
});
</script>
</body>
</html>
