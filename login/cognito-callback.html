<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Procesando inicio de sesión...</title>
  <meta name="robots" content="noindex,nofollow" />
</head>

<body style="font-family: Arial, sans-serif; background:#0f1320; color:#e8ecff; padding:32px;">

  <h1>Procesando tu inicio de sesión segura....</h1>
  <p id="msg">Validando con AWS Cognito....</p>

  <pre id="debug" style="background:#161b2d; color:#9ca8d9; padding:12px; border-radius:8px; font-size:12px; overflow:auto; max-height:240px;"></pre>

  <script>
    const COGNITO_DOMAIN = "https://eu-central-1iqmrkcwly.auth.eu-central-1.amazoncognito.com";
    const CLIENT_ID      = "592bh3ek4jdeg78qntt810g7vl";
    const REDIRECT_URI   = "https://www.ithub.es/login/cognito-callback.html";

    const msgEl   = document.getElementById("msg");
    const debugEl = document.getElementById("debug");

    function setMsg(t){ msgEl.textContent = t; }

    function logDebug(obj){
      if (!obj) return;
      try { debugEl.textContent = JSON.stringify(obj, null, 2); }
      catch { debugEl.textContent = String(obj); }
    }

    function decodeJwtPayload(token){
      try {
        const payload = token.split(".")[1];
        const txt = atob(payload.replace(/-/g,"+").replace(/_/g,"/"));
        return JSON.parse(txt);
      } catch(e) {
        logDebug({ step:"decodeJwtPayload", error:String(e) });
        return null;
      }
    }

    async function main(){
      try{
        const params = new URLSearchParams(window.location.search);
        const code   = params.get("code");
        const error  = params.get("error");

        if (error) return fail("Error devuelto por Cognito: "+error);

        if (!code) return fail("❌ No se recibió el código de autenticación.", {
          search: window.location.search
        });

        setMsg("Asegurando sesión...");

        let resp;
        try {
          resp = await fetch(COGNITO_DOMAIN + "/oauth2/token", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
              grant_type: "authorization_code",
              client_id:  CLIENT_ID,
              code,
              redirect_uri: REDIRECT_URI
            })
          });
        } catch(e){
          return fail("Error de red al llamar a /oauth2/token", { error:String(e) });
        }

        if (!resp.ok){
          const text = await resp.text().catch(()=>"(sin cuerpo)");
          return fail("Error al obtener tokens", {
            status: resp.status,
            body:   text
          });
        }

        const tokens  = await resp.json();
        const payload = decodeJwtPayload(tokens.id_token);

        if (!payload) return fail("Error leyendo el ID Token");

        const user = {
          id:    payload.sub,
          email: payload.email,
          name:  payload.preferred_username ??
                 payload.name ??
                 (payload.email ? payload.email.split("@")[0] : "USER")
        };

        localStorage.setItem("currentUser", JSON.stringify(user));

     
        if (tokens.id_token){
          localStorage.setItem("arenaIdToken", tokens.id_token);
        }

        setMsg("Inicio de sesión correcto. Redirigiendo a ITHub.es....");
        
        window.location.replace("/");
      }catch(e){
        fail("Excepción no controlada en el callback", { error:String(e) });
      }
    }

    function fail(msg, dbg){
      setMsg(msg);
      logDebug(dbg);
    }

    main();
  </script>
</body>
</html>
