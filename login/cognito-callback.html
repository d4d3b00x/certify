<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Procesando inicio de sesión...</title>
  <meta name="robots" content="noindex,nofollow" />
</head>

<body style="font-family: Arial, sans-serif; background:#0f1320; color:#e8ecff; padding:32px;">

  
  <h1>Procesando tu inicio de sesión segura...</h1>
  <p id="msg">Validando con AWS Cognito...</p>

  <pre id="debug" style="background:#161b2d; color:#9ca8d9; padding:12px; border-radius:8px; font-size:12px; overflow:auto; max-height:240px;"></pre>

  <script>
    const COGNITO_DOMAIN = "https://eu-central-1iqmrkcwly.auth.eu-central-1.amazoncognito.com";
    const CLIENT_ID      = "592bh3ek4jdeg78qntt810g7vl";
    const REDIRECT_URI   = "https://www.ithub.es/login/cognito-callback.html";

    const msgEl   = document.getElementById("msg");
    const debugEl = document.getElementById("debug");

    function setMsg(t){ msgEl.textContent = t; }

    function decodeJwtPayload(token){
      try {
        const payload = token.split(".")[1];
        const txt = atob(payload.replace(/-/g,"+").replace(/_/g,"/"));
        return JSON.parse(txt);
      } catch {
        return null;
      }
    }

    async function main(){
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      const error = params.get("error");

      if (error) return fail("Error: "+error);

      if (!code) return fail("❌ No se recibió el código de autenticación.");

      setMsg("Intercambiando código por tokens...");

      const resp = await fetch(COGNITO_DOMAIN + "/oauth2/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          grant_type: "authorization_code",
          client_id: CLIENT_ID,
          code,
          redirect_uri: REDIRECT_URI
        })
      });

      if (!resp.ok){
        return fail("Error al obtener tokens", {
          status: resp.status, text: await resp.text()
        });
      }

      const tokens = await resp.json();
      const payload = decodeJwtPayload(tokens.id_token);

      if (!payload) return fail("Error leyendo el ID Token");

      const user = {
        id: payload.sub,
        email: payload.email,
        name:
          payload.preferred_username ??
          payload.name ??
          payload.email.split("@")[0]
      };

      localStorage.setItem("currentUser", JSON.stringify(user));

      //setMsg("Inicio de sesión correcto. Redirigiendo...");
      //setTimeout(()=> window.location.href="/", 1000);
    }

    function fail(msg, dbg){
      setMsg(msg);
      debugEl.textContent = JSON.stringify(dbg, null, 2);
    }

    main();
  </script>
</body>
</html>
