<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Procesando inicio de sesi√≥n...</title>
  <meta name="robots" content="noindex,nofollow" />
</head>

<body style="font-family: Arial, sans-serif; background:#0f1320; color:#e8ecff; padding:32px;">
  <h1>Procesando tu inicio de sesi√≥n...</h1>
  <p id="msg">Un momento, estamos validando tus credenciales con Amazon Cognito.</p>

  <pre id="debug" style="background:#161b2d; color:#9ca8d9; padding:12px; border-radius:8px; font-size:12px; overflow:auto; max-height:240px;"></pre>

  <script>
    /* ============================================================
       CONFIG COGNITO
    ============================================================ */
    const COGNITO_DOMAIN = "https://eu-central-1iqmrkcwly.auth.eu-central-1.amazoncognito.com";
    const CLIENT_ID      = "592bh3ek4jdeg78qntt810g7vl"; // üëà MISMO ID QUE EN login-cog.html
    const REDIRECT_URI   = "https://main.drlgxq3ev7tby.amplifyapp.com/login/cognito-callback.html";

    const msgEl   = document.getElementById("msg");
    const debugEl = document.getElementById("debug");

    function setMsg(text) { msgEl.textContent = text; }
    function logDebug(obj) {
      try { debugEl.textContent = JSON.stringify(obj, null, 2); }
      catch { debugEl.textContent = String(obj); }
    }

    /* ============================================================
       DECODIFICAR ID TOKEN (JWT)
    ============================================================ */
    function decodeJwtPayload(token) {
      try {
        const payload = token.split(".")[1];
        const base64 = payload.replace(/-/g, "+").replace(/_/g, "/");
        const padded = base64 + "=".repeat((4 - base64.length % 4) % 4);
        const json = atob(padded);
        return JSON.parse(json);
      } catch (e) {
        console.error("Error decodificando JWT:", e);
        return null;
      }
    }

    /* ============================================================
       MAIN FLOW: Intercambio de c√≥digo por tokens
    ============================================================ */
    async function main() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      const error = params.get("error");

      if (error) {
        return fail("‚ùå Error de login: " + error, { error });
      }

      if (!code) {
        return fail("‚ùå No se recibi√≥ ning√∫n c√≥digo de autenticaci√≥n.", {
          query: window.location.search
        });
      }

      setMsg("Intercambiando el c√≥digo por tokens seguros...");

      try {
        const body = new URLSearchParams({
          grant_type: "authorization_code",
          client_id:  CLIENT_ID,
          code,
          redirect_uri: REDIRECT_URI
        });

        const resp = await fetch(`${COGNITO_DOMAIN}/oauth2/token`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });

        if (!resp.ok) {
          const text = await resp.text();
          return fail("‚ùå Error al obtener los tokens de Cognito.", {
            status: resp.status,
            body: text
          });
        }

        const tokens = await resp.json();

        /* ------------------------------------------------------------
           1) Procesar ID Token ‚Üí Informaci√≥n del usuario
        ------------------------------------------------------------ */
        const payload = decodeJwtPayload(tokens.id_token);
        if (!payload) {
          return fail("‚ùå Error leyendo el token recibido desde Cognito.");
        }

        const cognitoUser = {
          sub: payload.sub,
          email: payload.email,
          username: payload["cognito:username"],
          preferred_username: payload["preferred_username"],
          name: payload["name"],
          email_verified: payload.email_verified
        };

        sessionStorage.setItem("cognitoUser", JSON.stringify(cognitoUser));

        /* ------------------------------------------------------------
           2) Transformamos el usuario al formato que usa ITHub.es
              - id    ‚Üí sub de Cognito
              - name  ‚Üí preferred_username / name / email prefix / username
        ------------------------------------------------------------ */
        const displayName =
          cognitoUser.preferred_username ||
          cognitoUser.name ||
          (cognitoUser.email && cognitoUser.email.split("@")[0]) ||
          cognitoUser.username ||
          "USER";

        const ithUser = {
          id:    cognitoUser.sub,
          email: cognitoUser.email,
          name:  displayName
        };

        try {
          localStorage.setItem("currentUser", JSON.stringify(ithUser));
        } catch (e) {
          console.warn("‚ö†Ô∏è No se pudo guardar currentUser:", e);
        }

        logDebug({
          tokens,
          payload,
          cognitoUser,
          ithUser
        });

        /* ------------------------------------------------------------
           3) Login OK ‚Üí Redirigir a inicio
        ------------------------------------------------------------ */
        setMsg("‚úÖ Login correcto. Redirigiendo...");
        setTimeout(() => { window.location.href = "/"; }, 800);

      } catch (e) {
        return fail("‚ùå Error inesperado procesando el inicio de sesi√≥n.", {
          exception: String(e)
        });
      }
    }

    /* ============================================================
       ERROR HANDLER
    ============================================================ */
    function fail(message, debugInfo) {
      setMsg(message);
      logDebug(debugInfo);
    }

    main();
  </script>
</body>
</html>
